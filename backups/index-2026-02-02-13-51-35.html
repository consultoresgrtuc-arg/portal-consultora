<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="w5nj0ZdDrZLgSIAVxPm1okEGFCPqCK5PAQEWzqmH908" />
    <title>G&R Consultores</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2936/2936733.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        // Esta configuración manual evita que Babel intente adivinar el entorno y falle
        Babel.registerPreset("env", {
            presets: [
                ["env", { "modules": false }]
            ]
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAK3yU78pfmNFAVBojOC7takuDg2NS3i6M",
            authDomain: "gyrconsultores-82422.firebaseapp.com",
            projectId: "gyrconsultores-82422",
            storageBucket: "gyrconsultores-82422.firebasestorage.app",
            messagingSenderId: "963315189373",
            appId: "1:963315189373:web:b5f02184412b2e78275314"
        };
        window.firebaseConfig = firebaseConfig;
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Ocultar la barra de scroll en el carrusel */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* --- ESTILOS DE BOTONES PARA MODALES --- */
        .btn-primary {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
        .btn-primary:disabled {
            background-color: #9ca3af; /* bg-gray-400 */
        }

        .btn-primary-green {
            background-color: #16a34a; /* bg-green-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
        }
        .btn-primary-green:hover {
            background-color: #15803d; /* bg-green-700 */
        }
        .btn-primary-green:disabled {
            background-color: #9ca3af; /* bg-gray-400 */
        }

        .btn-secondary {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #1f2937; /* text-gray-800 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none !important;
            }
            main {
                padding: 0;
                overflow: visible;
            }
            .print-container {
                box-shadow: none;
                border: 1px solid #e5e7eb;
                margin: 0;
            }
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            addDoc,
            query,
            getDocs,
            updateDoc,
            orderBy,
            limit,
            deleteDoc,
            where,
            Timestamp,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            listAll,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app-check.js";
        const { useState, useEffect, createContext, useContext, useCallback, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // --- VARIABLES GLOBALES DE FIREBASE ---
        let app, auth, db, storage, googleProvider, functions;
        // --- INICIALIZACIÓN DE FIREBASE ---
        const initFirebase = () => {
          try {
            app = initializeApp(window.firebaseConfig);
                  // --- INICIALIZAR APP CHECK (PASO 2) ---
try {
  // Inicializa App Check
  const appCheck = initializeAppCheck(app, {
    // Usa el proveedor reCAPTCHA v3 y TU CLAVE DEL SITIO
    provider: new ReCaptchaV3Provider('6LfC6wQsAAAAAOHfrlMZPGaVHx057A0xGCrnc4C8'),

    // Importante: Refresca el token automáticamente
    isTokenAutoRefreshEnabled: true
  });
  console.log('App Check inicializado correctamente.');
} catch (err) {
  console.error('Error al inicializar App Check:', err);
}
// --- Fin del bloque de App Check ---
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app); // <-- Ver nota abajo
            googleProvider = new GoogleAuthProvider();
            functions = getFunctions(app); // <--- AÑADIR ESTA LÍNEA
          } catch (error) {
            console.error("Error crítico al inicializar Firebase:", error);
            // Aquí podrías intentar mostrar un error en la UI si falla
          }
        };
        initFirebase();
        // --- CONTEXTOS ---
        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState(null);
    const [loading, setLoading] = useState(true);
    
    // --- NUEVOS ESTADOS PARA NOTIFICACIONES GLOBALES ---
    const [notifications, setNotifications] = useState([]);
    const [loadingNotifications, setLoadingNotifications] = useState(true);

    // Efecto principal para cargar perfil (sin cambios)
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
            if (firebaseUser) {
                setUser(firebaseUser);
                const userDocRef = doc(db, "users", firebaseUser.uid);
                const unsubProfile = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        setUserData(doc.data());
                    } else {
                        const newUserProfile = {
                            email: firebaseUser.email,
                            nombre: firebaseUser.displayName || '',
                            cuit: '',
                            actividad: '',
                            categoriaTributaria: 'Monotributo',
                            telefono: firebaseUser.phoneNumber || '',
                            isAdmin: false,
                            incomeGoal: 500000,
                            expenseBudget: 200000
                        };
                        setDoc(userDocRef, newUserProfile);
                        setUserData(newUserProfile);
                    }
                    setLoading(false);
                });
                return () => unsubProfile();
            } else {
                setUser(null);
                setUserData(null);
                setLoading(false);
                // Limpiamos notificaciones al cerrar sesión
                setNotifications([]);
                setLoadingNotifications(true);
            }
        });
        return () => unsubscribe();
    }, []);

    // --- NUEVO EFECTO PARA CARGAR SOLO NOTIFICACIONES DE DOCUMENTOS ---
    useEffect(() => {
        if (user) {
            setLoadingNotifications(true);
            
            // 1. Preparamos el listener para notificaciones de documentos
            const q = query(
                collection(db, 'users', user.uid, 'notifications'),
                orderBy("timestamp", "desc"),
                limit(5) // Traemos las 5 notificaciones de documentos más nuevas
            );
            
            const unsubscribeNotifs = onSnapshot(q, (snapshot) => {
                const docNotifs = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // Aseguramos que el timestamp sea un objeto Date para ordenar
                    timestamp: doc.data().timestamp.toDate() 
                }));
                
                setNotifications(docNotifs);
                setLoadingNotifications(false);
            });

            return () => unsubscribeNotifs();
            
        }
    }, [user]); // Se re-ejecuta si el usuario cambia

    // --- PASAMOS LOS NUEVOS ESTADOS AL CONTEXTO ---
    const value = { user, userData, loading, notifications, loadingNotifications };
    
    return <AuthContext.Provider value={value}>{!loading && children}</AuthContext.Provider>;
};
        
        const useAuth = () => useContext(AuthContext);
        
        // --- CUSTOM HOOK PARA COLECCIONES ---
        const useCollection = (collectionName, filters) => {
            const { user } = useAuth();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user || !filters?.year || !filters?.month) {
                    setData([]);
                    setLoading(false);
                    return;
                }
                setLoading(true);

                const constraints = [
                    where("year", "==", filters.year),
                    where("month", "==", filters.month),
                    orderBy("fechaEmision", "desc")
                ];
                
                const q = query(collection(db, 'users', user.uid, collectionName), ...constraints);
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, collectionName, filters?.year, filters?.month]);

            return { data, loading };
        };

        const useYearlyCollection = (collectionName, year) => {
            const { user } = useAuth();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user || !year) {
                    setData([]);
                    setLoading(false);
                    return;
                }
                setLoading(true);

                const q = query(collection(db, 'users', user.uid, collectionName), where("year", "==", year), orderBy("fechaEmision", "asc"));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching yearly ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, collectionName, year]);

            return { data, loading };
        };

        const useSimpleCollection = (collectionName) => {
            const { user } = useAuth();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) {
                    setData([]);
                    setLoading(false);
                    return;
                }
                setLoading(true);
                const q = query(collection(db, 'users', user.uid, collectionName), orderBy("fechaEmision", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching simple ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, collectionName]);
            return { data, loading };
        };


        // --- ÍCONOS INTEGRADOS ---
        const Icons = {
            ClipboardList: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>),
            Landmark: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="22" x2="21" y2="22"></line><line x1="6" y1="18" x2="6" y2="11"></line><line x1="10" y1="18" x2="10" y2="11"></line><line x1="14" y1="18" x2="14" y2="11"></line><line x1="18" y1="18" x2="18" y2="11"></line><polygon points="12 2 20 7 4 7"></polygon></svg>),
            CreditCard: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>),
            Wallet: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"></path></svg>),
            Sparkles: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L14.39 8.36L21 9.61L16.33 14.77L17.18 21.9L12 18.5L6.82 21.9L7.67 14.77L3 9.61L9.61 8.36L12 2z"/></svg>),
            BarChart3: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>),
            Chrome: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="21.17" y1="8" x2="12" y2="8"/><line x1="3.95" y1="6.06" x2="8.54" y2="14"/><line x1="10.88" y1="21.94" x2="15.46" y2="14"/></svg>),
            MessageCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>),
            LayoutDashboard: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="3" y="15" width="7" height="5"/><rect x="14" y="11" width="7" height="9"/></svg>),
            PlusCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>),
            TrendingUp: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>),
            FolderArchive: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>),
            Folder: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>),
            User: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>),
            Users: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>),
            Shield: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>),
            LogOut: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>),
            Menu: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>),
            TrendingDown: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>),
            DollarSign: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>),
            Calendar: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>),
            File: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>),
            Download: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>),
            AlertTriangle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>),
            CheckCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>),
            Edit: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>),
            Trash2: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>),
            ArrowLeft: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>),
            ArrowUpRight: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>),
            ArrowDownRight: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="7" y1="7" x2="17" y2="17"></line><polyline points="17 7 17 17 7 17"></polyline></svg>),
        };

        const Icon = ({ name, ...props }) => {
            const IconComponent = Icons[name];
            return IconComponent ? <IconComponent {...props} /> : <svg {...props} />;
        };
        
        // --- COMPONENTE CONFIRMMODAL MEJORADO (Dinámico) ---
        const ConfirmModal = ({ message, onConfirm, onCancel, confirmText = 'Confirmar', isDestructive = false }) => {
            return (
                <div className="modal-overlay">
                    <div className="modal-content text-center">
                        <Icon name="AlertTriangle" className={`mx-auto h-12 w-12 mb-4 ${isDestructive ? 'text-red-500' : 'text-yellow-500'}`}/>
                        <h3 className="text-lg font-medium text-gray-900 mb-4">{message}</h3>
                        <div className="flex justify-center gap-4">
                            <button onClick={onCancel} className="py-2 px-4 bg-gray-200 rounded-md hover:bg-gray-300 font-medium">
                                Cancelar
                            </button>
                            <button 
                                onClick={onConfirm} 
                                className={`py-2 px-4 text-white rounded-md font-bold ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}
                            >
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const DateFilter = ({ date, setDate }) => {
            const years = Array.from({ length: 10 }, (_, i) => new Date().getFullYear() - i);
            const months = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];

            const handleYearChange = (e) => {
                const newYear = parseInt(e.target.value);
                const newDate = new Date(date);
                newDate.setFullYear(newYear);
                setDate(newDate);
            };

            const handleMonthChange = (e) => {
                const newMonth = parseInt(e.target.value);
                const newDate = new Date(date);
                newDate.setMonth(newMonth);
                setDate(newDate);
            };

            return (
                <div className="flex items-center gap-4 mb-6 bg-white p-4 rounded-lg shadow-sm">
                    <h3 className="text-lg font-semibold">Consultar Período:</h3>
                    <select value={date.getMonth()} onChange={handleMonthChange} className="p-2 border rounded-md">
                        {months.map((month, index) => (
                            <option key={index} value={index}>{month}</option>
                        ))}
                    </select>
                    <select value={date.getFullYear()} onChange={handleYearChange} className="p-2 border rounded-md">
                        {years.map(year => (
                            <option key={year} value={year}>{year}</option>
                        ))}
                    </select>
                </div>
            );
        };

        // --- PÁGINA DE LOGIN (V2.0 - PREMIUM) ---
        const LoginPage = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [view, setView] = useState('login'); // 'login', 'register', 'reset'
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');
            
            const handleEmailPassword = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                try {
                    if (view === 'register') {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let friendlyMessage = 'Error al autenticar.';
                    if (err.code === 'auth/email-already-in-use') friendlyMessage = 'Este email ya está registrado. Intenta iniciar sesión.';
                    else if (err.code === 'auth/weak-password') friendlyMessage = 'La contraseña debe tener al menos 6 caracteres.';
                    else if (err.code === 'auth/invalid-email') friendlyMessage = 'El formato del email no es válido.';
                    else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') friendlyMessage = 'Email o contraseña incorrectos.';
                    setError(friendlyMessage);
                }
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                try {
                    await sendPasswordResetEmail(auth, email);
                    setMessage('Correo de recuperación enviado. Revisa tu bandeja de entrada.');
                } catch (err) {
                    setError('No se pudo enviar el correo. Verifica que el email sea correcto.');
                }
            };
            
            const handleGoogleLogin = async () => {
                setError('');
                try {
                    await signInWithPopup(auth, googleProvider);
                } catch (err) {
                    setError('Error al iniciar sesión con Google.');
                }
            };

            const switchView = (newView) => {
                setView(newView);
                setError('');
                setMessage('');
            };

            return (
                 <div className="min-h-screen flex items-center justify-center bg-gray-100">
                     <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                         <div className="text-center mb-8">
                             <Icon name="BarChart3" className="mx-auto h-12 w-12 text-blue-600"/>
                             <h2 className="mt-4 text-3xl font-bold text-gray-900">
                                 {view === 'login' && 'Iniciar Sesión'}
                                 {view === 'register' && 'Crear una cuenta'}
                                 {view === 'reset' && 'Recuperar Contraseña'}
                             </h2>
                             {/* --- TEXTO BIENVENIDA ACTUALIZADO --- */}
                             <p className="mt-2 text-sm text-gray-600">
                                 {view === 'reset' ? 'Ingresa tu email para recibir un enlace de recuperación.' : 'Bienvenido a tu Portal de Gestión Financiera Contable.'}
                             </p>
                         </div>

                         {view === 'reset' ? (
                             <form onSubmit={handlePasswordReset} className="space-y-6">
                                 <div><label className="text-sm font-medium text-gray-700">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/></div>
                                 {error && <p className="text-sm text-red-600">{error}</p>}
                                 {message && <p className="text-sm text-green-600">{message}</p>}
                                 <div><button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Enviar correo</button></div>
                             </form>
                         ) : (
                             <form onSubmit={handleEmailPassword} className="space-y-6">
                                 <div><label className="text-sm font-medium text-gray-700">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/></div>
                                 <div><label className="text-sm font-medium text-gray-700">Contraseña</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/></div>
                                 {view === 'login' && <div className="text-right text-sm"><a href="#" onClick={(e) => { e.preventDefault(); switchView('reset'); }} className="font-medium text-blue-600 hover:text-blue-500">¿Olvidaste tu contraseña?</a></div>}
                                 {error && <p className="text-sm text-red-600">{error}</p>}
                                 <div><button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">{view === 'register' ? 'Registrarse' : 'Ingresar'}</button></div>
                             </form>
                         )}
                        
                         {view !== 'reset' && (
                             <div className="mt-6"><div className="relative"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">O continuar con</span></div></div>
                                 <div className="mt-6 grid grid-cols-1 gap-3">
                                     <button onClick={handleGoogleLogin} className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"><Icon name="Chrome" className="w-5 h-5 mr-2" />Google</button>
                                     <button disabled className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 opacity-50 cursor-not-allowed" title="Próximamente"><Icon name="MessageCircle" className="w-5 h-5 mr-2" />WhatsApp Business</button>
                                 </div>
                             </div>
                         )}
                         <div className="text-center mt-4 text-sm">
                             {view === 'login' && <a href="#" onClick={(e) => { e.preventDefault(); switchView('register'); }} className="font-medium text-blue-600 hover:text-blue-500">¿No tienes cuenta? Regístrate</a>}
                             {view === 'register' && <a href="#" onClick={(e) => { e.preventDefault(); switchView('login'); }} className="font-medium text-blue-600 hover:text-blue-500">¿Ya tienes cuenta? Inicia sesión</a>}
                             {view === 'reset' && <a href="#" onClick={(e) => { e.preventDefault(); switchView('login'); }} className="font-medium text-blue-600 hover:text-blue-500">Volver a Iniciar Sesión</a>}
                         </div>

                         {/* --- SELLO DE SEGURIDAD V2.0 --- */}
                         <div className="text-center mt-8 pt-4 border-t border-gray-100">
                            <p className="text-xs text-gray-400 font-medium flex items-center justify-center">
                                <Icon name="Shield" className="w-3 h-3 mr-1"/>
                                G&R System v2.0 • Seguridad Verificada
                            </p>
                         </div>
                     </div>
                 </div>
            );
        };
        // --- NUEVO HOOK DE INACTIVIDAD (pegar antes de AppLayout) ---
const useInactivityTimer = ({ onTimeout, timeout = 3600000, warningTime = 60000 }) => {
    const [showWarning, setShowWarning] = React.useState(false);
    const [countdown, setCountdown] = React.useState(warningTime / 1000);
    
    const timerId = React.useRef();
    const warningTimerId = React.useRef();
    const countdownIntervalId = React.useRef();

    const handleTimeout = () => {
        onTimeout();
    };

    const handleShowWarning = () => {
        setShowWarning(true);
        // Iniciar cuenta regresiva para el modal
        setCountdown(warningTime / 1000);
        countdownIntervalId.current = setInterval(() => {
            setCountdown(prev => {
                if (prev <= 1) {
                    clearInterval(countdownIntervalId.current);
                    return 0;
                }
                return prev - 1;
            });
        }, 1000);
    };

    const resetTimer = () => {
        // Limpiar todos los temporizadores
        if (timerId.current) clearTimeout(timerId.current);
        if (warningTimerId.current) clearTimeout(warningTimerId.current);
        if (countdownIntervalId.current) clearInterval(countdownIntervalId.current);
        
        setShowWarning(false);
        setCountdown(warningTime / 1000);

        // Iniciar temporizador de advertencia (1 hora - 1 minuto)
        warningTimerId.current = setTimeout(handleShowWarning, timeout - warningTime);
        
        // Iniciar temporizador de cierre de sesión (1 hora)
        timerId.current = setTimeout(handleTimeout, timeout);
    };

    const keepActive = () => {
        resetTimer();
    };

    // Iniciar el temporizador al montar
    React.useEffect(() => {
        resetTimer();

        // Eventos que reinician el temporizador
        const events = ['mousedown', 'keypress', 'touchstart', 'scroll', 'click'];
        const eventListener = () => resetTimer();
        
        events.forEach(event => window.addEventListener(event, eventListener));

        // Limpieza al desmontar
        return () => {
            if (timerId.current) clearTimeout(timerId.current);
            if (warningTimerId.current) clearTimeout(warningTimerId.current);
            if (countdownIntervalId.current) clearInterval(countdownIntervalId.current);
            events.forEach(event => window.removeEventListener(event, eventListener));
        };
    }, [onTimeout, timeout, warningTime]);

    return { showWarning, keepActive, countdown };
};

// --- NUEVO MODAL DE ADVERTENCIA (pegar antes de AppLayout) ---
const InactivityWarningModal = ({ isOpen, onKeepActive, countdown }) => {
    if (!isOpen) return null;

    return (
        <div className="modal-overlay fade-in">
            <div className="modal-content slide-in-bottom sm:max-w-md">
                <div className="text-center">
                    <Icon name="AlertTriangle" className="w-16 h-16 text-yellow-500 mx-auto mb-4" />
                    <h3 className="text-2xl font-bold mb-3">¿Sigues ahí?</h3>
                    <p className="text-gray-600 mb-6">
                        Tu sesión está a punto de cerrarse por inactividad.
                        Cerrando sesión en... <span className="font-bold text-lg">{countdown}</span> segundos.
                    </p>
                    <button 
                        onClick={onKeepActive} 
                        className="btn-primary w-full"
                    >
                        Permanecer Activo
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- LAYOUT PRINCIPAL (CON DISEÑO GLASSMORPHISM) ---
const AppLayout = ({ children }) => {
    const [sidebarOpen, setSidebarOpen] = React.useState(false);
    
    // Traemos datos y navegación del contexto
    const { userData } = useAuth(); 
    // AGREGADO: Traemos 'route' para saber qué botón pintar de azul
    const { route, navigate } = React.useContext(AppContext); 
    
    // --- LÓGICA DE INACTIVIDAD ---
    const handleTimeout = () => {
        signOut(auth); 
    };

    const { showWarning, keepActive, countdown } = useInactivityTimer({
        onTimeout: handleTimeout,
        timeout: 3600000, 
        warningTime: 60000  
    });

    const navLinks = [
        { name: 'Dashboard', icon: 'LayoutDashboard', path: '/dashboard' },

        // Lógica Condicional: Se muestra SI es Admin O SI tiene servicioFacturacion: true
        ...((userData?.isAdmin || userData?.servicioFacturacion) ? [
            { name: 'Facturación', icon: 'File', path: '/billing-requests' }
        ] : []),
        
        { name: 'Operaciones', icon: 'PlusCircle', path: '/operations' },
        { name: 'Gestión', icon: 'ClipboardList', path: '/gestion'},
        { name: 'Finanzas', icon: 'TrendingUp', path: '/finances' },
        { name: 'Reportes', icon: 'BarChart3', path: '/reports' },
        { name: 'Cliente', icon: 'FolderArchive', path: '/client-center' },
        { name: 'Perfil', icon: 'User', path: '/profile' },
        ...(userData?.isAdmin ? [{ name: 'Admin', icon: 'Shield', path: '/admin' }] : [])
    ];
    
    const handleNavigate = (path) => {
        navigate(path);
        setSidebarOpen(false);
    };

    return (
        <div className="flex h-screen bg-gray-100 font-sans">
            {/* Modal de Inactividad */}
            <InactivityWarningModal 
                isOpen={showWarning} 
                onKeepActive={keepActive} 
                countdown={countdown} 
            />

            {/* --- OVERLAY MÓVIL (FONDO BORROSO) --- */}
            <div 
                className={`fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-40 transition-opacity duration-300 lg:hidden ${sidebarOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} 
                onClick={() => setSidebarOpen(false)}
            ></div>

            {/* --- SIDEBAR (BARRA LATERAL) --- */}
            <div className={`fixed inset-y-0 left-0 w-64 z-50 flex flex-col transition-transform duration-300 ease-out transform 
                ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} 
                lg:translate-x-0 lg:static lg:inset-0
                bg-gray-900/95 backdrop-blur-xl border-r border-white/10 shadow-2xl no-print`}
            >
                {/* Logo */}
                <div className="flex items-center justify-center h-20 border-b border-white/10 bg-gradient-to-b from-white/5 to-transparent">
                    <a href="#" onClick={() => handleNavigate('/dashboard')} className="flex items-center space-x-3 group">
                        <div className="bg-blue-600/20 p-2 rounded-lg group-hover:bg-blue-600/30 transition-colors">
                            <Icon name="BarChart3" className="w-8 h-8 text-blue-400"/>
                        </div>
                        <div>
                            <span className="block text-lg font-bold text-white tracking-tight leading-none">G&R</span>
                            <span className="text-[10px] text-gray-400 uppercase tracking-widest font-semibold">Consultores</span>
                        </div>
                    </a>
                </div>

                {/* Menú de Navegación */}
                <nav className="flex-1 px-3 py-6 space-y-1 overflow-y-auto custom-scrollbar">
                    {navLinks.map(link => {
                        const isActive = route === link.path;
                        return (
                            <a 
                                key={link.name} 
                                href="#" 
                                onClick={() => handleNavigate(link.path)} 
                                className={`group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 relative overflow-hidden
                                    ${isActive 
                                        ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' 
                                        : 'text-gray-400 hover:bg-white/5 hover:text-white'
                                    }`}
                            >
                                {/* Brillo sutil al hacer hover */}
                                {!isActive && <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>}
                                
                                <Icon 
                                    name={link.icon} 
                                    className={`mr-3 h-5 w-5 transition-transform duration-200 ${isActive ? 'text-white scale-110' : 'text-gray-500 group-hover:text-gray-300'}`}
                                />
                                {link.name}
                            </a>
                        );
                    })}
                </nav>
                
                {/* Footer del Sidebar */}
                <div className="p-4 border-t border-white/10 bg-black/20">
                    <button onClick={handleTimeout} className="w-full flex items-center justify-center px-4 py-2 text-xs font-bold text-gray-400 rounded-lg hover:bg-red-500/10 hover:text-red-400 transition-all border border-transparent hover:border-red-500/20 group">
                        <Icon name="LogOut" className="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform"/>
                        Cerrar Sesión
                    </button>
                    
                    <div className="mt-4 text-center">
                        <p className="text-[10px] text-gray-600 font-mono tracking-wider">v2.0.1 (Stable)</p>
                        <p className="text-[9px] text-blue-900/60 mt-1 uppercase font-bold tracking-widest flex items-center justify-center gap-1">
                            Powered by Gemini AI <Icon name="Sparkles" className="w-2 h-2"/>
                        </p>
                    </div>
                </div>
            </div>
            
            {/* Contenido Principal */}
            <div className="flex-1 flex flex-col overflow-hidden">
                <header className="flex justify-between items-center p-4 bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-10 no-print">
                    <button onClick={() => setSidebarOpen(!sidebarOpen)} className="text-gray-500 hover:text-gray-700 focus:outline-none lg:hidden p-2 rounded-md hover:bg-gray-100">
                        <Icon name="Menu" className="h-6 w-6"/>
                    </button>
                    <h1 className="text-xl md:text-2xl font-bold text-gray-800 truncate ml-2">
                        Bienvenido, <span className="text-blue-600">{userData?.nombre || 'Cliente'}</span>!
                    </h1>
                    <div className="w-8"></div> {/* Espaciador para centrar título en móvil si hiciera falta */}
                </header>
                
                <main className="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6 relative">
                    <div className="fade-in max-w-7xl mx-auto">
                        {children}
                    </div>
                </main>
            </div>
        </div>
    );
};
        // --- COMPONENTE DE IA ---
        const AIAnalyzer = () => {
            const [operations, setOperations] = useState([]);
            const { user } = useAuth();
            
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'users', user.uid, 'operations'), orderBy("fechaEmision", "desc"), limit(50));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setOperations(snapshot.docs.map(doc => doc.data()));
                });
                return () => unsubscribe();
            }, [user]);

            const [prompt, setPrompt] = useState('');
            const [result, setResult] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAnalysis = async () => {
                if (!prompt.trim()) {
                    setError('Por favor, escribe una pregunta.');
                    return;
                }
                 if (operations.length === 0) {
                    setError('No tienes operaciones registradas para analizar.');
                    return;
                }

                setLoading(true);
                setResult('');
                setError('');

                const apiUrl = 'https://us-central1-gyrconsultores-82422.cloudfunctions.net/secureGeminiCall';

                const operationsContext = operations.map(op => 
                    `- ${op.fechaEmision.toDate().toLocaleDateString('es-AR')}: ${op.type} de ${op.amount.toFixed(2)} ARS (${op.description})`
                ).join('\n');

                const systemPrompt = "Actúa como un asistente financiero experto y conciso. Analiza los datos de operaciones proporcionados y responde la pregunta del usuario en español. Basa tu respuesta únicamente en los datos. Si la pregunta no se puede responder con los datos, indícalo. Formatea tu respuesta de forma clara y amigable.";
                const fullPrompt = `Basado en las siguientes operaciones financieras:\n\n${operationsContext}\n\nPor favor, responde a la siguiente pregunta: "${prompt}"`;

                const payload = {
                    contents: [{ parts: [{ text: fullPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         const errorBody = await response.json();
                         console.error("Error response from backend:", errorBody);
                         throw new Error(`Error del servidor: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    const text = data.text;

                    if (text) {
                        setResult(text);
                    } else {
                        throw new Error("No se recibió una respuesta válida de la IA.");
                    }
                } catch (err) {
                    console.error("Error calling the secure backend:", err);
                    setError("Hubo un error al contactar al asistente de IA. Por favor, intenta de nuevo más tarde.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-xl font-bold mb-4 flex items-center">
                        <Icon name="Sparkles" className="w-6 h-6 mr-2 text-yellow-500" />
                        Análisis con IA
                    </h3>
                    <div className="space-y-4">
                        <textarea
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="Ej: ¿Cuál fue mi mayor gasto este mes? o Dame consejos para reducir mis compras."
                            className="w-full p-2 border rounded-md"
                            rows="3"
                        />
                        <button
                            onClick={handleAnalysis}
                            disabled={loading}
                            className="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                        >
                            {loading ? 'Analizando...' : 'Analizar mis Finanzas'}
                        </button>
                        {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                        {loading && <div className="text-center text-gray-500"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto"></div><p>El asistente está pensando...</p></div>}
                        {result && (
                            <div className="mt-4 p-4 bg-gray-50 rounded-lg border">
                                <p className="text-gray-800 whitespace-pre-wrap">{result}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PÁGINAS ---
        const DashboardPage = () => {
    const [operations, setOperations] = useState([]);
    const { user } = useAuth();
    
    useEffect(() => {
        if (!user) return;
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const q = query(
            collection(db, 'users', user.uid, 'operations'),
            where("year", "==", year),
            where("month", "==", month)
        );
        const unsubscribe = onSnapshot(q, (snapshot) => {
            setOperations(snapshot.docs.map(doc => doc.data()));
        });
        return () => unsubscribe();
    }, [user]);

    const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

    const metrics = useMemo(() => {
        let ventas = 0, compras = 0, ingresos = 0, gastos = 0;
        operations.forEach(op => {
            switch (op.type) {
                case 'venta': ventas += op.amount; break;
                case 'compra': compras += op.amount; break;
                case 'ingreso': ingresos += op.amount; break;
                case 'gasto': gastos += op.amount; break;
            }
        });

        const totalIncome = ventas + ingresos;
        const totalExpense = compras + gastos;
        const cashFlow = totalIncome - totalExpense;
        
        // --- CÁLCULOS FINANCIEROS PRECISOS ---
        const profitability = totalIncome > 0 ? (cashFlow / totalIncome) * 100 : 0;
        const expenseToIncomeRatio = ingresos > 0 ? (gastos / ingresos) * 100 : 0;
        const purchasesToSalesRatio = ventas > 0 ? (compras / ventas) * 100 : 0;

        return { ventas, compras, ingresos, gastos, totalIncome, totalExpense, cashFlow, profitability, expenseToIncomeRatio, purchasesToSalesRatio };
    }, [operations]);

    return (
        <div className="p-6 space-y-8 bg-gray-50 min-h-screen">
            <header>
                <h2 className="text-3xl font-extrabold text-gray-800 tracking-tight">Resumen Operativo</h2>
                <p className="text-gray-500 mt-1">Análisis financiero del período en curso.</p>
            </header>

            {/* --- SECCIÓN 1: TOTALES POR CATEGORÍA (Se mantiene text-3xl) --- */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ventas</h3>
                    <p className="text-3xl font-bold text-green-600">{formatCurrency(metrics.ventas)}</p>
                </div>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Compras</h3>
                    <p className="text-3xl font-bold text-red-600">{formatCurrency(metrics.compras)}</p>
                </div>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Otros Ingresos</h3>
                    <p className="text-3xl font-bold text-emerald-500">{formatCurrency(metrics.ingresos)}</p>
                </div>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Otros Gastos</h3>
                    <p className="text-3xl font-bold text-orange-600">{formatCurrency(metrics.gastos)}</p>
                </div>
            </div>
            
            {/* --- SECCIÓN 2: INDICADORES PRINCIPALES (Ajustado a text-4xl) --- */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Flujo de Caja */}
                <div className="bg-gradient-to-br from-white to-gray-50 p-8 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between min-h-[180px]">
                    <div>
                        <h3 className="text-lg font-bold text-gray-700 mb-1">Flujo de Caja Mensual</h3>
                        {/* CAMBIO: De text-5xl a text-4xl */}
                        <p className={`text-4xl font-black ${metrics.cashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {formatCurrency(metrics.cashFlow)}
                        </p>
                    </div>
                    <div className="flex items-center mt-6 text-gray-500 font-medium text-sm">
                        <div className={`p-2 rounded-full mr-3 ${metrics.cashFlow >= 0 ? 'bg-green-100' : 'bg-red-100'}`}>
                            {metrics.cashFlow >= 0 ? <Icon name="ArrowUpRight" className="w-5 h-5 text-green-600"/> : <Icon name="ArrowDownRight" className="w-5 h-5 text-red-600"/>}
                        </div>
                        Resultado neto (Ingresos - Egresos)
                    </div>
                </div>

                {/* Rentabilidad Neta */}
                <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-center text-center">
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Rentabilidad Neta</h3>
                    {/* CAMBIO: De text-6xl a text-4xl */}
                    <p className={`text-4xl font-black ${metrics.profitability >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                        {metrics.profitability.toFixed(1)}%
                    </p>
                    <p className="text-gray-400 mt-2 text-sm font-medium italic">Margen sobre ingresos totales</p>
                </div>
            </div>

            {/* --- SECCIÓN 3: COMPARATIVAS DE EFICIENCIA (Ajustado a text-4xl) --- */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {/* Eficiencia Estructural */}
                <div className="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-l-purple-500 border-gray-100 relative overflow-hidden">
                    <h3 className="text-gray-500 font-bold text-xs uppercase mb-1">Eficiencia Estructural</h3>
                    <h4 className="text-xl font-bold text-gray-800 mb-4">Gastos vs. Ingresos</h4>
                    {/* CAMBIO: De text-5xl a text-4xl */}
                    <p className="text-4xl font-black text-purple-600">{metrics.expenseToIncomeRatio.toFixed(1)}%</p>
                    <p className="text-gray-400 mt-2 text-sm">Incidencia de gastos sobre ingresos extra</p>
                </div>

                {/* Eficiencia Comercial */}
                <div className="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-l-orange-500 border-gray-100 relative overflow-hidden">
                    <h3 className="text-gray-500 font-bold text-xs uppercase mb-1">Eficiencia Comercial</h3>
                    <h4 className="text-xl font-bold text-gray-800 mb-4">Compras vs. Ventas</h4>
                    {/* CAMBIO: De text-5xl a text-4xl */}
                    <p className="text-4xl font-black text-orange-500">{metrics.purchasesToSalesRatio.toFixed(1)}%</p>
                    <p className="text-gray-400 mt-2 text-sm">Costo sobre volumen de ventas totales</p>
                </div>
            </div>

            <div className="pt-4">
                <AIAnalyzer />
            </div>
        </div>
    );
};
        
        const OperationsPage = () => {
    const { user } = useAuth();
    const [filterDate, setFilterDate] = useState(new Date());
    // Asumimos que useCollection es tu hook personalizado que ya funciona
    const { data: operations, loading } = useCollection('operations', {
        year: filterDate.getFullYear(),
        month: filterDate.getMonth() + 1
    });
    const [recentOperations, setRecentOperations] = useState([]);
    
    useEffect(() => {
        if (!user) return;
        const q = query(collection(db, 'users', user.uid, 'operations'), orderBy("fechaEmision", "desc"), limit(5));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            setRecentOperations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }, (error) => console.error("Error en recentOperations:", error));
        return () => unsubscribe();
    }, [user]);

    const [showModal, setShowModal] = useState(false);
    const [editingOp, setEditingOp] = useState(null);
    const [showConfirmDelete, setShowConfirmDelete] = useState(false);
    const [operationToDelete, setOperationToDelete] = useState(null);
    
    const handleDelete = async () => {
        if (!operationToDelete || !user) return;
        try {
            // CORRECCIÓN: Usamos 'user.uid' directamente
            await deleteDoc(doc(db, 'users', user.uid, 'operations', operationToDelete));
            setShowConfirmDelete(false);
            setOperationToDelete(null);
        } catch (error) {
            console.error("Error al eliminar:", error);
        }
    };

    const promptDelete = (id) => {
        setOperationToDelete(id);
        setShowConfirmDelete(true);
    };
    
    const handleEdit = (op) => {
        setEditingOp(op);
        setShowModal(true);
    };
    
    const handleNewOperation = () => {
        setEditingOp(null);
        setShowModal(true);
    };

    const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold">Operaciones</h2>
                <button onClick={handleNewOperation} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><Icon name="PlusCircle" className="w-5 h-5 mr-2"/>Nueva Operación</button>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 className="text-xl font-bold mb-4">Últimas Operaciones Agregadas</h3>
                {recentOperations.length > 0 ? (
                    <ul className="divide-y divide-gray-200">
                        {recentOperations.map(op => (
                            <li key={op.id} className="py-3 flex justify-between items-center">
                                <div>
                                    <p className="font-medium capitalize">{op.type}: {op.description}</p>
                                    <p className="text-sm text-gray-500">{op.fechaEmision?.toDate ? op.fechaEmision.toDate().toLocaleDateString('es-AR') : 'Fecha inválida'}</p>
                                </div>
                                <p className={`font-bold text-lg ${['venta','ingreso'].includes(op.type) ? 'text-green-600' : 'text-red-600'}`}>
                                    {formatCurrency(op.amount)}
                                </p>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <p className="text-gray-500 text-center">No hay operaciones recientes.</p>
                )}
            </div>

            {/* Asumimos que DateFilter y ConfirmModal ya están definidos en tu código */}
            <DateFilter date={filterDate} setDate={setFilterDate} />

            {showModal && <OperationModal op={editingOp} onClose={() => setShowModal(false)} />}
            {showConfirmDelete && (
                <ConfirmModal
                    message="¿Estás seguro de que quieres eliminar esta operación?"
                    onConfirm={handleDelete}
                    onCancel={() => setShowConfirmDelete(false)}
                />
            )}

            <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                <h3 className="text-xl font-bold mb-4">Operaciones del Período</h3>
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50"><tr>
                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Fecha</th>
                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th>
                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Descripción</th>
                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Monto</th>
                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Acciones</th>
                    </tr></thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {loading ? (<tr><td colSpan="5" className="text-center py-10">Cargando...</td></tr>) : 
                        operations.length > 0 ? operations.map(op => (
                            <tr key={op.id}>
                                <td className="px-6 py-4 whitespace-nowrap">{op.fechaEmision?.toDate ? op.fechaEmision.toDate().toLocaleDateString('es-AR') : '-'}</td>
                                <td className="px-6 py-4 whitespace-nowrap capitalize">{op.type}</td>
                                <td className="px-6 py-4">{op.description}</td>
                                <td className={`px-6 py-4 whitespace-nowrap font-semibold ${['venta','ingreso'].includes(op.type) ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(op.amount)}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onClick={() => handleEdit(op)} className="text-indigo-600 hover:text-indigo-900 mr-4"><Icon name="Edit" className="w-5 h-5"/></button>
                                    <button onClick={() => promptDelete(op.id)} className="text-red-600 hover:text-red-900"><Icon name="Trash2" className="w-5 h-5"/></button>
                                </td>
                            </tr>
                        )) : (<tr><td colSpan="5" className="text-center py-10 text-gray-500">No hay operaciones para el período seleccionado.</td></tr>)}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const OperationModal = ({ op, onClose }) => {
    const { user } = useAuth();
    const [formData, setFormData] = useState({
        type: op?.type || 'venta',
        amount: op?.amount || '',
        description: op?.description || '',
        fechaEmision: op?.fechaEmision ? op.fechaEmision.toDate().toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
    });
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [message, setMessage] = useState('');
    
    const handleChange = e => setFormData({...formData, [e.target.name]: e.target.value});

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!user || isSubmitting) return;

        setIsSubmitting(true);
        const localDate = new Date(formData.fechaEmision + 'T00:00:00');
        
        const dataToSave = {
            type: formData.type,
            amount: parseFloat(formData.amount),
            description: formData.description,
            fechaEmision: Timestamp.fromDate(localDate),
            year: localDate.getFullYear(),
            month: localDate.getMonth() + 1,
            day: localDate.getDate()
        };

        try {
            if (op) { // Editing
                await updateDoc(doc(db, 'users', user.uid, 'operations', op.id), dataToSave);
            } else { // Creating
                await addDoc(collection(db, 'users', user.uid, 'operations'), dataToSave);
            }
            onClose();
        } catch (error) {
            setMessage('Error al guardar la operación.');
            console.error(error);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content">
                <h2 className="text-2xl font-bold mb-6">{op ? 'Editar' : 'Nueva'} Operación</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="label">Fecha</label>
                        <input type="date" name="fechaEmision" value={formData.fechaEmision} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"/>
                    </div>
                    <div>
                        <label className="label">Tipo</label>
                        <select name="type" value={formData.type} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md">
                            <option value="venta">Venta</option>
                            <option value="compra">Compra</option>
                            <option value="ingreso">Ingreso</option>
                            <option value="gasto">Gasto</option>
                        </select>
                    </div>
                    <div>
                        <label className="label">Monto</label>
                        {/* MEJORA UX: Input con signo $ y autoselección */}
                        <div className="relative">
                            <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            <input 
                                type="number" 
                                step="0.01" 
                                name="amount" 
                                value={formData.amount} 
                                onChange={handleChange} 
                                onFocus={(e) => e.target.select()}
                                required 
                                className="mt-1 w-full pl-7 p-2 border rounded-md" 
                            />
                        </div>
                    </div>
                    <div>
                        <label className="label">Descripción</label>
                        <textarea name="description" value={formData.description} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"></textarea>
                    </div>
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-md">Cancelar</button>
                        <button type="submit" disabled={isSubmitting} className="py-2 px-4 bg-blue-600 text-white rounded-md disabled:bg-gray-400">{isSubmitting ? 'Guardando...' : 'Guardar'}</button>
                    </div>
                     {message && <p className="text-red-500 text-center">{message}</p>}
                </form>
            </div>
        </div>
    );
};

        const FinancesPage = () => {
    const { user, userData } = useAuth();
    const [dollarRates, setDollarRates] = useState([]);
    const [loadingRates, setLoadingRates] = useState(true);
    const [isEditingBudget, setIsEditingBudget] = useState(false);
    const [budget, setBudget] = useState({ incomeGoal: 0, expenseBudget: 0 });
    
    const [operations, setOperations] = useState([]);

    // Carga de Operaciones del mes actual
    useEffect(() => {
        if (!user) return;
        const now = new Date();
        const q = query(
            collection(db, 'users', user.uid, 'operations'),
            where("year", "==", now.getFullYear()),
            where("month", "==", now.getMonth() + 1)
        );
        const unsubscribe = onSnapshot(q, (snapshot) => {
            setOperations(snapshot.docs.map(doc => doc.data()));
        });
        return () => unsubscribe();
    }, [user]);

    // Carga de Presupuesto desde UserData
    useEffect(() => {
        if (userData) {
            setBudget({
                incomeGoal: userData.incomeGoal || 0,
                expenseBudget: userData.expenseBudget || 0,
            });
        }
    }, [userData]);
    
    // Cálculo de métricas mensuales
    const monthlyMetrics = useMemo(() => {
        let income = 0, expense = 0;
        operations.forEach(op => {
            if (['venta', 'ingreso'].includes(op.type)) income += op.amount;
            else expense += op.amount;
        });
        return { income, expense };
    }, [operations]);

    const handleSaveBudget = async () => {
        if (!user) return;
        const userDocRef = doc(db, 'users', user.uid);
        try {
            await updateDoc(userDocRef, {
                incomeGoal: parseFloat(budget.incomeGoal) || 0,
                expenseBudget: parseFloat(budget.expenseBudget) || 0
            });
            setIsEditingBudget(false);
        } catch (error) {
            console.error("Error updating budget:", error);
        }
    };
    
    const formatCurrency = (value) => {
        if (value === null || typeof value === 'undefined') return '$--';
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value)
    };

    // API Dólar
    useEffect(() => {
        const fetchFinancialData = async () => {
            setLoadingRates(true);
            try {
                const response = await fetch('https://dolarapi.com/v1/dolares');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                setDollarRates(data);
            } catch (error) { 
                console.error("Failed to fetch dollar data:", error);
                setDollarRates([]);
            } finally {
                setLoadingRates(false);
            }
        };
        fetchFinancialData();
    }, []);
    
    return (
         <div className="space-y-8 p-4">
             <h2 className="text-3xl font-extrabold text-gray-800 tracking-tight">Finanzas</h2>
             
             {/* SECCIÓN PRESUPUESTO */}
             <section>
                <h3 className="text-xl font-bold mb-4 text-gray-700">Presupuesto Mensual</h3>
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    {isEditingBudget ? (
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Meta de Ingresos</label>
                                    <div className="relative">
                                        <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                        <input 
                                            type="number" 
                                            value={budget.incomeGoal} 
                                            onChange={e => setBudget({...budget, incomeGoal: e.target.value})} 
                                            onFocus={(e) => e.target.select()}
                                            className="w-full pl-7 p-2 border rounded-xl"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Límite de Gastos</label>
                                    <div className="relative">
                                        <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                        <input 
                                            type="number" 
                                            value={budget.expenseBudget} 
                                            onChange={e => setBudget({...budget, expenseBudget: e.target.value})} 
                                            onFocus={(e) => e.target.select()}
                                            className="w-full pl-7 p-2 border rounded-xl"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 pt-2">
                                <button onClick={() => setIsEditingBudget(false)} className="py-2 px-4 bg-gray-100 rounded-xl hover:bg-gray-200 font-medium">Cancelar</button>
                                <button onClick={handleSaveBudget} className="py-2 px-4 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-medium">Guardar Cambios</button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <h4 className="font-bold text-lg text-gray-600">Progreso del Mes</h4>
                                <button onClick={() => setIsEditingBudget(true)} className="text-sm font-bold text-blue-600 hover:text-blue-800 flex items-center">
                                    <Icon name="Edit" className="w-4 h-4 mr-1"/> Editar Objetivos
                                </button>
                            </div>
                            
                            {/* Barra Ingresos */}
                            <div>
                                <div className="flex justify-between mb-2 text-sm">
                                    <span className="font-bold text-gray-700">Ingresos Reales</span>
                                    <span className="font-medium text-gray-600">{formatCurrency(monthlyMetrics.income)} <span className="text-gray-400 mx-1">/</span> Meta: {formatCurrency(budget.incomeGoal)}</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                    <div className="bg-green-500 h-3 rounded-full transition-all duration-500" style={{ width: `${Math.min((monthlyMetrics.income / (budget.incomeGoal || 1)) * 100, 100)}%` }}></div>
                                </div>
                            </div>

                            {/* Barra Gastos */}
                             <div>
                                <div className="flex justify-between mb-2 text-sm">
                                    <span className="font-bold text-gray-700">Gastos Reales</span>
                                    <span className="font-medium text-gray-600">{formatCurrency(monthlyMetrics.expense)} <span className="text-gray-400 mx-1">/</span> Límite: {formatCurrency(budget.expenseBudget)}</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                    <div className={`h-3 rounded-full transition-all duration-500 ${monthlyMetrics.expense > budget.expenseBudget ? 'bg-red-600' : 'bg-red-400'}`} style={{ width: `${Math.min((monthlyMetrics.expense / (budget.expenseBudget || 1)) * 100, 100)}%` }}></div>
                                </div>
                            </div>
                        </div>
                    )}
                 </div>
             </section>

             {/* SECCIÓN COTIZACIONES */}
             <section>
                 <h3 className="text-xl font-bold my-6 text-gray-700">Indicadores de Mercado</h3>
                 <div className="relative">
                     <div className="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide" style={{ scrollSnapType: 'x mandatory' }}>
                         {loadingRates ? <div className="w-full text-center py-10 text-gray-400">Cargando cotizaciones...</div> : 
                          dollarRates.length > 0 ? dollarRates.map(rate => (
                             <div key={rate.casa} className="flex-shrink-0 w-80 bg-white p-6 rounded-3xl shadow-sm border border-gray-100 snap-center">
                                 <div className="flex items-center justify-between mb-4">
                                     <h4 className="font-bold text-lg capitalize text-gray-800">{rate.nombre}</h4>
                                     <span className="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">ARS</span>
                                 </div>
                                 <div className="flex justify-between items-end">
                                     <div>
                                         <p className="text-xs text-gray-400 uppercase font-bold mb-1">Compra</p>
                                         <p className="text-2xl font-black text-gray-700">{formatCurrency(rate.compra)}</p>
                                     </div>
                                     <div className="text-right">
                                         <p className="text-xs text-gray-400 uppercase font-bold mb-1">Venta</p>
                                         <p className="text-2xl font-black text-blue-600">{formatCurrency(rate.venta)}</p>
                                     </div>
                                 </div>
                             </div>
                         )) : <p className="text-gray-500">No disponible.</p>
                         }
                     </div>
                 </div>
             </section>

             {/* SECCIÓN CALCULADORA */}
             <section>
                 <h3 className="text-xl font-bold my-6 text-gray-700">Herramientas</h3>
                 <FixedDepositCalculator />
             </section>
         </div>
    );
};

// COMPONENTE CALCULADORA (INCLUIDO AQUÍ PARA QUE FUNCIONE)
const FixedDepositCalculator = () => {
    const [capital, setCapital] = useState('');
    const [days, setDays] = useState(30);
    const [tna, setTna] = useState('');
    const [result, setResult] = useState({ interest: 0, total: 0 });

    const formatCurrency = (value) => {
        if (value === null || typeof value === 'undefined' || isNaN(value)) return '$0,00';
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
    };

    useEffect(() => {
        const numCapital = parseFloat(capital);
        const numDays = parseInt(days, 10);
        const numTna = parseFloat(tna);

        if (numCapital > 0 && numDays > 0 && numTna > 0) {
            const calculatedInterest = (numCapital * numDays * numTna) / 36500;
            setResult({
                interest: calculatedInterest,
                total: numCapital + calculatedInterest
            });
        } else {
            setResult({ interest: 0, total: numCapital > 0 ? numCapital : 0 });
        }
    }, [capital, days, tna]);

    return (
        <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold mb-6 text-gray-700 flex items-center">
                <Icon name="Calculator" className="w-5 h-5 mr-2 text-blue-500"/>
                Simulador de Plazo Fijo
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">Capital a Invertir</label>
                    <div className="relative">
                        <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                        <input 
                            type="number" 
                            value={capital} 
                            onChange={e => setCapital(e.target.value)} 
                            onFocus={(e) => e.target.select()}
                            placeholder="Ej: 100000" 
                            className="w-full pl-7 p-2 border rounded-xl bg-gray-50 focus:bg-white transition-colors"
                        />
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">Días</label>
                    <input 
                        type="number" 
                        value={days} 
                        onChange={e => setDays(e.target.value)} 
                        onFocus={(e) => e.target.select()}
                        placeholder="Ej: 30" 
                        className="w-full p-2 border rounded-xl bg-gray-50 focus:bg-white transition-colors"
                    />
                </div>
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">T.N.A.</label>
                    <div className="relative">
                        <input 
                            type="number" 
                            step="0.01" 
                            value={tna} 
                            onChange={e => setTna(e.target.value)} 
                            onFocus={(e) => e.target.select()}
                            placeholder="Ej: 75" 
                            className="w-full p-2 border rounded-xl pr-8 bg-gray-50 focus:bg-white transition-colors" 
                        />
                        <span className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                    </div>
                </div>
            </div>
            <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-2xl flex flex-col md:flex-row justify-around items-center text-center md:text-left">
                <div className="mb-4 md:mb-0">
                    <p className="text-gray-500 text-sm font-bold uppercase">Intereses Ganados</p>
                    <p className="text-3xl font-black text-green-600">{formatCurrency(result.interest)}</p>
                </div>
                <div>
                    <p className="text-gray-500 text-sm font-bold uppercase">Monto Final</p>
                    <p className="text-3xl font-black text-blue-600">{formatCurrency(result.total)}</p>
                </div>
            </div>
        </div>
    );
};
        // --- NUEVO COMPONENTE SEPARADO PARA NOTIFICACIONES ---
        const NotificationPanel = () => {
            // Leemos las notificaciones globales desde el AuthProvider
            const { notifications, loadingNotifications } = useAuth();

            const getIcon = (type) => {
                switch(type) {
                    case 'warning': return 'AlertTriangle';
                    case 'info': return 'File';
                    default: return 'CheckCircle';
                }
            };

            const getColor = (type) => {
                 switch(type) {
                    case 'warning': return 'bg-yellow-50 border-yellow-400 text-yellow-600';
                    case 'info': return 'bg-blue-50 border-blue-400 text-blue-600';
                    default: return 'bg-green-50 border-green-400 text-green-600';
                }
            };

            return (
                <div className="bg-white p-8 rounded-lg shadow-md">
                    <h3 className="text-xl font-bold mb-4">Notificaciones</h3>
                    {loadingNotifications ? <p className="text-gray-500">Cargando notificaciones...</p> : 
                        <div className="space-y-4">
                            {notifications.length > 0 ? notifications.map(notif => (
                                <div key={notif.id} className={`flex items-start p-4 border-l-4 rounded-r-lg ${getColor(notif.type)}`}>
                                    <Icon name={getIcon(notif.type)} className="h-6 w-6 mr-3 shrink-0"/>
                                    <div>
                                        <p className="font-bold">{notif.title}</p>
                                        <p className="text-sm">{notif.body}</p>
                                    </div>
                                </div>
                            )) : <p className="text-gray-500">No hay notificaciones nuevas.</p>}
                        </div>
                    }
                </div>
            );
        };

        const ClientCenterPage = ({ isManagedView = false, managedUserId = null, managedClientName = '' }) => {
            const { user, userData } = useAuth();
            const currentUserId = isManagedView ? managedUserId : user?.uid;
            
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [message, setMessage] = useState('');
            const [files, setFiles] = useState({});
            const [currentFolder, setCurrentFolder] = useState(null);
            const [loadingFiles, setLoadingFiles] = useState(true);
            const [storageError, setStorageError] = useState('');
            const [showConfirmDelete, setShowConfirmDelete] = useState(false);
            const [fileToDelete, setFileToDelete] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [loadingNotifications, setLoadingNotifications] = useState(true);
            
            const folders = [
                { id: 'comprobantes', name: 'Comprobantes', acl: 'client' },
                { id: 'contratos', name: 'Contratos', acl: 'client' },
                { id: 'balances', name: 'Balances', acl: 'client' },
                { id: 'documentos_del_contador', name: 'Documentos del Contador', acl: 'accountant' },
            ];

            const handleFirebaseError = (error) => {
                console.error("Firebase Storage Error:", error);
                if (error.code === 'storage/unauthorized') {
                    setStorageError('Error de permisos. Verifica que las Reglas de Seguridad de Firebase Storage estén configuradas correctamente para permitir la lectura y escritura.');
                } else {
                    setStorageError('Ocurrió un error inesperado al operar con los archivos.');
                }
            };
            
            const fetchFiles = useCallback(async () => {
                if (!currentUserId) return;
                setLoadingFiles(true);
                setStorageError('');
                try {
                    const listRef = ref(storage, `user_documents/${currentUserId}`);
                    const res = await listAll(listRef);
                    
                    const filesByFolder = {};
                    folders.forEach(f => filesByFolder[f.id] = []);

                    for (const folderRef of res.prefixes) {
                        const folderName = folderRef.name;
                        if (filesByFolder.hasOwnProperty(folderName)) {
                            const folderFiles = await listAll(folderRef);
                            filesByFolder[folderName] = await Promise.all(
                                folderFiles.items.map(async (itemRef) => ({
                                    name: itemRef.name,
                                    url: await getDownloadURL(itemRef),
                                    fullPath: itemRef.fullPath
                                }))
                            );
                        }
                    }
                    setFiles(filesByFolder);
                } catch (error) {
                    handleFirebaseError(error);
                } finally {
                    setLoadingFiles(false);
                }
            }, [currentUserId]);

            useEffect(() => { fetchFiles(); }, [fetchFiles]);
            
            const [uploadFolder, setUploadFolder] = useState(isManagedView ? 'documentos_del_contador' : 'comprobantes');

            const handleUpload = async () => {
            if (!file || !currentUserId) return;
            setUploading(true);
            setStorageError('');
            setMessage('');
            const storageRef = ref(storage, `user_documents/${currentUserId}/${uploadFolder}/${file.name}`);
            try {
                await uploadBytes(storageRef, file);
                setMessage({ type: 'success', text: 'Archivo subido.' }); 
                
                // --- INICIO DE CÓDIGO NUEVO ---
                // Si eres el Admin (isManagedView es true) y subes a la carpeta "documentos_del_contador"...
                if (isManagedView && uploadFolder === 'documentos_del_contador') {
                    // Creamos una notificación real para el cliente
                    const notifCollection = collection(db, 'users', currentUserId, 'notifications');
                    await addDoc(notifCollection, {
                        title: "Nuevo Documento del Contador",
                        body: `Se ha subido el archivo: "${file.name}" a tu carpeta.`,
                        type: "info", // Usaremos 'info' para el color azul
                        timestamp: Timestamp.now()
                    });
                }
                // --- FIN DE CÓDIGO NUEVO ---
                
                setFile(null); 
                fetchFiles(); // Actualiza la lista de archivos
            } catch (error) { 
                setMessage({ type: 'error', text: 'Error al subir.' }); 
                handleFirebaseError(error);
            } finally { 
                setUploading(false); 
                setTimeout(() => setMessage(''), 3000); 
            }
        };
            
            const promptDelete = (filePath) => {
                setFileToDelete(filePath);
                setShowConfirmDelete(true);
            };

            const confirmDeleteFile = async () => {
                if (!fileToDelete) return;
                setStorageError('');
                const fileRef = ref(storage, fileToDelete);
                try {
                    await deleteObject(fileRef);
                    fetchFiles();
                } catch (error) {
                    handleFirebaseError(error);
                } finally {
                    setShowConfirmDelete(false);
                    setFileToDelete(null);
                }
            };
            
            const canDelete = (folderId) => {
                const folder = folders.find(f => f.id === folderId);
                if (userData?.isAdmin) return true; // Admin can delete from any folder.
                if (folder?.acl === 'client') return true; // Client can delete from their own folders.
                return false;
            };

            const FolderView = () => (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {folders.map(folder => (
                        <button key={folder.id} onClick={() => setCurrentFolder(folder.id)} className="p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow text-center">
                            <Icon name="Folder" className="mx-auto h-12 w-12 text-blue-500 mb-2"/>
                            <p className="font-semibold">{folder.name}</p>
                        </button>
                    ))}
                </div>
            );

            const FileView = () => (
                <div>
                    <button onClick={() => setCurrentFolder(null)} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                        <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver a Carpetas
                    </button>
                    <h3 className="text-2xl font-bold mb-4">Carpeta: {folders.find(f => f.id === currentFolder)?.name}</h3>
                    <ul className="bg-white p-4 rounded-lg shadow-md divide-y divide-gray-200">
                        {loadingFiles ? <p>Cargando...</p> : files[currentFolder]?.length > 0 ? (
                            files[currentFolder].map((f) => (
                                <li key={f.name} className="py-3 flex justify-between items-center">
                                    <a href={f.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline flex items-center">
                                        <Icon name="File" className="w-5 h-5 mr-3 text-gray-500"/> {f.name}
                                    </a>
                                     {canDelete(currentFolder) && (
                                        <button onClick={() => promptDelete(f.fullPath)} className="text-red-500 hover:text-red-700">
                                            <Icon name="Trash2" className="w-5 h-5" />
                                        </button>
                                    )}
                                </li>
                            ))
                        ) : <p className="text-gray-500 text-center py-4">Esta carpeta está vacía.</p>}
                    </ul>
                </div>
            );
            
            // He añadido más tipos de archivo aquí para asegurar que se puedan seleccionar.
            const fileInputAccept = "image/*,application/pdf,.doc,.docx,.xls,.xlsx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">{isManagedView ? `Gestionando Documentos de ${managedClientName || 'Cliente'}` : "Centro del Cliente"}</h2>
                    {showConfirmDelete && ( <ConfirmModal message="¿Estás seguro de que quieres eliminar este archivo? Esta acción no se puede deshacer." onConfirm={confirmDeleteFile} onCancel={() => setShowConfirmDelete(false)}/> )}
                    {storageError && (<div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert"><p className="font-bold">Error de Almacenamiento</p><p>{storageError}</p></div>)}
                    
                    <div className="bg-white p-8 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-4">Subir un Documento</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="file" accept={fileInputAccept} onChange={(e) => setFile(e.target.files[0])} className="md:col-span-1" />
                            <select value={uploadFolder} onChange={(e) => setUploadFolder(e.target.value)} className="p-2 border rounded-md md:col-span-1">
                                {(isManagedView ? folders.filter(f => f.acl === 'accountant') : folders.filter(f => f.acl === 'client')).map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                            </select>
                            <button onClick={handleUpload} disabled={!file || uploading} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 md:col-span-1">
                                {uploading ? 'Subiendo...' : 'Subir Archivo'}
                            </button>
                        </div>
                        {message && <p className={`mt-4 text-sm text-center ${message.type === 'success' ? 'text-green-600' : 'text-red-600'}`}>{message.text}</p>}
                    </div>

                    <div className="bg-white p-8 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-4">Mis Documentos</h3>
                        {currentFolder ? <FileView /> : <FolderView />}
                    </div>

                    {!isManagedView && <NotificationPanel />}
                </div>
            );
        };
        const ProfilePage = () => {
            const { user, userData } = useAuth();
            const [profile, setProfile] = useState({ nombre: '', cuit: '', actividad: '', categoriaTributaria: '', telefono: '' });
            const [message, setMessage] = useState(null); // { type: 'success'|'error', text: '...' } o null
            const [saving, setSaving] = useState(false);

            useEffect(() => { if (userData) setProfile(prev => ({...prev, ...userData})); }, [userData]);
            
            const handleChange = (e) => setProfile(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                setSaving(true);
                setMessage(null);
                try {
                  await updateDoc(doc(db, 'users', user.uid), profile);
                  setMessage({ type: 'success', text: 'Perfil actualizado.'});
                } catch (error) {
                  console.error("Perfil update error:", error);
                  setMessage({ type: 'error', text: 'Error al actualizar. Revisa la consola.' });
                } finally {
                  setSaving(false);
                  setTimeout(() => setMessage(null), 3000);
                }
            };
            
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Mi Perfil</h2>
                    <div className="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="font-medium">Nombre Completo</label><input name="nombre" value={profile.nombre} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                            <div><label className="font-medium">CUIT/CUIL</label><input name="cuit" value={profile.cuit} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                            <div><label className="font-medium">Actividad Principal</label><input name="actividad" value={profile.actividad} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                             <div><label className="font-medium">Categoría Tributaria</label><select name="categoriaTributaria" value={profile.categoriaTributaria} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"><option>Monotributo</option><option>Responsable Inscripto</option></select></div>
                            <div><label className="font-medium">Teléfono de Contacto</label><input name="telefono" value={profile.telefono} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                            <button type="submit" disabled={saving} className={`w-full py-2 rounded-md ${saving ? 'bg-gray-400' : 'bg-blue-600 text-white'}`}>
                              {saving ? 'Guardando...' : 'Guardar Cambios'}
                            </button>
                            {message && <p className={`text-center mt-2 ${message.type === 'success' ? 'text-green-600' : 'text-red-600'}`}>{message.text}</p>}
                        </form>
                    </div>
                </div>
            );
        };

        const AdminPage = () => {
    const { userData } = useAuth();
    const [users, setUsers] = React.useState([]);
    const [error, setError] = React.useState('');
    const { navigate } = React.useContext(AppContext);

    // --- Estados para acciones ---
    const [claimMessage, setClaimMessage] = React.useState('');
    const [isClaiming, setIsClaiming] = React.useState(false);
    const functions = getFunctions(); // Mantenemos tu definición original
    
    const [isDeleting, setIsDeleting] = React.useState(false);
    const [userToDelete, setUserToDelete] = React.useState(null); 
    const [deleteMessage, setDeleteMessage] = React.useState('');

    // 1. Cargar Usuarios (Tu código original)
    const handleDeleteUser = async () => {
        if (!userToDelete) return;
        setIsDeleting(true); setDeleteMessage('Eliminando usuario y todos sus datos...');
        try {
            const deleteUserAndData = httpsCallable(functions, 'deleteUserAndData');
            const result = await deleteUserAndData({ uid: userToDelete.id });
            setDeleteMessage(`¡Éxito! ${result.data.message}`);
            // Recargamos la lista
            const q = query(collection(db, "users"));
            const querySnapshot = await getDocs(q);
            setUsers(querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
        } catch (err) {
            console.error("Error al llamar a deleteUserAndData:", err);
            setDeleteMessage(`Error: ${err.message}`);
        } finally {
            setIsDeleting(false);
            setTimeout(() => { setUserToDelete(null); setDeleteMessage(''); }, 4000);
        }
    };

    React.useEffect(() => {
        const fetchUsers = async () => {
            setError('');
            try {
                const q = query(collection(db, "users")); // Tu query original
                const querySnapshot = await getDocs(q);
                setUsers(querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
            } catch (err) {
                console.error("Error fetching users:", err);
                setError("No se pudieron cargar los clientes.");
            }
        };
        if(userData?.isAdmin) fetchUsers();
    }, [userData]);

    // --- 2. FUNCIÓN MEJORADA: ACTIVAR SERVICIO ---
    const toggleBillingService = async (targetUser) => {
        const newState = !targetUser.servicioFacturacion;
        try {
            await updateDoc(doc(db, "users", targetUser.id), {
                servicioFacturacion: newState,
                // Al activar, si no tiene modo, le ponemos 'estudio' por defecto
                modoFacturacion: newState ? (targetUser.modoFacturacion || 'estudio') : targetUser.modoFacturacion
            });
            setUsers(users.map(u => u.id === targetUser.id ? {...u, servicioFacturacion: newState} : u));
        } catch (err) {
            console.error("Error updating service:", err);
            alert("Error al cambiar el estado del servicio.");
        }
    };

    // --- 3. NUEVA FUNCIÓN (LA QUE FALTABA): CAMBIAR MODO ---
    const changeBillingMode = async (targetUser, newMode) => {
        try {
            await updateDoc(doc(db, "users", targetUser.id), {
                modoFacturacion: newMode
            });
            setUsers(users.map(u => u.id === targetUser.id ? {...u, modoFacturacion: newMode} : u));
        } catch (err) {
            console.error(err);
            alert("Error al cambiar el modo.");
        }
    };

    // --- Funciones de Admin originales ---
    const handleMakeAdmin = async () => {
        setIsClaiming(true); setClaimMessage('Procesando...');
        try {
            const makeMeAdmin = httpsCallable(functions, 'makeMeAdmin');
            await makeMeAdmin();
            if (auth.currentUser) await auth.currentUser.getIdTokenResult(true);
            setClaimMessage('¡Éxito! Token actualizado. Por favor, CIERRA SESIÓN.');
        } catch (err) {
            console.error(err);
            setClaimMessage(`Error: ${err.message}`);
        } finally {
            setIsClaiming(false);
        }
    };

    if (!userData?.isAdmin) return <div><h2 className="text-3xl font-bold text-red-600">Acceso Denegado</h2><p>Esta sección es solo para administradores.</p></div>;

    return (
        <div className="p-6">
            {userToDelete && <ConfirmModal message={`¿Estás seguro de eliminar a ${userToDelete.nombre}?`} confirmText="Sí, Eliminar" isDestructive={true} onConfirm={handleDeleteUser} onCancel={() => setUserToDelete(null)} />}
            
            <h2 className="text-3xl font-bold mb-6">Panel de Administración</h2>
            
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-md mb-6 shadow-sm">
                <h3 className="text-lg font-bold text-yellow-800 flex items-center"><Icon name="AlertTriangle" className="w-5 h-5 mr-2"/> Configuración Admin</h3>
                <div className="mt-2 flex items-center gap-4">
                    <button onClick={handleMakeAdmin} disabled={isClaiming} className="mt-2 bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 disabled:bg-gray-400 font-semibold text-xs">
                        {isClaiming ? 'Procesando...' : "Restaurar mi Rol de Admin"}
                    </button>
                    <span className="text-xs text-yellow-600">{claimMessage}</span>
                </div>
            </div>
            
            {error && <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6">{error}</div>}

            <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                <h3 className="text-xl font-bold mb-4 flex items-center"><Icon name="Users" className="w-6 h-6 mr-2"/> Lista de Clientes</h3>
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">Nombre</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">Email / CUIT</th>
                            {/* TÍTULO COLUMNA NUEVO */}
                            <th className="px-6 py-3 text-center text-xs font-bold uppercase text-gray-500">Servicio Facturación</th>
                            <th className="px-6 py-3 text-center text-xs font-medium uppercase text-gray-500">Acciones</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {users.map(user => (
                            <tr key={user.id} className="hover:bg-gray-50 transition-colors">
                                <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{user.nombre || '-'}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div>{user.email}</div>
                                    <div className="font-mono text-xs text-gray-400">{user.cuit || 'S/D'}</div>
                                </td>
                                
                                {/* --- CELDA NUEVA (INTERRUPTOR + SELECTOR) --- */}
                                <td className="px-6 py-4 text-center align-top">
                                    <div className="flex flex-col items-center gap-2">
                                        <div className="flex items-center gap-2">
                                            <button 
                                                onClick={() => toggleBillingService(user)}
                                                className={`relative inline-flex items-center h-5 rounded-full w-9 transition-colors focus:outline-none ${user.servicioFacturacion ? 'bg-green-500' : 'bg-gray-300'}`}
                                            >
                                                <span className={`inline-block w-3 h-3 transform bg-white rounded-full transition-transform ${user.servicioFacturacion ? 'translate-x-5' : 'translate-x-1'}`}/>
                                            </button>
                                            <span className="text-[10px] font-bold text-gray-500 w-10 text-left">{user.servicioFacturacion ? 'ON' : 'OFF'}</span>
                                        </div>

                                        {/* EL SELECTOR QUE FALTABA */}
                                        {user.servicioFacturacion && (
                                            <select 
                                                value={user.modoFacturacion || 'estudio'}
                                                onChange={(e) => changeBillingMode(user, e.target.value)}
                                                className={`text-[10px] font-bold py-1 px-1 rounded border cursor-pointer outline-none w-full max-w-[120px]
                                                    ${(user.modoFacturacion || 'estudio') === 'estudio' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-purple-50 text-purple-700 border-purple-200'}`}
                                            >
                                                <option value="estudio">Gestiono YO</option>
                                                <option value="cliente">Autogestión</option>
                                            </select>
                                        )}
                                    </div>
                                </td>

                                <td className="px-6 py-4 whitespace-nowrap text-center text-sm">
                                    <div className="flex items-center justify-center gap-2">
                                        <button onClick={() => navigate(`/admin/manage/${user.id}`)} className="bg-blue-100 text-blue-600 px-3 py-1 rounded hover:bg-blue-200 text-xs font-bold">
                                            Gestionar
                                        </button>
                                        <button onClick={() => setUserToDelete({ id: user.id, nombre: user.nombre || user.email })} className="text-red-600 hover:text-red-800" title="Eliminar">
                                            <Icon name="Trash2" className="w-5 h-5"/>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

        const AdminClientManagementPage = ({ userId }) => {
             const { navigate } = useContext(AppContext);
             const [clientData, setClientData] = useState(null);

             useEffect(() => {
                 const fetchClientData = async () => {
                     const clientDocRef = doc(db, "users", userId);
                     const clientDoc = await getDoc(clientDocRef);
                     if (clientDoc.exists()) {
                         setClientData(clientDoc.data());
                     }
                 };
                 fetchClientData();
             }, [userId]);

             return (
                 <div>
                     <button onClick={() => navigate('/admin')} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                         <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver al Panel de Admin
                     </button>
                     <ClientCenterPage 
                         isManagedView={true} 
                         managedUserId={userId} 
                         managedClientName={clientData?.nombre} 
                     />
                 </div>
             )
        };

        const GestionPage = () => {
          const { navigate } = useContext(AppContext);
          return (
              <div>
                  <h2 className="text-3xl font-bold mb-6">Panel de Gestión</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      
                      {/* Panel de Administración de Terceros (Nuevo) */}
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer lg:col-span-3" onClick={() => navigate('/gestion/terceros')}>
                          <h3 className="text-xl font-bold text-gray-700 mb-2 flex items-center"><Icon name="Users" className="w-5 h-5 mr-2"/> Gestión de Terceros</h3>
                          <p className="text-gray-600">Administra tu base de Clientes y Proveedores desde un solo lugar.</p>
                      </div>

                      {/* Paneles existentes */}
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate('/gestion/deudores')}>
                          <h3 className="text-xl font-bold text-blue-600 mb-2">Deudores por Venta</h3>
                          <p className="text-gray-600">Administra tus cuentas por cobrar, registra pagos y controla los saldos de tus clientes.</p>
                      </div>
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate('/gestion/proveedores')}>
                          <h3 className="text-xl font-bold text-purple-600 mb-2">Proveedores</h3>
                          <p className="text-gray-600">Lleva un registro de tus cuentas por pagar, gestiona vencimientos y organiza tus pagos.</p>
                      </div>
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate('/gestion/cheques')}>
                          <h3 className="text-xl font-bold text-green-600 mb-2">Gestión de Cheques</h3>
                          <p className="text-gray-600">Controla los cheques emitidos y recibidos, sus fechas de vencimiento y estados.</p>
                      </div>
                  </div>
              </div>
          );
        };

        const DeudoresPage = () => {
          const { user } = useAuth();
          const { navigate } = useContext(AppContext);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState('');
          const [saldosData, setSaldosData] = useState({ deudores: [], totalCobrar: 0 });

          // 1. Hook para leer TODOS los datos y calcular saldos
          useEffect(() => {
              if (!user) return;

              const fetchSaldos = async () => {
                  setLoading(true);
                  setError('');
                  try {
                      // Definimos las 3 consultas que necesitamos
                      const qTerceros = query(
                          collection(db, 'users', user.uid, 'terceros'),
                          where("tipo", "in", ["Cliente", "Ambos", "cliente", "ambos"]), // Dejamos el filtro robusto
                          orderBy("nombre", "asc")
                      );
                      const qFacturas = collection(db, 'users', user.uid, 'facturasVenta');
                      const qPagos = collection(db, 'users', user.uid, 'pagosRecibidos');

                      // Ejecutamos las 3 consultas en paralelo
                      const [tercerosSnap, facturasSnap, pagosSnap] = await Promise.all([
                          getDocs(qTerceros),
                          getDocs(qFacturas),
                          getDocs(qPagos)
                      ]);

                      // Procesamos los resultados
                      const terceros = tercerosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                      const facturas = facturasSnap.docs.map(d => d.data());
                      const pagos = pagosSnap.docs.map(d => d.data());

                      // 2. Calculamos los saldos por cliente
                      const saldosPorCliente = {};

                      // Sumamos todas las facturas
                      facturas.forEach(f => {
                          saldosPorCliente[f.terceroId] = (saldosPorCliente[f.terceroId] || 0) + f.montoTotal;
                      });

                      // Restamos todos los pagos
                      pagos.forEach(p => {
                          saldosPorCliente[p.terceroId] = (saldosPorCliente[p.terceroId] || 0) - p.montoPagado;
                      });

                      // 3. Unimos los saldos con la info de los clientes
                      // Filtramos solo los que tienen saldo > 0
                      const deudores = terceros
                          .map(t => ({
                              ...t,
                              saldo: saldosPorCliente[t.id] || 0
                          }))
                          .sort((a, b) => b.saldo - a.saldo); // Opcional: ordenar por mayor saldo

                      // 4. Calculamos el total general
                      const totalCobrar = deudores.reduce((sum, d) => sum + d.saldo, 0);

                      // 5. Guardamos todo en el estado
                      setSaldosData({ deudores, totalCobrar });

                  } catch (err) {
                      console.error("Error al calcular saldos:", err);
                      setError('Error al calcular los saldos. ' + (err.message.includes('index') ? 'Podría faltar un índice en Firestore.' : ''));
                  } finally {
                      setLoading(false);
                  }
              };

              fetchSaldos();
          }, [user]);

          const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

          // 3. Renderizar la página
          return (
              <div>
                  <div className="flex items-center gap-3 mb-6">
    <button 
        onClick={() => navigate('/gestion')} 
        className="p-2 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-900 transition-colors"
        title="Volver al Panel de Gestión"
    >
        <Icon name="ArrowLeft" className="w-6 h-6"/>
    </button>
    <h2 className="text-3xl font-bold text-gray-800">Deudores por Venta</h2>
</div>
                  {error && <p className="text-red-600 bg-red-100 p-3 rounded mb-4">{error}</p>}

                  {/* Tarjetas de Métricas */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                      <div className="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                          <h3 className="text-lg font-semibold text-gray-600 mb-2">Total a Cobrar</h3>
                          <p className="text-3xl font-bold text-blue-600">{formatCurrency(saldosData.totalCobrar)}</p>
                      </div>
                      {/* NOTA: Tarjeta "Total Vencido" quitada temporalmente por complejidad */}
                  </div>

                  {/* Tabla de Deudores */}
                  <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                      <h3 className="text-xl font-bold mb-4">Lista de Clientes y Afines</h3>
                      <table className="min-w-full divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                              <tr>
                                  <th className="px-6 py-3 text-left text-xs font-medium uppercase">Cliente</th>
                                  <th className="px-6 py-3 text-left text-xs font-medium uppercase">CUIT</th>
                                  <th className="px-6 py-3 text-right text-xs font-medium uppercase">Saldo Deudor</th>
                                  <th className="px-6 py-3 text-center text-xs font-medium uppercase">Acciones</th>
                              </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                              {loading ? (
                                  <tr><td colSpan="4" className="text-center py-10 text-gray-500">Calculando saldos...</td></tr>
                              ) : saldosData.deudores.length > 0 ? (
                                  saldosData.deudores.map(cliente => (
                                      <tr key={cliente.id}>
                                          <td className="px-6 py-4 whitespace-nowrap font-medium">{cliente.nombre}</td>
                                          <td className="px-6 py-4 whitespace-nowrap">{cliente.cuit || '-'}</td>
                                          <td className="px-6 py-4 whitespace-nowrap text-right font-semibold text-gray-800">{formatCurrency(cliente.saldo)}</td>
                                          <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                              <button
                                                  onClick={() => navigate(`/gestion/deudores/${cliente.id}`)}
                                                  className="text-indigo-600 hover:text-indigo-900"
                                              >
                                                  Ver Cta. Cte.
                                              </button>
                                          </td>
                                      </tr>
                                  ))
                              ) : (
                                  <tr><td colSpan="4" className="text-center py-10 text-gray-500">No hay terceros de tipo 'Cliente' o 'Ambos' creados.</td></tr>
                              )}
                          </tbody>
                      </table>
                  </div>
              </div>
          );
      };
       // --- PÁGINA DE GESTIÓN DE CHEQUES (CORREGIDA BOTONES) ---
const ChequesPage = () => {
    const { user } = useAuth();
    const [cheques, setCheques] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    
    // ESTADO PARA PESTAÑAS: 'activos' (Pendientes) vs 'historial' (Cerrados)
    const [activeTab, setActiveTab] = useState('activos'); 

    // Estados para el modal de confirmación (AHORA CON TEXTO Y COLOR)
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmParams, setConfirmParams] = useState({ 
        message: '', 
        action: () => {}, 
        confirmText: 'Confirmar', // Texto del botón
        isDestructive: false      // Si es true, el botón es rojo. Si es false, azul.
    });

    const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
    const formatDate = (timestamp) => {
        if (!timestamp || !timestamp.toDate) return '-';
        return timestamp.toDate().toLocaleDateString('es-AR');
    };

    // 1. Hook para leer cheques
    useEffect(() => {
        if (!user) return;
        setLoading(true);

        const q = query(collection(db, 'users', user.uid, 'cheques'), orderBy("fechaVencimiento", "asc"));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCheques(items);
            setLoading(false);
        }, (err) => {
            console.error("Error cheques:", err);
            setError("Error al cargar los cheques.");
            setLoading(false);
        });

        return () => unsubscribe();
    }, [user]);

    // 2. Actualizar estado
    const handleUpdateEstado = async (chequeId, nuevoEstado) => {
        try {
            const docRef = doc(db, 'users', user.uid, 'cheques', chequeId);
            await updateDoc(docRef, { estado: nuevoEstado });
        } catch (err) {
            console.error("Error update:", err);
            setError("Error al actualizar el cheque.");
        }
    };

    // --- FUNCIÓN INTELIGENTE PARA EL MODAL ---
    const promptAction = (message, action, buttonText = 'Confirmar', isDestructive = false) => {
        setConfirmParams({ 
            message, 
            action: () => { action(); setShowConfirmModal(false); },
            confirmText: buttonText,
            isDestructive: isDestructive
        });
        setShowConfirmModal(true);
    };

    // 3. Lógica de Filtrado
    const estadosActivos = ['En Cartera', 'Depositado', 'Emitido'];
    
    const chequesFiltrados = cheques.filter(c => {
        const esActivo = estadosActivos.includes(c.estado);
        return activeTab === 'activos' ? esActivo : !esActivo;
    });

    const chequesRecibidos = chequesFiltrados.filter(c => c.tipo === 'recibido');
    const chequesEmitidos = chequesFiltrados.filter(c => c.tipo === 'emitido');

    // 4. Métricas
    const metricas = useMemo(() => {
        const enCartera = cheques.filter(c => c.estado === 'En Cartera').reduce((sum, c) => sum + c.monto, 0);
        const aDepositar = cheques.filter(c => c.estado === 'Depositado').reduce((sum, c) => sum + c.monto, 0);
        const aCubrir = cheques.filter(c => c.estado === 'Emitido').reduce((sum, c) => sum + c.monto, 0);
        return { enCartera, aDepositar, aCubrir };
    }, [cheques]);

    // --- RENDERIZADORES DE ACCIONES CON TEXTOS CORRECTOS ---
    const renderAccionesRecibido = (cheque) => {
        if (cheque.estado === 'En Cartera') {
            return (
                <button 
                    onClick={() => promptAction(
                        `¿Confirmas el depósito del cheque N° ${cheque.numero}?`, 
                        () => handleUpdateEstado(cheque.id, 'Depositado'),
                        'Depositar', // Texto del botón
                        false // Color azul (no destructivo)
                    )} 
                    className="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200 border border-blue-300"
                >
                    Depositar
                </button>
            );
        }
        if (cheque.estado === 'Depositado') {
            return (
                <button 
                    onClick={() => promptAction(
                        `¿El cheque N° ${cheque.numero} ya se acreditó en tu cuenta? Desaparecerá de pendientes.`, 
                        () => handleUpdateEstado(cheque.id, 'Cobrado'),
                        'Confirmar Cobro', // Texto del botón
                        false // Color azul
                    )} 
                    className="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200 border border-green-300"
                >
                    Confirmar Acreditación
                </button>
            );
        }
        return <span className="text-gray-500 text-xs font-medium">Archivado (Cobrado)</span>;
    };

    const renderAccionesEmitido = (cheque) => {
        if (cheque.estado === 'Emitido') {
            return (
                <button 
                    onClick={() => promptAction(
                        `¿El cheque N° ${cheque.numero} ya se debitó de tu cuenta? Desaparecerá de pendientes.`, 
                        () => handleUpdateEstado(cheque.id, 'Pagado'),
                        'Confirmar Pago', // Texto del botón
                        false // Color azul
                    )} 
                    className="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200 border border-green-300"
                >
                    Confirmar Débito
                </button>
            );
        }
        return <span className="text-gray-500 text-xs font-medium">Archivado (Pagado)</span>;
    };

    return (
        <div>
            {/* Modal Configurado Correctamente */}
            {showConfirmModal && (
                <ConfirmModal 
                    message={confirmParams.message} 
                    onConfirm={confirmParams.action} 
                    onCancel={() => setShowConfirmModal(false)}
                    confirmText={confirmParams.confirmText}
                    isDestructive={confirmParams.isDestructive}
                />
            )}

            <h2 className="text-3xl font-bold mb-6">Gestión de Valores</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <p className="text-gray-500 text-sm font-medium">Cheques en Mano (Cartera)</p>
                    <p className="text-2xl font-bold text-gray-800">{formatCurrency(metricas.enCartera)}</p>
                </div>
                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <p className="text-gray-500 text-sm font-medium">Depositados (Clearing)</p>
                    <p className="text-2xl font-bold text-gray-800">{formatCurrency(metricas.aDepositar)}</p>
                </div>
                <div className="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                    <p className="text-gray-500 text-sm font-medium">A Cubrir (Emitidos)</p>
                    <p className="text-2xl font-bold text-gray-800">{formatCurrency(metricas.aCubrir)}</p>
                </div>
            </div>

            <div className="flex border-b border-gray-200 mb-6">
                <button onClick={() => setActiveTab('activos')} className={`py-2 px-6 font-medium text-sm focus:outline-none ${activeTab === 'activos' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>Cartera Activa (Pendientes)</button>
                <button onClick={() => setActiveTab('historial')} className={`py-2 px-6 font-medium text-sm focus:outline-none ${activeTab === 'historial' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>Historial (Cobrados/Pagados)</button>
            </div>

            {loading ? <p className="text-center py-10">Cargando valores...</p> : (
                <div className="space-y-10">
                    <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <h3 className="text-lg font-bold mb-4 text-gray-700 flex items-center">
                            <Icon name="ArrowDownRight" className="w-5 h-5 mr-2 text-green-600"/>
                            Cheques de Terceros {activeTab === 'historial' ? '(Histórico)' : '(En Cartera / Depositados)'}
                        </h3>
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Cliente</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Banco / N°</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Vencimiento</th>
                                    <th className="px-4 py-3 text-right text-xs font-medium uppercase text-gray-500">Importe</th>
                                    <th className="px-4 py-3 text-center text-xs font-medium uppercase text-gray-500">Estado</th>
                                    <th className="px-4 py-3 text-center text-xs font-medium uppercase text-gray-500">Acción</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {chequesRecibidos.map(c => (
                                    <tr key={c.id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 text-sm">{c.terceroNombre}</td>
                                        <td className="px-4 py-3 text-sm"><div className="font-medium">{c.banco}</div><div className="text-xs text-gray-500">{c.numero}</div></td>
                                        <td className="px-4 py-3 text-sm">{formatDate(c.fechaVencimiento)}</td>
                                        <td className="px-4 py-3 text-sm text-right font-bold text-gray-700">{formatCurrency(c.monto)}</td>
                                        <td className="px-4 py-3 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs ${c.estado === 'En Cartera' ? 'bg-blue-100 text-blue-800' : c.estado === 'Depositado' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}`}>{c.estado}</span>
                                        </td>
                                        <td className="px-4 py-3 text-center">{renderAccionesRecibido(c)}</td>
                                    </tr>
                                ))}
                                {chequesRecibidos.length === 0 && <tr><td colSpan="6" className="text-center py-4 text-gray-500">No hay cheques en esta vista.</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <h3 className="text-lg font-bold mb-4 text-gray-700 flex items-center">
                            <Icon name="ArrowUpRight" className="w-5 h-5 mr-2 text-red-600"/>
                            Cheques Propios {activeTab === 'historial' ? '(Histórico)' : '(A Cubrir)'}
                        </h3>
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Proveedor</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Banco / N°</th>
                                    <th className="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">Vencimiento</th>
                                    <th className="px-4 py-3 text-right text-xs font-medium uppercase text-gray-500">Importe</th>
                                    <th className="px-4 py-3 text-center text-xs font-medium uppercase text-gray-500">Estado</th>
                                    <th className="px-4 py-3 text-center text-xs font-medium uppercase text-gray-500">Acción</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {chequesEmitidos.map(c => (
                                    <tr key={c.id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 text-sm">{c.terceroNombre}</td>
                                        <td className="px-4 py-3 text-sm"><div className="font-medium">{c.banco}</div><div className="text-xs text-gray-500">{c.numero}</div></td>
                                        <td className="px-4 py-3 text-sm">{formatDate(c.fechaVencimiento)}</td>
                                        <td className="px-4 py-3 text-sm text-right font-bold text-gray-700">{formatCurrency(c.monto)}</td>
                                        <td className="px-4 py-3 text-center">
                                            <span className={`px-2 py-1 rounded-full text-xs ${c.estado === 'Emitido' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}`}>{c.estado}</span>
                                        </td>
                                        <td className="px-4 py-3 text-center">{renderAccionesEmitido(c)}</td>
                                    </tr>
                                ))}
                                {chequesEmitidos.length === 0 && <tr><td colSpan="6" className="text-center py-4 text-gray-500">No hay cheques en esta vista.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
        </div>
    );
};

        const ReportsPage = () => {
    const { userData } = useAuth();
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const { data: operations, loading } = useYearlyCollection('operations', selectedYear);

    const years = Array.from({ length: 10 }, (_, i) => new Date().getFullYear() - i);
    const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

    const annualMetrics = useMemo(() => {
        let totalVentas = 0;
        let totalCompras = 0;
        let totalOtrosIngresos = 0;
        let totalOtrosGastos = 0;

        operations.forEach(op => {
            switch (op.type) {
                case 'venta': totalVentas += op.amount; break;
                case 'compra': totalCompras += op.amount; break;
                case 'ingreso': totalOtrosIngresos += op.amount; break;
                case 'gasto': totalOtrosGastos += op.amount; break;
            }
        });

        const totalEntradas = totalVentas + totalOtrosIngresos;
        const totalSalidas = totalCompras + totalOtrosGastos;
        const cashFlow = totalEntradas - totalSalidas;
        const profitability = totalEntradas > 0 ? (cashFlow / totalEntradas) * 100 : 0;

        return { totalVentas, totalCompras, totalOtrosIngresos, totalOtrosGastos, cashFlow, profitability };
    }, [operations]);

    const monthlyBreakdown = useMemo(() => {
        const months = Array.from({ length: 12 }, () => ({ ventas: 0, compras: 0, otrosIngresos: 0, otrosGastos: 0 }));
        operations.forEach(op => {
            const monthIndex = op.month - 1;
            if (monthIndex >= 0 && monthIndex < 12) {
                switch (op.type) {
                    case 'venta': months[monthIndex].ventas += op.amount; break;
                    case 'compra': months[monthIndex].compras += op.amount; break;
                    case 'ingreso': months[monthIndex].otrosIngresos += op.amount; break;
                    case 'gasto': months[monthIndex].otrosGastos += op.amount; break;
                }
            }
        });
        return months;
    }, [operations]);

    const chartRef = React.useRef(null);
    const chartInstanceRef = React.useRef(null);

    useEffect(() => {
        if (chartRef.current) {
            if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
            }
            const ctx = chartRef.current.getContext('2d');
            
            chartInstanceRef.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [
                        {
                            label: 'Ventas',
                            data: monthlyBreakdown.map(m => m.ventas),
                            backgroundColor: '#16a34a', 
                            stack: 'Ingresos',
                            borderRadius: 4,
                        },
                        {
                            label: 'Otros Ingresos',
                            data: monthlyBreakdown.map(m => m.otrosIngresos),
                            backgroundColor: '#4ade80', 
                            stack: 'Ingresos',
                            borderRadius: 4,
                        },
                        {
                            label: 'Compras',
                            data: monthlyBreakdown.map(m => m.compras),
                            backgroundColor: '#dc2626', 
                            stack: 'Egresos',
                            borderRadius: 4,
                        },
                        {
                            label: 'Otros Gastos',
                            data: monthlyBreakdown.map(m => m.otrosGastos),
                            backgroundColor: '#fb923c', 
                            stack: 'Egresos',
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', notation: 'compact' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', notation: 'compact' }).format(value)
                            }
                        }
                    }
                }
            });
        }
    }, [monthlyBreakdown]);

    const handlePrint = () => window.print();

    const handleDownloadCSV = () => {
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        let csvContent = "\uFEFF";
        const headers = ["Mes", "Ventas", "Otros Ingresos", "Compras", "Otros Gastos", "Resultado Neto"];
        csvContent += headers.join(";") + "\n";

        monthlyBreakdown.forEach((monthData, index) => {
            const totalIngresos = monthData.ventas + monthData.otrosIngresos;
            const totalEgresos = monthData.compras + monthData.otrosGastos;
            const result = totalIngresos - totalEgresos;
            csvContent += [monthNames[index], monthData.ventas, monthData.otrosIngresos, monthData.compras, monthData.otrosGastos, result].join(";") + "\n";
        });
        
        csvContent += ["TOTAL ANUAL", annualMetrics.totalVentas, annualMetrics.totalOtrosIngresos, annualMetrics.totalCompras, annualMetrics.totalOtrosGastos, annualMetrics.cashFlow].join(";") + "\n";

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `reporte_anual_${selectedYear}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-wrap justify-between items-center gap-4 no-print">
                <h2 className="text-3xl font-extrabold text-gray-800">Reporte Anual</h2>
                <div className="flex items-center gap-2">
                    <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="p-2 border rounded-xl bg-white shadow-sm font-medium">
                        {years.map(year => <option key={year} value={year}>{year}</option>)}
                    </select>
                    <button onClick={handleDownloadCSV} className="bg-emerald-600 text-white px-4 py-2 rounded-xl hover:bg-emerald-700 flex items-center transition-colors">
                        <Icon name="Download" className="w-5 h-5 mr-2"/> CSV
                    </button>
                    <button onClick={handlePrint} className="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 flex items-center transition-colors">
                        <Icon name="Printer" className="w-5 h-5 mr-2"/> Imprimir
                    </button>
                </div>
            </div>
            
            <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 print-container">
                <div className="text-center mb-10">
                    <h3 className="text-2xl font-black text-gray-800 uppercase tracking-tight">Balance Financiero Anual {selectedYear}</h3>
                    <p className="text-gray-500 font-medium">Consultora: {userData?.nombre || 'Gramajo & Romero'}</p>
                </div>

                {loading ? (
                    <div className="flex justify-center py-20"><p className="text-gray-400 animate-pulse">Procesando datos anuales...</p></div>
                ) : (
                    <>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-10 text-center">
                            <div className="bg-green-50 p-4 rounded-2xl border border-green-100">
                                <h4 className="text-xs font-bold text-green-800 uppercase mb-1">Total Ventas</h4>
                                <p className="text-xl font-black text-green-600">{formatCurrency(annualMetrics.totalVentas)}</p>
                            </div>
                            <div className="bg-red-50 p-4 rounded-2xl border border-red-100">
                                <h4 className="text-xs font-bold text-red-800 uppercase mb-1">Total Compras</h4>
                                <p className="text-xl font-black text-red-600">{formatCurrency(annualMetrics.totalCompras)}</p>
                            </div>
                            <div className="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                                <h4 className="text-xs font-bold text-emerald-800 uppercase mb-1">Otros Ingresos</h4>
                                <p className="text-xl font-black text-emerald-600">{formatCurrency(annualMetrics.totalOtrosIngresos)}</p>
                            </div>
                            <div className="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                                <h4 className="text-xs font-bold text-orange-800 uppercase mb-1">Otros Gastos</h4>
                                <p className="text-xl font-black text-orange-600">{formatCurrency(annualMetrics.totalOtrosGastos)}</p>
                            </div>
                            <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                <h4 className="text-xs font-bold text-blue-800 uppercase mb-1">Flujo Neto</h4>
                                <p className={`text-xl font-black ${annualMetrics.cashFlow >= 0 ? 'text-blue-600' : 'text-red-600'}`}>{formatCurrency(annualMetrics.cashFlow)}</p>
                            </div>
                            <div className="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                                <h4 className="text-xs font-bold text-indigo-800 uppercase mb-1">Rentabilidad</h4>
                                <p className="text-xl font-black text-indigo-600">{annualMetrics.profitability.toFixed(1)}%</p>
                            </div>
                        </div>

                        <div className="mb-12">
                            <h4 className="text-lg font-bold text-gray-700 mb-6 flex items-center justify-center">
                                <Icon name="BarChart3" className="w-5 h-5 mr-2 text-blue-500"/> Composición de Ingresos vs Egresos
                            </h4>
                            
                            {/* CORRECCIÓN 1: Contenedor con scroll para el gráfico en móviles */}
                            <div className="overflow-x-auto pb-4">
                                <div style={{ position: 'relative', height: '350px', minWidth: '800px' }}>
                                    <canvas ref={chartRef}></canvas>
                                </div>
                            </div>
                            <p className="text-center text-sm text-gray-400 mt-2">Barras Apiladas: Compara el volumen total de Entradas vs Salidas por mes.</p>
                        </div>
                        
                        {/* CORRECCIÓN 2: Contenedor con scroll para la tabla en móviles (overflow-x-auto) */}
                        <div className="overflow-x-auto border border-gray-100 rounded-2xl">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Mes</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Ventas</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Compras</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Otros Ing.</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Otros Gas.</th>
                                        <th className="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase whitespace-nowrap">Neto</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                    {monthlyBreakdown.map((monthData, index) => {
                                        const totalMes = (monthData.ventas + monthData.otrosIngresos) - (monthData.compras + monthData.otrosGastos);
                                        return (
                                            <tr key={index} className="hover:bg-gray-50 transition-colors">
                                                <td className="px-6 py-4 text-sm font-bold text-gray-700 capitalize whitespace-nowrap">
                                                    {new Date(0, index).toLocaleString('es-AR', { month: 'long' })}
                                                </td>
                                                <td className="px-6 py-4 text-right text-sm text-green-600 font-medium whitespace-nowrap">{formatCurrency(monthData.ventas)}</td>
                                                <td className="px-6 py-4 text-right text-sm text-red-600 font-medium whitespace-nowrap">{formatCurrency(monthData.compras)}</td>
                                                <td className="px-6 py-4 text-right text-sm text-emerald-600 whitespace-nowrap">{formatCurrency(monthData.otrosIngresos)}</td>
                                                <td className="px-6 py-4 text-right text-sm text-orange-600 whitespace-nowrap">{formatCurrency(monthData.otrosGastos)}</td>
                                                <td className={`px-6 py-4 text-right text-sm font-bold whitespace-nowrap ${totalMes >= 0 ? 'text-gray-800' : 'text-red-600'}`}>
                                                    {formatCurrency(totalMes)}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                                <tfoot className="bg-gray-800 text-white">
                                    <tr>
                                        <td className="px-6 py-4 text-sm font-black uppercase whitespace-nowrap">Totales</td>
                                        <td className="px-6 py-4 text-right text-sm font-black whitespace-nowrap">{formatCurrency(annualMetrics.totalVentas)}</td>
                                        <td className="px-6 py-4 text-right text-sm font-black whitespace-nowrap">{formatCurrency(annualMetrics.totalCompras)}</td>
                                        <td className="px-6 py-4 text-right text-sm font-black text-gray-300 whitespace-nowrap">{formatCurrency(annualMetrics.totalOtrosIngresos)}</td>
                                        <td className="px-6 py-4 text-right text-sm font-black text-gray-300 whitespace-nowrap">{formatCurrency(annualMetrics.totalOtrosGastos)}</td>
                                        <td className="px-6 py-4 text-right text-sm font-black text-yellow-400 whitespace-nowrap">{formatCurrency(annualMetrics.cashFlow)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
};
        // --- GESTIÓN DE TERCEROS (CLIENTES/PROVEEDORES) ---

const TercerosPage = () => {
    const { user } = useAuth();
    const [terceros, setTerceros] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [editingTercero, setEditingTercero] = useState(null);
    const [showConfirmDelete, setShowConfirmDelete] = useState(false);
    const [terceroToDelete, setTerceroToDelete] = useState(null);

    // Hook para leer la colección de terceros en tiempo real
    useEffect(() => {
        if (!user) return;
        setLoading(true);
        const q = query(collection(db, 'users', user.uid, 'terceros'), orderBy("nombre", "asc"));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTerceros(items);
            setLoading(false);
        }, (error) => {
            console.error("Error al leer 'terceros':", error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user]);

    const handleNewTercero = () => {
        setEditingTercero(null);
        setShowModal(true);
    };

    const handleEdit = (tercero) => {
        setEditingTercero(tercero);
        setShowModal(true);
    };

    const promptDelete = (id) => {
        setTerceroToDelete(id);
        setShowConfirmDelete(true);
    };

    const handleDelete = async () => {
        if (!terceroToDelete) return;
        await deleteDoc(doc(db, 'users', user.uid, 'terceros', terceroToDelete));
        setShowConfirmDelete(false);
        setTerceroToDelete(null);
    };

    return (
        <div>
            {showModal && <TerceroModal tercero={editingTercero} onClose={() => setShowModal(false)} />}
            {showConfirmDelete && (
                <ConfirmModal
                    message="¿Estás seguro de que quieres eliminar este tercero? Esto no borrará sus facturas asociadas."
                    onConfirm={handleDelete}
                    onCancel={() => setShowConfirmDelete(false)}
                />
            )}
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold">Gestión de Terceros</h2>
                <button onClick={handleNewTercero} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><Icon name="PlusCircle" className="w-5 h-5 mr-2"/>Nuevo Tercero</button>
            </div>
            <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Nombre / Razón Social</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">CUIT</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Email</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Teléfono</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {loading ? (<tr><td colSpan="6" className="text-center py-10">Cargando terceros...</td></tr>) : 
                        terceros.length > 0 ? terceros.map(t => (
                            <tr key={t.id}>
                                <td className="px-6 py-4 whitespace-nowrap font-medium">{t.nombre}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.cuit}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.tipo}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.email}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.telefono}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onClick={() => handleEdit(t)} className="text-indigo-600 hover:text-indigo-900 mr-4"><Icon name="Edit" className="w-5 h-5"/></button>
                                    <button onClick={() => promptDelete(t.id)} className="text-red-600 hover:text-red-900"><Icon name="Trash2" className="w-5 h-5"/></button>
                                </td>
                            </tr>
                        )) : (<tr><td colSpan="6" className="text-center py-10 text-gray-500">No hay terceros creados. Comienza agregando uno.</td></tr>)}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const TerceroModal = ({ tercero, onClose }) => {
    const { user } = useAuth();
    const [formData, setFormData] = useState({
        nombre: tercero?.nombre || '',
        cuit: tercero?.cuit || '',
        email: tercero?.email || '',
        telefono: tercero?.telefono || '',
        tipo: tercero?.tipo || 'Cliente'
    });
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [message, setMessage] = useState('');
    
    const handleChange = e => setFormData({...formData, [e.target.name]: e.target.value});

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!user || isSubmitting) return;

        setIsSubmitting(true);
        
        const dataToSave = {
            ...formData,
            nombre: formData.nombre.trim(),
            cuit: formData.cuit.trim(),
        };

        try {
            if (tercero) { // Editando
                await updateDoc(doc(db, 'users', user.uid, 'terceros', tercero.id), dataToSave);
            } else { // Creando
                await addDoc(collection(db, 'users', user.uid, 'terceros'), dataToSave);
            }
            onClose();
        } catch (error) {
            setMessage('Error al guardar el tercero.');
            console.error(error);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content">
                <h2 className="text-2xl font-bold mb-6">{tercero ? 'Editar' : 'Nuevo'} Tercero</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label>Nombre / Razón Social</label><input type="text" name="nombre" value={formData.nombre} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"/></div>
                    <div><label>CUIT (sin guiones)</label><input type="text" name="cuit" value={formData.cuit} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                    <div><label>Tipo</label><select name="tipo" value={formData.tipo} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"><option value="Cliente">Cliente</option><option value="Proveedor">Proveedor</option><option value="Ambos">Ambos</option></select></div>
                    <div><label>Email</label><input type="email" name="email" value={formData.email} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                    <div><label>Teléfono</label><input type="tel" name="telefono" value={formData.telefono} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                    
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-md">Cancelar</button>
                        <button type="submit" disabled={isSubmitting} className="py-2 px-4 bg-blue-600 text-white rounded-md disabled:bg-gray-400">{isSubmitting ? 'Guardando...' : 'Guardar'}</button>
                    </div>
                    {message && <p className="text-red-500 text-center">{message}</p>}
                </form>
            </div>
        </div>
    );
};
          // --- PÁGINA DE LISTADO: DEUDAS POR PAGAR (PROVEEDORES) ---
    const ProveedoresPage = () => {
        const { user } = useAuth();
        const { navigate } = useContext(AppContext);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [saldosData, setSaldosData] = useState({ proveedores: [], totalPagar: 0 });

        // Hook para leer TODOS los datos y calcular saldos de proveedores
        useEffect(() => {
            if (!user) return;

            const fetchSaldosProveedores = async () => {
                setLoading(true);
                setError('');
                try {
                    // 1. Definimos las 3 consultas
                    const qTerceros = query(
                        collection(db, 'users', user.uid, 'terceros'),
                        where("tipo", "in", ["Proveedor", "Ambos"]), // <-- CAMBIO: Filtro por Proveedor/Ambos
                        orderBy("nombre", "asc")
                    );
                    // <-- CAMBIO: Nuevas colecciones
                    const qFacturas = collection(db, 'users', user.uid, 'facturasCompra'); 
                    const qPagos = collection(db, 'users', user.uid, 'pagosRealizados');

                    // 2. Ejecutamos en paralelo
                    const [tercerosSnap, facturasSnap, pagosSnap] = await Promise.all([
                        getDocs(qTerceros),
                        getDocs(qFacturas),
                        getDocs(qPagos)
                    ]);

                    // 3. Procesamos
                    const terceros = tercerosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    const facturas = facturasSnap.docs.map(d => d.data());
                    const pagos = pagosSnap.docs.map(d => d.data());

                    // 4. Calculamos saldos (lógica idéntica, solo cambian las fuentes)
                    const saldosPorProveedor = {};
                    facturas.forEach(f => {
                        saldosPorProveedor[f.terceroId] = (saldosPorProveedor[f.terceroId] || 0) + f.montoTotal;
                    });
                    pagos.forEach(p => {
                        saldosPorProveedor[p.terceroId] = (saldosPorProveedor[p.terceroId] || 0) - p.montoPagado;
                    });

                    // 5. Unimos saldos con info de proveedores
                    const proveedores = terceros
                        .map(t => ({
                            ...t,
                            saldo: saldosPorProveedor[t.id] || 0
                        }))
                        .sort((a, b) => b.saldo - a.saldo);

                    // 6. Calculamos total general
                    const totalPagar = proveedores.reduce((sum, p) => sum + p.saldo, 0);

                    // 7. Guardamos en estado
                    setSaldosData({ proveedores, totalPagar });

                } catch (err) {
                    console.error("Error al calcular saldos de proveedores:", err);
                    setError('Error al calcular los saldos. ' + (err.message.includes('index') ? 'Podría faltar un índice en Firestore.' : ''));
                } finally {
                    setLoading(false);
                }
            };

            fetchSaldosProveedores();
        }, [user]);

        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

        return (
            <div>
                <div className="flex items-center gap-3 mb-6">
    <button 
        onClick={() => navigate('/gestion')} 
        className="p-2 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-900 transition-colors"
        title="Volver al Panel de Gestión"
    >
        <Icon name="ArrowLeft" className="w-6 h-6"/>
    </button>
    <h2 className="text-3xl font-bold text-gray-800">Deudas por Pagar (Proveedores)</h2>
</div>
                {error && <p className="text-red-600 bg-red-100 p-3 rounded mb-4">{error}</p>}

                {/* Tarjetas de Métricas */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div className="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                        <h3 className="text-lg font-semibold text-gray-600 mb-2">Total a Pagar</h3>
                        <p className="text-3xl font-bold text-red-600">{formatCurrency(saldosData.totalPagar)}</p>
                    </div>
                </div>

                {/* Tabla de Proveedores con Saldo */}
                <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                    <h3 className="text-xl font-bold mb-4">Lista de Proveedores y Afines</h3>
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Proveedor</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">CUIT</th>
                                <th className="px-6 py-3 text-right text-xs font-medium uppercase">Saldo Acreedor</th>
                                <th className="px-6 py-3 text-center text-xs font-medium uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {loading ? (
                                <tr><td colSpan="4" className="text-center py-10 text-gray-500">Calculando saldos...</td></tr>
                            ) : saldosData.proveedores.length > 0 ? (
                                saldosData.proveedores.map(proveedor => (
                                    <tr key={proveedor.id}>
                                        <td className="px-6 py-4 whitespace-nowrap font-medium">{proveedor.nombre}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{proveedor.cuit || '-'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right font-semibold text-gray-800">{formatCurrency(proveedor.saldo)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button
                                                onClick={() => navigate(`/gestion/proveedores/${proveedor.id}`)} // <-- CAMBIO: Nueva ruta
                                                className="text-indigo-600 hover:text-indigo-900"
                                            >
                                                Ver Cta. Cte.
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr><td colSpan="4" className="text-center py-10 text-gray-500">No hay terceros de tipo 'Proveedor' o 'Ambos' creados.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    };

    // --- PÁGINA DE DETALLE: CUENTA CORRIENTE PROVEEDOR ---
    const CuentaCorrienteProveedorPage = ({ terceroId }) => {
        const { user } = useAuth();
        const { navigate } = useContext(AppContext);
        const [terceroData, setTerceroData] = useState(null);
        const [movimientos, setMovimientos] = useState([]);
        const [loadingTercero, setLoadingTercero] = useState(true);
        const [loadingMov, setLoadingMov] = useState(true);
        const [error, setError] = useState('');
        const [isDeleting, setIsDeleting] = useState(false);
        const [movimientoAEditar, setMovimientoAEditar] = useState(null); 

        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Fecha inválida';
            return timestamp.toDate().toLocaleDateString('es-AR');
        };

        // Hook 1: Cargar datos del tercero (Proveedor)
        useEffect(() => {
            if (!user || !terceroId) return;
            setLoadingTercero(true);
            setError('');
            const docRef = doc(db, 'users', user.uid, 'terceros', terceroId);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    setTerceroData({ id: docSnap.id, ...docSnap.data() });
                } else {
                    setError(`No se encontró el tercero con ID: ${terceroId}`);
                    setTerceroData(null);
                }
                setLoadingTercero(false);
            }, (err) => {
                console.error("Error al leer datos del tercero:", err);
                setError('Error al cargar la información del proveedor.');
                setLoadingTercero(false);
            });
            return () => unsubscribe();
        }, [user, terceroId]);

        // Hook 2: Cargar movimientos (facturas de compra y pagos realizados)
        useEffect(() => {
            if (!user || !terceroId) return;
            setLoadingMov(true);

            // <-- CAMBIO: Nuevas colecciones
            const qFacturas = query(
                collection(db, 'users', user.uid, 'facturasCompra'),
                where("terceroId", "==", terceroId),
                orderBy("fechaEmision", "asc")
            );
            const qPagos = query(
                collection(db, 'users', user.uid, 'pagosRealizados'),
                where("terceroId", "==", terceroId),
                orderBy("fechaPago", "asc")
            );

            const unsubFacturas = onSnapshot(qFacturas, (facturasSnap) => {
                const facturas = facturasSnap.docs.map(d => ({ ...d.data(), id: d.id, tipoMovimiento: 'factura', fecha: d.data().fechaEmision }));
                
                const unsubPagos = onSnapshot(qPagos, (pagosSnap) => {
                    const pagos = pagosSnap.docs.map(d => ({ ...d.data(), id: d.id, tipoMovimiento: 'pago', fecha: d.data().fechaPago }));
                    
                    const movsCombinados = [...facturas, ...pagos].sort((a, b) => a.fecha.toMillis() - b.fecha.toMillis());
                    
                    // Lógica de saldo: Factura de Compra SUMA (aumenta deuda), Pago Realizado RESTA (disminuye deuda)
                    let saldoAcumulado = 0;
                    const movsConSaldo = movsCombinados.map(mov => {
                        if (mov.tipoMovimiento === 'factura') {
                            saldoAcumulado += mov.montoTotal; // Aumenta lo que debo
                        } else if (mov.tipoMovimiento === 'pago') {
                            saldoAcumulado -= mov.montoPagado; // Disminuye lo que debo
                        }
                        return { ...mov, saldoAcumulado };
                    });

                    setMovimientos(movsConSaldo);
                    setLoadingMov(false);
                }, (err) => {
                    console.error("Error al leer pagos realizados:", err);
                    setError('Error al cargar los pagos.');
                    setLoadingMov(false);
                });
                
                return () => unsubPagos();
            }, (err) => {
                console.error("Error al leer facturas de compra:", err);
                setError('Error al cargar las facturas.');
                setLoadingMov(false);
            });

            return () => unsubFacturas();
        }, [user, terceroId]);

        // Función de eliminar
        const handleDeleteMovimiento = async (mov) => {
            if (isDeleting) return;
            
            const tipoStr = mov.tipoMovimiento === 'factura' ? 'la factura de compra' : 'el pago realizado';
            // NOTA: window.confirm no funciona en este entorno, usamos lógica directa
            // if (!window.confirm(`¿Estás seguro de que deseas eliminar ${tipoStr}?`)) {
            //     return;
            // }

            setIsDeleting(true);
            try {
                const collectionName = mov.tipoMovimiento === 'factura' ? 'facturasCompra' : 'pagosRealizados';
                const docRef = doc(db, 'users', user.uid, collectionName, mov.id);
                await deleteDoc(docRef);
            } catch (err) {
                console.error("Error al eliminar el documento:", err);
                setError("Error al eliminar el movimiento. Inténtalo de nuevo.");
            } finally {
                setIsDeleting(false);
            }
        };

        const handleEditMovimiento = (mov) => {
            setMovimientoAEditar(mov);
        };

        const handleShowNuevoMovimiento = (tipo) => {
            if (tipo === 'factura') {
                setMovimientoAEditar({
                    tipoMovimiento: 'factura',
                    numeroComprobante: '',
                    fechaEmision: new Date().toISOString().split('T')[0],
                    fechaVencimiento: '',
                    montoTotal: 0,
                });
            } else if (tipo === 'pago') {
                setMovimientoAEditar({
                    tipoMovimiento: 'pago',
                    fechaPago: new Date().toISOString().split('T')[0],
                    montoPagado: 0,
                    medioDePago: 'Transferencia',
                    referencia: '',
                });
            }
        };

        const handleCloseModals = () => {
            setMovimientoAEditar(null);
        };

        const saldoFinal = movimientos.length > 0 ? movimientos[movimientos.length - 1].saldoAcumulado : 0;
        const loading = loadingTercero || loadingMov;

        return (
            <div>
                <button onClick={() => navigate('/gestion/proveedores')} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                    <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver a Proveedores
                </button>

                {loading && <p className="text-center">Cargando datos del proveedor...</p>}
                {error && <p className="text-red-600 bg-red-100 p-3 rounded mb-4">{error}</p>}

                {terceroData && (
                    <div className="bg-white p-8 rounded-lg shadow-md">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-3xl font-bold mb-2">Cuenta Corriente de: {terceroData.nombre}</h2>
                                <p className="text-gray-600">CUIT: {terceroData.cuit || 'N/A'}</p>
                            </div>
                            <div className="text-right">
                                <h3 className="text-lg font-semibold text-gray-600">Saldo a Pagar</h3>
                                <p className={`text-3xl font-bold ${saldoFinal > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                    {formatCurrency(saldoFinal)}
                                </p>
                            </div>
                        </div>

                        <hr className="my-6"/>

                        <div className="mb-6 flex gap-4">
                            <button
                                onClick={() => handleShowNuevoMovimiento('pago')}
                                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center">
                                <Icon name="DollarSign" className="w-5 h-5 mr-2"/>Registrar Pago Realizado
                            </button>
                            
                            <button 
                                onClick={() => handleShowNuevoMovimiento('factura')}
                                className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                <Icon name="FilePlus" className="w-5 h-5 mr-2"/>Cargar Factura de Compra
                            </button>
                        </div>
                        
                        <h3 className="text-xl font-bold mb-4">Movimientos</h3>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Fecha</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Concepto</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium uppercase">Facturas (Deuda)</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium uppercase">Pagos (Abonos)</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium uppercase">Saldo</th>
                                        <th className="px-6 py-3 text-center text-xs font-medium uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {loadingMov ? (
                                        <tr><td colSpan="6" className="text-center py-10 text-gray-500">Cargando movimientos...</td></tr>
                                    ) : movimientos.length > 0 ? (
                                        movimientos.map(mov => (
                                            <tr key={mov.id}>
                                                <td className="px-6 py-4 whitespace-nowrap">{formatDate(mov.fecha)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    {mov.tipoMovimiento === 'factura' ? `Factura Compra N° ${mov.numeroComprobante || ''}` : `Pago (${mov.medioDePago || ''})`}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-red-600">
                                                    {mov.tipoMovimiento === 'factura' ? formatCurrency(mov.montoTotal) : ''}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-green-600">
                                                    {mov.tipoMovimiento === 'pago' ? formatCurrency(mov.montoPagado) : ''}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right font-semibold">{formatCurrency(mov.saldoAcumulado)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center">
                                                    <button 
                                                        onClick={() => handleEditMovimiento(mov)}
                                                        className="text-blue-600 hover:text-blue-900 mr-3"
                                                        title="Modificar">
                                                        <Icon name="Edit" className="w-5 h-5"/>
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDeleteMovimiento(mov)} 
                                                        disabled={isDeleting}
                                                        className="text-red-600 hover:text-red-900 disabled:text-gray-400"
                                                        title="Eliminar">
                                                        <Icon name="Trash2" className="w-5 h-5"/>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr><td colSpan="6" className="text-center py-10 text-gray-500">No hay movimientos para este proveedor.</td></tr>
                                    )}
                                </tbody>
                                {movimientos.length > 0 && (
                                    <tfoot className="bg-gray-50">
                                        <tr>
                                            <td colSpan="5" className="px-6 py-4 text-right font-bold uppercase">Saldo Final a Pagar</td>
                                            <td className="px-6 py-4 text-right font-bold text-lg">{formatCurrency(saldoFinal)}</td>
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </div>
                )}
                
                {/* --- Modales para Proveedores --- */}
                <FacturaCompraModal
                    isOpen={movimientoAEditar?.tipoMovimiento === 'factura'}
                    onClose={handleCloseModals}
                    proveedorId={terceroId} // Renombrado para claridad
                    proveedorNombre={terceroData ? terceroData.nombre : 'Cargando...'}
                    movimiento={movimientoAEditar} 
                />

                <PagoRealizadoModal
                    isOpen={movimientoAEditar?.tipoMovimiento === 'pago'}
                    onClose={handleCloseModals}
                    proveedorId={terceroId} // Renombrado para claridad
                    proveedorNombre={terceroData ? terceroData.nombre : 'Cargando...'}
                    movimiento={movimientoAEditar}
                />
            </div>
        );
    };

    // --- MODAL PARA CARGAR NUEVA FACTURA DE COMPRA ---
    const FacturaCompraModal = ({ isOpen, onClose, proveedorId, proveedorNombre, movimiento }) => {
        const { user } = useAuth();
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [message, setMessage] = useState('');
        const isEditMode = movimiento && movimiento.id;

        const [formData, setFormData] = useState({
            numeroComprobante: '',
            fechaEmision: new Date().toISOString().split('T')[0],
            fechaVencimiento: '',
            montoTotal: '',
        });

        useEffect(() => {
            if (isOpen && movimiento) {
                setFormData({
                    numeroComprobante: movimiento.numeroComprobante || '',
                    fechaEmision: movimiento.fechaEmision?.toDate ? movimiento.fechaEmision.toDate().toISOString().split('T')[0] : (movimiento.fechaEmision || new Date().toISOString().split('T')[0]),
                    fechaVencimiento: movimiento.fechaVencimiento?.toDate ? movimiento.fechaVencimiento.toDate().toISOString().split('T')[0] : (movimiento.fechaVencimiento || ''),
                    montoTotal: movimiento.montoTotal || 0,
                });
                setIsSubmitting(false);
                setMessage('');
            }
        }, [isOpen, movimiento]);

        const handleChange = (e) => {
            const { name, value, type } = e.target;
            setFormData(prev => ({
                ...prev,
                [name]: type === 'number' ? (value === '' ? '' : parseFloat(value) || 0) : value
            }));
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (formData.montoTotal <= 0) {
                setMessage('Error: El monto total debe ser mayor a cero.');
                return;
            }
            if (!formData.fechaVencimiento) {
                setMessage('Error: Por favor, ingrese una fecha de vencimiento.');
                return;
            }
            
            setIsSubmitting(true);
            setMessage('');

            const dataToSave = {
                terceroId: proveedorId,
                numeroComprobante: formData.numeroComprobante,
                fechaEmision: Timestamp.fromDate(new Date(formData.fechaEmision + 'T00:00:00-03:00')),
                fechaVencimiento: Timestamp.fromDate(new Date(formData.fechaVencimiento + 'T00:00:00-03:00')),
                montoTotal: formData.montoTotal,
                saldoPendiente: formData.montoTotal,
                estado: 'Pendiente'
            };

            try {
                // <-- CAMBIO: Nueva colección
                const collectionName = 'facturasCompra';
                if (isEditMode) {
                    const docRef = doc(db, 'users', user.uid, collectionName, movimiento.id);
                    await updateDoc(docRef, dataToSave);
                } else {
                    const facturasCollectionRef = collection(db, 'users', user.uid, collectionName);
                    await addDoc(facturasCollectionRef, dataToSave);
                }
                setIsSubmitting(false);
                onClose();
            } catch (err) {
                console.error("Error al guardar la factura de compra:", err);
                setMessage('Error al guardar la factura. Inténtelo de nuevo.');
                setIsSubmitting(false);
            }
        };

        if (!isOpen) return null;

        return (
            <div className="modal-overlay fade-in">
                <div className="modal-content slide-in-bottom sm:max-w-lg">
                    <h2 className="text-2xl font-bold mb-4">{isEditMode ? 'Modificar' : 'Cargar'} Factura de Compra</h2>
                    <p className="mb-6 text-gray-600">Proveedor: <span className="font-semibold">{proveedorNombre}</span></p>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="label">N° Comprobante</label>
                            <input type="text" name="numeroComprobante" value={formData.numeroComprobante} onChange={handleChange} className="input" placeholder="Ej: 0001-00001234"/>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="label">Fecha Emisión</label>
                                <input type="date" name="fechaEmision" value={formData.fechaEmision} onChange={handleChange} required className="input"/>
                            </div>
                            <div>
                                <label className="label">Fecha Vencimiento</label>
                                <input type="date" name="fechaVencimiento" value={formData.fechaVencimiento} onChange={handleChange} required className="input"/>
                            </div>
                        </div>
                        
                        <div>
                            <label className="label">Monto Total</label>
                            <div className="relative">
                                <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                <input type="number" name="montoTotal" value={formData.montoTotal} onChange={handleChange} onFocus={(e) => e.target.select()} required className="input pl-7" min="0.01" step="0.01"/>
                            </div>
                        </div>

                        {message && <p className={`text-center ${message.startsWith('Error') ? 'text-red-500' : 'text-green-500'}`}>{message}</p>}
                        
                        <div className="flex justify-end gap-4 pt-4">
                            <button type="button" onClick={onClose} className="btn-secondary">Cancelar</button>
                            <button type="submit" disabled={isSubmitting} className="btn-primary">
                                {isSubmitting ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Guardar Factura')}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };
    // --- MODAL PARA REGISTRAR NUEVO PAGO REALIZADO (A PROVEEDOR) ---
// ---- CORRECCIÓN: Se cambian props de 'cliente' a 'proveedor' ----
const PagoRealizadoModal = ({ isOpen, onClose, proveedorId, proveedorNombre, movimiento }) => {
    const { user } = useAuth();
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [message, setMessage] = useState('');
    const isEditMode = movimiento && movimiento.id;

    const [formData, setFormData] = useState({
        fechaPago: new Date().toISOString().split('T')[0],
        montoPagado: '',
        medioDePago: 'Transferencia',
        referencia: '',
        chequeNumero: '',
        chequeBanco: '',
        chequeFechaVencimiento: '',
    });

    useEffect(() => {
        if (isOpen && movimiento) {
            setFormData({
                fechaPago: movimiento.fechaPago?.toDate ? movimiento.fechaPago.toDate().toISOString().split('T')[0] : (movimiento.fechaPago || new Date().toISOString().split('T')[0]),
                montoPagado: movimiento.montoPagado || 0,
                medioDePago: movimiento.medioDePago || 'Transferencia',
                referencia: movimiento.referencia || '',
                chequeNumero: '',
                chequeBanco: '',
                chequeFechaVencimiento: '',
            });
            setIsSubmitting(false);
            setMessage('');
        }
    }, [isOpen, movimiento]);

    const handleChange = (e) => {
        const { name, value, type } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: type === 'number' ? (value === '' ? '' : parseFloat(value) || 0) : value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (formData.montoPagado <= 0) {
            setMessage('Error: El monto pagado debe ser mayor a cero.');
            return;
        }
        
        if (formData.medioDePago === 'Cheque' && !isEditMode) {
            if (!formData.chequeNumero || !formData.chequeBanco || !formData.chequeFechaVencimiento) {
                setMessage('Error: Para pagos con cheque, debe completar N°, Banco y Fecha de Vencimiento.');
                return;
            }
        }
        
        setIsSubmitting(true);
        setMessage('');

        const dataToSave = {
            // ---- CORRECCIÓN: Se usa 'proveedorId' ----
            terceroId: proveedorId,
            fechaPago: Timestamp.fromDate(new Date(formData.fechaPago + 'T00:00:00-03:00')),
            montoPagado: formData.montoPagado,
            medioDePago: formData.medioDePago,
            referencia: formData.referencia || '',
        };

        try {
            if (isEditMode) {
                const docRef = doc(db, 'users', user.uid, 'pagosRealizados', movimiento.id);
                await updateDoc(docRef, dataToSave);
            } else {
                const pagosCollectionRef = collection(db, 'users', user.uid, 'pagosRealizados');
                const docRef = await addDoc(pagosCollectionRef, dataToSave); 

                if (formData.medioDePago === 'Cheque') {
                    const chequeData = {
                        // ---- CORRECCIÓN: Se usa 'proveedorId' y 'proveedorNombre' ----
                        terceroId: proveedorId,
                        terceroNombre: proveedorNombre,
                        tipo: 'emitido', 
                        estado: 'Emitido',
                        numero: formData.chequeNumero,
                        banco: formData.chequeBanco,
                        fechaVencimiento: Timestamp.fromDate(new Date(formData.chequeFechaVencimiento + 'T00:00:00-03:00')),
                        fechaEmision: Timestamp.fromDate(new Date(formData.fechaPago + 'T00:00:00-03:00')),
                        monto: formData.montoPagado,
                        pagoId: docRef.id 
                    };
                    await addDoc(collection(db, 'users', user.uid, 'cheques'), chequeData);
                }
            }

            setIsSubmitting(false);
            onClose(); 

        } catch (err) {
            console.error("Error al guardar el pago:", err);
            setMessage('Error al guardar el pago. Inténtelo de nuevo.');
            setIsSubmitting(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay fade-in">
            <div className="modal-content slide-in-bottom sm:max-w-lg">
                <h2 className="text-2xl font-bold mb-4">{isEditMode ? 'Modificar' : 'Registrar'} Pago Realizado</h2>
                {/* ---- CORRECCIÓN: Se usa 'proveedorNombre' ---- */}
                <p className="mb-6 text-gray-600">Proveedor: <span className="font-semibold">{proveedorNombre}</span></p>
                
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="label">Fecha de Pago</label>
                            <input type="date" name="fechaPago" value={formData.fechaPago} onChange={handleChange} required className="input"/>
                        </div>
                        <div>
                            <label className="label">Monto Pagado</label>
                            <div className="relative">
                                <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                <input type="number" name="montoPagado" value={formData.montoPagado} onChange={handleChange} onFocus={(e) => e.target.select()} required className="input pl-7" min="0.01" step="0.01"/>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label className="label">Medio de Pago</label>
                        <select name="medioDePago" value={formData.medioDePago} onChange={handleChange} className="input" disabled={isEditMode}>
                            <option>Transferencia</option>
                            <option>Efectivo</option>
                            <option>Cheque</option>
                            <option>Otro</option>
                        </select>
                        {isEditMode && movimiento.medioDePago === 'Cheque' && <p className="text-sm text-gray-500 mt-2">La edición de pagos con cheques asociados no está habilitada. Gestione el cheque desde el módulo de Cheques.</p>}
                    </div>

                    {formData.medioDePago === 'Cheque' && !isEditMode && (
                        <div className="space-y-4 p-4 border rounded-md bg-gray-50 fade-in">
                            <h4 className="font-semibold">Datos del Cheque Emitido</h4>
                            <div>
                                <label className="label">N° de Cheque</label>
                                <input type="text" name="chequeNumero" value={formData.chequeNumero} onChange={handleChange} className="input" placeholder="00012345"/>
                            </div>
                            <div>
                                <label className="label">Banco (Tu banco)</label>
                                <input type="text" name="chequeBanco" value={formData.chequeBanco} onChange={handleChange} className="input" placeholder="Ej: Banco Macro"/>
                            </div>
                            <div>
                                <label className="label">Fecha Vencimiento Cheque</label>
                                <input type="date" name="chequeFechaVencimiento" value={formData.chequeFechaVencimiento} onChange={handleChange} className="input"/>
                            </div>
                        </div>
                    )}

                    <div>
                        <label className="label">Referencia (Opcional)</label>
                        <input type="text" name="referencia" value={formData.referencia} onChange={handleChange} className="input" placeholder="N° de transferencia, etc."/>
                    </div>

                    {message && <p className={`text-center ${message.startsWith('Error') ? 'text-red-500' : 'text-green-500'}`}>{message}</p>}
                    
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="btn-secondary">Cancelar</button>
                        <button type="submit" disabled={isSubmitting} className="btn-primary-green">
                            {isSubmitting ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Guardar Pago')}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

      // --- PÁGINA DE DETALLE: CUENTA CORRIENTE CLIENTE ---
    const CuentaCorrienteClientePage = ({ terceroId }) => {
        const { user } = useAuth();
        const { navigate } = useContext(AppContext);
        const [terceroData, setTerceroData] = useState(null);
        const [movimientos, setMovimientos] = useState([]);
        const [loadingTercero, setLoadingTercero] = useState(true);
        const [loadingMov, setLoadingMov] = useState(true);
        const [error, setError] = useState('');
        const [isDeleting, setIsDeleting] = useState(false); // Para evitar doble click
        
        // --- CAMBIO: Un solo estado para manejar todos los modales ---
        const [movimientoAEditar, setMovimientoAEditar] = useState(null); 

        const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Fecha inválida';
            return timestamp.toDate().toLocaleDateString('es-AR');
        };

        // Hook 1: Cargar datos del tercero específico (Sin cambios)
        useEffect(() => {
            if (!user || !terceroId) return;
            setLoadingTercero(true);
            setError('');
            const docRef = doc(db, 'users', user.uid, 'terceros', terceroId);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    setTerceroData({ id: docSnap.id, ...docSnap.data() });
                } else {
                    setError(`No se encontró el tercero con ID: ${terceroId}`);
                    setTerceroData(null);
                }
                setLoadingTercero(false);
            }, (err) => {
                console.error("Error al leer datos del tercero:", err);
                setError('Error al cargar la información del cliente.');
                setLoadingTercero(false);
            });
            return () => unsubscribe();
        }, [user, terceroId]);

        // Hook 2: Cargar movimientos (facturas y pagos) del tercero (Sin cambios)
        useEffect(() => {
            if (!user || !terceroId) return;
            setLoadingMov(true);

            const qFacturas = query(
                collection(db, 'users', user.uid, 'facturasVenta'),
                where("terceroId", "==", terceroId),
                orderBy("fechaEmision", "asc")
            );
            const qPagos = query(
                collection(db, 'users', user.uid, 'pagosRecibidos'),
                where("terceroId", "==", terceroId),
                orderBy("fechaPago", "asc")
            );

            const unsubFacturas = onSnapshot(qFacturas, (facturasSnap) => {
                const facturas = facturasSnap.docs.map(d => ({ ...d.data(), id: d.id, tipoMovimiento: 'factura', fecha: d.data().fechaEmision }));
                
                const unsubPagos = onSnapshot(qPagos, (pagosSnap) => {
                    const pagos = pagosSnap.docs.map(d => ({ ...d.data(), id: d.id, tipoMovimiento: 'pago', fecha: d.data().fechaPago }));
                    
                    const movsCombinados = [...facturas, ...pagos].sort((a, b) => a.fecha.toMillis() - b.fecha.toMillis());
                    
                    let saldoAcumulado = 0;
                    const movsConSaldo = movsCombinados.map(mov => {
                        if (mov.tipoMovimiento === 'factura') {
                            saldoAcumulado += mov.montoTotal;
                        } else if (mov.tipoMovimiento === 'pago') {
                            saldoAcumulado -= mov.montoPagado;
                        }
                        return { ...mov, saldoAcumulado };
                    });

                    setMovimientos(movsConSaldo);
                    setLoadingMov(false);
                }, (err) => {
                    console.error("Error al leer pagos:", err);
                    setError('Error al cargar los pagos.');
                    setLoadingMov(false);
                });
                
                return () => unsubPagos();
            }, (err) => {
                console.error("Error al leer facturas:", err);
                setError('Error al cargar las facturas.');
                setLoadingMov(false);
            });

            return () => unsubFacturas();
        }, [user, terceroId]);

        // Función de eliminar (Sin cambios)
        const handleDeleteMovimiento = async (mov) => {
            if (isDeleting) return;
            
            const tipoStr = mov.tipoMovimiento === 'factura' ? 'la factura' : 'el pago';
            if (!window.confirm(`¿Estás seguro de que deseas eliminar ${tipoStr}? Esta acción no se puede deshacer.`)) {
                return;
            }

            setIsDeleting(true);
            try {
                const collectionName = mov.tipoMovimiento === 'factura' ? 'facturasVenta' : 'pagosRecibidos';
                const docRef = doc(db, 'users', user.uid, collectionName, mov.id);
                await deleteDoc(docRef);
            } catch (err) {
                console.error("Error al eliminar el documento:", err);
                setError("Error al eliminar el movimiento. Inténtalo de nuevo.");
            } finally {
                setIsDeleting(false);
            }
        };

        // --- CAMBIO: Nuevas funciones para abrir los modales ---
        const handleEditMovimiento = (mov) => {
            setMovimientoAEditar(mov);
        };

        const handleShowNuevoMovimiento = (tipo) => {
            if (tipo === 'factura') {
                setMovimientoAEditar({
                    tipoMovimiento: 'factura',
                    numeroComprobante: '',
                    fechaEmision: new Date().toISOString().split('T')[0],
                    fechaVencimiento: '',
                    montoTotal: 0,
                });
            } else if (tipo === 'pago') {
                setMovimientoAEditar({
                    tipoMovimiento: 'pago',
                    fechaPago: new Date().toISOString().split('T')[0],
                    montoPagado: 0,
                    medioDePago: 'Transferencia',
                    referencia: '',
                });
            }
        };

        const handleCloseModals = () => {
            setMovimientoAEditar(null);
        };

        const saldoFinal = movimientos.length > 0 ? movimientos[movimientos.length - 1].saldoAcumulado : 0;
        const loading = loadingTercero || loadingMov;

        return (
            <div>
                <button onClick={() => navigate('/gestion/deudores')} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                    <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver a Deudores
                </button>

                {loading && <p className="text-center">Cargando datos del cliente...</p>}
                {error && <p className="text-red-600 bg-red-100 p-3 rounded mb-4">{error}</p>}

                {terceroData && (
                    <div className="bg-white p-8 rounded-lg shadow-md">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-3xl font-bold mb-2">Cuenta Corriente de: {terceroData.nombre}</h2>
                                <p className="text-gray-600">CUIT: {terceroData.cuit || 'N/A'}</p>
                            </div>
                            <div className="text-right">
                                <h3 className="text-lg font-semibold text-gray-600">Saldo Actual</h3>
                                <p className={`text-3xl font-bold ${saldoFinal > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                    {formatCurrency(saldoFinal)}
                                </p>
                            </div>
                        </div>

                        <hr className="my-6"/>

                        {/* --- CAMBIO: Botones de acción actualizados --- */}
                        <div className="mb-6 flex gap-4">
                            <button
                                onClick={() => handleShowNuevoMovimiento('pago')}
                                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center">
                                <Icon name="DollarSign" className="w-5 h-5 mr-2"/>Registrar Pago
                            </button>
                            
                            <button 
                                onClick={() => handleShowNuevoMovimiento('factura')}
                                className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                <Icon name="FilePlus" className="w-5 h-5 mr-2"/>Cargar Factura
                            </button>
                        </div>
                        
                        <h3 className="text-xl font-bold mb-4">Movimientos</h3>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Fecha</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Concepto</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium uppercase">Debe</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium uppercase">Haber</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium uppercase">Saldo</th>
                                        <th className="px-6 py-3 text-center text-xs font-medium uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {loadingMov ? (
                                        <tr><td colSpan="6" className="text-center py-10 text-gray-500">Cargando movimientos...</td></tr>
                                    ) : movimientos.length > 0 ? (
                                        movimientos.map(mov => (
                                            <tr key={mov.id}>
                                                <td className="px-6 py-4 whitespace-nowrap">{formatDate(mov.fecha)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    {mov.tipoMovimiento === 'factura' ? `Factura N° ${mov.numeroComprobante || ''}` : `Pago (${mov.medioDePago || ''})`}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-red-600">
                                                    {mov.tipoMovimiento === 'factura' ? formatCurrency(mov.montoTotal) : ''}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-green-600">
                                                    {mov.tipoMovimiento === 'pago' ? formatCurrency(mov.montoPagado) : ''}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right font-semibold">{formatCurrency(mov.saldoAcumulado)}</td>
                                                
                                            {/* --- CAMBIO: Botón de Modificar activado --- */}
                                                <td className="px-6 py-4 whitespace-nowrap text-center">
                                                    <button 
                                                        onClick={() => handleEditMovimiento(mov)}
                                                        className="text-blue-600 hover:text-blue-900 mr-3"
                                                        title="Modificar">
                                                        <Icon name="Edit" className="w-5 h-5"/>
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDeleteMovimiento(mov)} 
                                                        disabled={isDeleting}
                                                        className="text-red-600 hover:text-red-900 disabled:text-gray-400"
                                                        title="Eliminar">
                                                        <Icon name="Trash2" className="w-5 h-5"/>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr><td colSpan="6" className="text-center py-10 text-gray-500">No hay movimientos para este cliente.</td></tr>
                                    )}
                                </tbody>
                                {movimientos.length > 0 && (
                                    <tfoot className="bg-gray-50">
                                        <tr>
                                            <td colSpan="5" className="px-6 py-4 text-right font-bold uppercase">Saldo Final</td>
                                            <td className="px-6 py-4 text-right font-bold text-lg">{formatCurrency(saldoFinal)}</td>
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </div>
                )}
                
                {/* --- CAMBIO: Lógica de renderizado de modales actualizada --- */}
                <FacturaVentaModal
                    isOpen={movimientoAEditar?.tipoMovimiento === 'factura'}
                    onClose={handleCloseModals}
                    clienteId={terceroId}
                    clienteNombre={terceroData ? terceroData.nombre : 'Cargando...'}
                    movimiento={movimientoAEditar} 
                />

                <PagoRecibidoModal
                    isOpen={movimientoAEditar?.tipoMovimiento === 'pago'}
                    onClose={handleCloseModals}
                    clienteId={terceroId}
                    clienteNombre={terceroData ? terceroData.nombre : 'Cargando...'}
                    movimiento={movimientoAEditar}
                />
            </div>
        );
    };
        // --- MODAL PARA CARGAR NUEVA FACTURA DE VENTA ---
      const FacturaVentaModal = ({ isOpen, onClose, clienteId, clienteNombre, movimiento }) => {
          const { user } = useAuth();
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [message, setMessage] = useState('');
          // --- CAMBIO: isEditMode se calcula basado en el 'movimiento' recibido ---
          const isEditMode = movimiento && movimiento.id;

          const [formData, setFormData] = useState({
              numeroComprobante: '',
              fechaEmision: new Date().toISOString().split('T')[0],
              fechaVencimiento: '',
              montoTotal: '',
          });

          // --- CAMBIO: useEffect ahora rellena el formulario si estamos en modo edición ---
          useEffect(() => {
              if (isOpen && movimiento) {
                  setFormData({
                      numeroComprobante: movimiento.numeroComprobante || '',
                      // Maneja Timestamps (modo edición) y Strings (modo nuevo)
                      fechaEmision: movimiento.fechaEmision?.toDate ? movimiento.fechaEmision.toDate().toISOString().split('T')[0] : (movimiento.fechaEmision || new Date().toISOString().split('T')[0]),
                      fechaVencimiento: movimiento.fechaVencimiento?.toDate ? movimiento.fechaVencimiento.toDate().toISOString().split('T')[0] : (movimiento.fechaVencimiento || ''),
                      montoTotal: movimiento.montoTotal || 0,
                  });
                  setIsSubmitting(false);
                  setMessage('');
              }
          }, [isOpen, movimiento]);

          const handleChange = (e) => {
              const { name, value, type } = e.target;
              setFormData(prev => ({
                  ...prev,
                  [name]: type === 'number' ? (value === '' ? '' : parseFloat(value) || 0) : value
              }));
          };

          // --- CAMBIO: handleSubmit ahora maneja lógica de Edición (updateDoc) y Creación (addDoc) ---
          const handleSubmit = async (e) => {
              e.preventDefault();
              if (formData.montoTotal <= 0) {
                  setMessage('Error: El monto total debe ser mayor a cero.');
                  return;
              }
              if (!formData.fechaVencimiento) {
                  setMessage('Error: Por favor, ingrese una fecha de vencimiento.');
                  return;
              }
              
              setIsSubmitting(true);
              setMessage('');

              const dataToSave = {
                  terceroId: clienteId,
                  numeroComprobante: formData.numeroComprobante,
                  fechaEmision: Timestamp.fromDate(new Date(formData.fechaEmision + 'T00:00:00-03:00')),
                  fechaVencimiento: Timestamp.fromDate(new Date(formData.fechaVencimiento + 'T00:00:00-03:00')),
                  montoTotal: formData.montoTotal,
                  saldoPendiente: formData.montoTotal, // Se actualiza/setea el saldo
                  estado: 'Pendiente'
              };

              try {
                  if (isEditMode) {
                      // Lógica de Edición
                      const docRef = doc(db, 'users', user.uid, 'facturasVenta', movimiento.id);
                      await updateDoc(docRef, dataToSave);
                  } else {
                      // Lógica de Creación (la que ya tenías)
                      const facturasCollectionRef = collection(db, 'users', user.uid, 'facturasVenta');
                      await addDoc(facturasCollectionRef, dataToSave);
                  }

                  setIsSubmitting(false);
                  onClose(); // Cierra el modal

              } catch (err) {
                  console.error("Error al guardar la factura:", err);
                  setMessage('Error al guardar la factura. Inténtelo de nuevo.');
                  setIsSubmitting(false);
              }
          };

          if (!isOpen) return null;

          return (
              <div className="modal-overlay fade-in">
                  <div className="modal-content slide-in-bottom sm:max-w-lg">
                  {/* --- CAMBIO: Título dinámico --- */}
                      <h2 className="text-2xl font-bold mb-4">{isEditMode ? 'Modificar' : 'Cargar'} Factura de Venta</h2>
                      <p className="mb-6 text-gray-600">Cliente: <span className="font-semibold">{clienteNombre}</span></p>
                      
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label className="label">N° Comprobante</label>
                              <input type="text" name="numeroComprobante" value={formData.numeroComprobante} onChange={handleChange} className="input" placeholder="Ej: 0001-00001234"/>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                  <label className="label">Fecha Emisión</label>
                                  <input type="date" name="fechaEmision" value={formData.fechaEmision} onChange={handleChange} required className="input"/>
                              </div>
                              <div>
                                  <label className="label">Fecha Vencimiento</label>
                                  <input type="date" name="fechaVencimiento" value={formData.fechaVencimiento} onChange={handleChange} required className="input"/>
                              </div>
                          </div>
                          
                          <div>
                              <label className="label">Monto Total</label>
                              <div className="relative">
                                  <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                  <input type="number" name="montoTotal" value={formData.montoTotal} onChange={handleChange} onFocus={(e) => e.target.select()} required className="input pl-7" min="0.01" step="0.01"/>
                              </div>
                          </div>

                          {message && <p className={`text-center ${message.startsWith('Error') ? 'text-red-500' : 'text-green-500'}`}>{message}</p>}
                          
                          <div className="flex justify-end gap-4 pt-4">
                              <button type="button" onClick={onClose} className="btn-secondary">Cancelar</button>
                              <button type="submit" disabled={isSubmitting} className="btn-primary">
                                  {/* --- CAMBIO: Texto de botón dinámico --- */}
                                  {isSubmitting ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Guardar Factura')}
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };
      // --- MODAL PARA REGISTRAR NUEVO PAGO RECIBIDO ---
const PagoRecibidoModal = ({ isOpen, onClose, clienteId, clienteNombre, movimiento }) => {
    const { user } = useAuth();
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [message, setMessage] = useState('');
    const isEditMode = movimiento && movimiento.id;

    const [formData, setFormData] = useState({
        fechaPago: new Date().toISOString().split('T')[0],
        montoPagado: '',
        medioDePago: 'Transferencia',
        referencia: '',
        // --- NUEVOS CAMPOS PARA CHEQUE ---
        chequeNumero: '',
        chequeBanco: '',
        chequeFechaVencimiento: '',
    });

    useEffect(() => {
        if (isOpen && movimiento) {
            setFormData({
                fechaPago: movimiento.fechaPago?.toDate ? movimiento.fechaPago.toDate().toISOString().split('T')[0] : (movimiento.fechaPago || new Date().toISOString().split('T')[0]),
                montoPagado: movimiento.montoPagado || 0,
                medioDePago: movimiento.medioDePago || 'Transferencia',
                referencia: movimiento.referencia || '',
                // --- RESETEAMOS CAMPOS CHEQUE ---
                chequeNumero: '',
                chequeBanco: '',
                chequeFechaVencimiento: '',
            });
            setIsSubmitting(false);
            setMessage('');
        }
    }, [isOpen, movimiento]);

    const handleChange = (e) => {
        const { name, value, type } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: type === 'number' ? (value === '' ? '' : parseFloat(value) || 0) : value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (formData.montoPagado <= 0) {
            setMessage('Error: El monto pagado debe ser mayor a cero.');
            return;
        }
        
        // --- NUEVA VALIDACIÓN PARA CHEQUES (Solo al crear) ---
        if (formData.medioDePago === 'Cheque' && !isEditMode) {
            if (!formData.chequeNumero || !formData.chequeBanco || !formData.chequeFechaVencimiento) {
                setMessage('Error: Para pagos con cheque, debe completar N°, Banco y Fecha de Vencimiento.');
                return;
            }
        }
        
        setIsSubmitting(true);
        setMessage('');

        const dataToSave = {
            terceroId: clienteId,
            fechaPago: Timestamp.fromDate(new Date(formData.fechaPago + 'T00:00:00-03:00')),
            montoPagado: formData.montoPagado,
            medioDePago: formData.medioDePago,
            referencia: formData.referencia || '',
        };

        try {
            if (isEditMode) {
                // Lógica de Edición (No se modifica el cheque asociado)
                const docRef = doc(db, 'users', user.uid, 'pagosRecibidos', movimiento.id);
                await updateDoc(docRef, dataToSave);
            } else {
                // Lógica de Creación
                const pagosCollectionRef = collection(db, 'users', user.uid, 'pagosRecibidos');
                const docRef = await addDoc(pagosCollectionRef, dataToSave); // Obtenemos la ref del nuevo pago

                // --- NUEVA LÓGICA: GUARDAR CHEQUE ---
                if (formData.medioDePago === 'Cheque') {
                    const chequeData = {
                        terceroId: clienteId,
                        terceroNombre: clienteNombre,
                        tipo: 'recibido', // Cheque de cliente
                        estado: 'En Cartera',
                        numero: formData.chequeNumero,
                        banco: formData.chequeBanco,
                        fechaVencimiento: Timestamp.fromDate(new Date(formData.chequeFechaVencimiento + 'T00:00:00-03:00')),
                        fechaRecepcion: Timestamp.fromDate(new Date(formData.fechaPago + 'T00:00:00-03:00')),
                        monto: formData.montoPagado,
                        pagoId: docRef.id // Vinculamos el cheque al pago
                    };
                    // Creamos el doc en la colección 'cheques'
                    await addDoc(collection(db, 'users', user.uid, 'cheques'), chequeData);
                }
            }

            setIsSubmitting(false);
            onClose(); // Cierra el modal

        } catch (err) {
            console.error("Error al guardar el pago:", err);
            setMessage('Error al guardar el pago. Inténtelo de nuevo.');
            setIsSubmitting(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay fade-in">
            <div className="modal-content slide-in-bottom sm:max-w-lg">
                <h2 className="text-2xl font-bold mb-4">{isEditMode ? 'Modificar' : 'Registrar'} Pago Recibido</h2>
                <p className="mb-6 text-gray-600">Cliente: <span className="font-semibold">{clienteNombre}</span></p>
                
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="label">Fecha de Pago</label>
                            <input type="date" name="fechaPago" value={formData.fechaPago} onChange={handleChange} required className="input"/>
                        </div>
                        <div>
                            <label className="label">Monto Pagado</label>
                            <div className="relative">
                                <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                <input type="number" name="montoPagado" value={formData.montoPagado} onChange={handleChange} onFocus={(e) => e.target.select()} required className="input pl-7" min="0.01" step="0.01"/>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label className="label">Medio de Pago</label>
                        {/* --- CAMBIO: Deshabilitamos edición de cheque --- */}
                        <select name="medioDePago" value={formData.medioDePago} onChange={handleChange} className="input" disabled={isEditMode}>
                            <option>Transferencia</option>
                            <option>Efectivo</option>
                            <option>Cheque</option>
                            <option>Otro</option>
                        </select>
                        {isEditMode && movimiento.medioDePago === 'Cheque' && <p className="text-sm text-gray-500 mt-2">La edición de pagos con cheques asociados no está habilitada. Gestione el cheque desde el módulo de Cheques.</p>}
                    </div>

                    {/* --- NUEVOS CAMPOS (Solo al crear) --- */}
                    {formData.medioDePago === 'Cheque' && !isEditMode && (
                        <div className="space-y-4 p-4 border rounded-md bg-gray-50 fade-in">
                            <h4 className="font-semibold">Datos del Cheque Recibido</h4>
                            <div>
                                <label className="label">N° de Cheque</label>
                                <input type="text" name="chequeNumero" value={formData.chequeNumero} onChange={handleChange} className="input" placeholder="00012345"/>
                            </div>
                            <div>
                                <label className="label">Banco</label>
                                <input type="text" name="chequeBanco" value={formData.chequeBanco} onChange={handleChange} className="input" placeholder="Ej: Banco Galicia"/>
                            </div>
                            <div>
                                <label className="label">Fecha Vencimiento Cheque</label>
                                <input type="date" name="chequeFechaVencimiento" value={formData.chequeFechaVencimiento} onChange={handleChange} className="input"/>
                            </div>
                        </div>
                    )}

                    <div>
                        <label className="label">Referencia (Opcional)</label>
                        <input type="text" name="referencia" value={formData.referencia} onChange={handleChange} className="input" placeholder="N° de transferencia, etc."/>
                    </div>

                    {message && <p className={`text-center ${message.startsWith('Error') ? 'text-red-500' : 'text-green-500'}`}>{message}</p>}
                    
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="btn-secondary">Cancelar</button>
                        <button type="submit" disabled={isSubmitting} className="btn-primary-green">
                            {isSubmitting ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Guardar Pago')}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
        
        const BillingRequestsPage = () => {
            const { user, userData } = useAuth();
            // const { db, storage } = useFirebase(); 

            const [requests, setRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [filterStatus, setFilterStatus] = useState('pending'); 
            const [expandedRowId, setExpandedRowId] = useState(null); 
            const [selectedClient, setSelectedClient] = useState('todos');

            // --- LÓGICA DE AÑOS AUTOMÁTICA ---
            // Detectamos el año actual y generamos las opciones (Año actual + 2 anteriores)
            const currentYear = new Date().getFullYear();
            const availableYears = [currentYear, currentYear - 1, currentYear - 2];

            // Estados Carga
            const [createMode, setCreateMode] = useState('file'); 
            const [manualData, setManualData] = useState({
                monto: '', 
                fecha: new Date().toISOString().split('T')[0], 
                concepto: 'Pago en Efectivo', 
                nombreCliente: '', 
                cuitCliente: '' 
            });

            const [newRequestFile, setNewRequestFile] = useState(null);
            const [newRequestNote, setNewRequestNote] = useState('');
            const [uploading, setUploading] = useState(false);
            const [isZipping, setIsZipping] = useState(false);

            // Estados Auxiliares
            const [completingId, setCompletingId] = useState(null);
            const [invoiceFile, setInvoiceFile] = useState(null);
            const [requestToDelete, setRequestToDelete] = useState(null);
            const [editingRequest, setEditingRequest] = useState(null);
            const [editFormData, setEditFormData] = useState({});

            // 1. SEGURIDAD
            if (!loading && !userData?.isAdmin && !userData?.servicioFacturacion) {
                return <div className="p-10 text-center"><h2 className="text-2xl font-bold text-gray-800">Acceso Restringido</h2></div>;
            }

            // 2. LECTURA
            useEffect(() => {
                if (!user) return;
                setLoading(true);
                let q;
                if (userData?.isAdmin) {
                    q = query(collection(db, 'billing_requests'), orderBy('status', 'desc'), orderBy('timestamp', 'desc'));
                } else {
                    q = query(collection(db, 'billing_requests'), where('userId', '==', user.uid), orderBy('timestamp', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRequests(docs);
                    setLoading(false);
                }, (error) => setLoading(false));
                return () => unsubscribe();
            }, [user, userData]);

            // 3. FILTROS
            const visibleRequests = useMemo(() => {
                if (userData?.isAdmin) {
                    return requests.filter(req => req.userModoFacturacion !== 'cliente');
                }
                return requests;
            }, [requests, userData]);

            // --- CEREBRO DE UNIFICACIÓN (NOMBRES) ---
            const clientDictionary = useMemo(() => {
                const dict = {}; 
                visibleRequests.forEach(req => {
                    const rawCuit = req.aiData?.cuit_receptor || '';
                    const cuit = rawCuit.replace(/\D/g, ''); 
                    const name = req.aiData?.nombre_receptor || 'Desconocido';
                    if (cuit && cuit.length > 5) {
                        if (!dict[cuit] || name.length > dict[cuit].length) {
                            dict[cuit] = name;
                        }
                    }
                });
                return dict;
            }, [visibleRequests]);

            // --- CEREBRO DE UNIFICACIÓN (TELÉFONOS) ---
            const clientPhoneDictionary = useMemo(() => {
                const dict = {}; 
                visibleRequests.forEach(req => {
                    const rawCuit = req.aiData?.cuit_receptor || '';
                    const cuit = rawCuit.replace(/\D/g, ''); 
                    if (cuit && cuit.length > 5 && req.userPhone) {
                        if (!dict[cuit]) {
                            dict[cuit] = req.userPhone;
                        }
                    }
                });
                return dict;
            }, [visibleRequests]);

            const getUnifiedName = (req) => {
                const rawCuit = req.aiData?.cuit_receptor || '';
                const cuit = rawCuit.replace(/\D/g, '');
                const originalName = req.aiData?.nombre_receptor || 'Desconocido';
                if (cuit && clientDictionary[cuit]) return clientDictionary[cuit];
                return originalName;
            };

            const uniqueClients = useMemo(() => {
                const names = new Set();
                visibleRequests.forEach(req => {
                    const unifiedName = getUnifiedName(req);
                    if (unifiedName && unifiedName !== 'Carga Manual' && unifiedName !== 'Desconocido') {
                        names.add(unifiedName);
                    }
                });
                return Array.from(names).sort();
            }, [visibleRequests, clientDictionary]);

            const filteredRequests = useMemo(() => {
    let data = visibleRequests;
    if (selectedClient !== 'todos') {
        data = data.filter(req => getUnifiedName(req) === selectedClient);
    }

    if (filterStatus === 'completed') {
        // MODIFICACIÓN: Filtramos y cortamos para mostrar solo los últimos 30
        return data.filter(r => r.status === 'completed').slice(0, 30);
    } else {
        // Para pendientes dejamos que se vean todos, así no se te escapa ninguno por facturar
        return data.filter(r => r.status !== 'completed');
    }
}, [visibleRequests, selectedClient, filterStatus, clientDictionary]);

            // 4. MÉTRICAS
            const metrics = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                let baseData = visibleRequests;
                if (selectedClient !== 'todos') {
                    baseData = baseData.filter(req => getUnifiedName(req) === selectedClient);
                }
                const reqs = baseData.filter(req => req.timestamp && req.timestamp.toDate().getMonth() === currentMonth && req.timestamp.toDate().getFullYear() === currentYear);
                return {
                    totalFacturado: reqs.filter(r => r.status === 'completed').reduce((sum, r) => sum + (r.aiData?.monto_total || 0), 0),
                    totalPendiente: reqs.filter(r => r.status !== 'completed' && r.status !== 'duplicate').reduce((sum, r) => sum + (r.aiData?.monto_total || 0), 0)
                };
            }, [visibleRequests, selectedClient, clientDictionary]);

            // --- 5. DESCARGA ZIP INTELIGENTE (AUDITORÍA TOTAL) ---
            const downloadYearlyBackup = async (year) => {
                if (!window.JSZip) return alert("Librería JSZip no cargada.");
                
                const confirmMessage = selectedClient === 'todos' 
                    ? `¿Descargar respaldo GLOBAL del año ${year}?`
                    : `¿Descargar respaldo ${year} de ${selectedClient}?`;

                if (!window.confirm(confirmMessage)) return;

                setIsZipping(true);
                try {
                    const zip = new JSZip();
                    const folderName = selectedClient === 'todos' ? `Respaldo_${year}` : `Respaldo_${year}_${selectedClient.replace(/[^a-z0-9]/gi, '_')}`;
                    const rootFolder = zip.folder(folderName);
                    
                    let sourceData = visibleRequests;
                    if (selectedClient !== 'todos') {
                        sourceData = sourceData.filter(req => getUnifiedName(req) === selectedClient);
                    }

                    const targetRequests = sourceData.filter(req => req.timestamp && req.timestamp.toDate().getFullYear() === parseInt(year));

                    if (targetRequests.length === 0) throw new Error("No hay datos para descargar con este filtro.");

                    const promises = targetRequests.map(async (req) => {
                        const date = req.timestamp.toDate();
                        const monthName = `${String(date.getMonth() + 1).padStart(2, '0')}_${date.toLocaleString('es-AR', { month: 'long' })}`;
                        const folder = rootFolder.folder(monthName);
                        
                        const clientName = getUnifiedName(req);
                        const safeName = clientName.replace(/[^a-z0-9]/gi, '_').substring(0, 20);
                        const baseName = `${date.toISOString().split('T')[0]}_$${Math.round(req.aiData?.monto_total||0)}_${safeName}`;

                        let addedSomething = false;

                        // 1. ORIGINAL
                        if (req.requestImageUrl) {
                            try {
                                const res = await fetch(req.requestImageUrl);
                                const blob = await res.blob();
                                let ext = "jpg"; 
                                if (req.requestImageUrl.includes('.png')) ext = "png";
                                else if (req.requestImageUrl.includes('.pdf')) ext = "pdf";
                                else if (req.requestImageUrl.includes('.jpeg')) ext = "jpeg";

                                folder.file(`${baseName}_ORIGEN.${ext}`, blob);
                                addedSomething = true;
                            } catch (e) { folder.file(`${baseName}_ORIGEN_ERROR.txt`, "Error: " + e.message); }
                        }

                        // 2. FACTURA
                        if (req.invoiceUrl) {
                            try {
                                const res = await fetch(req.invoiceUrl);
                                const blob = await res.blob();
                                folder.file(`${baseName}_FACTURA.pdf`, blob);
                                addedSomething = true;
                            } catch (e) { folder.file(`${baseName}_FACTURA_ERROR.txt`, "Error: " + e.message); }
                        }

                        // 3. MANUAL
                        if (!addedSomething) {
                            folder.file(`${baseName}_MANUAL.txt`, `REGISTRO MANUAL\nCliente: ${clientName}\nCUIT: ${req.aiData?.cuit_receptor}\nMonto: ${req.aiData?.monto_total}`);
                        }
                    });
                    
                    await Promise.all(promises);
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `${folderName}.zip`);
                } catch (e) { alert(e.message); } finally { setIsZipping(false); }
            };

            // --- 6. CREAR SOLICITUD ---
            const handleCreateRequest = async (e) => {
                e.preventDefault();
                if (!user) return;
                if (createMode === 'file' && !newRequestFile) return alert("Falta archivo");
                if (createMode === 'manual' && (!manualData.monto || !manualData.nombreCliente)) return alert("Faltan datos");

                setUploading(true);
                try {
                    let url = null;
                    let finalAiData = null;

                    if (createMode === 'file') {
                        const fileRef = ref(storage, `billing_requests/${user.uid}/${Date.now()}_${newRequestFile.name}`);
                        await uploadBytes(fileRef, newRequestFile);
                        url = await getDownloadURL(fileRef);
                    } else {
                        finalAiData = {
                            monto_total: parseFloat(manualData.monto),
                            fecha_pago: manualData.fecha,
                            tipo_comprobante: 'Efectivo/Manual',
                            concepto_detectado: manualData.concepto,
                            nombre_emisor: userData.nombre || user.email, 
                            nombre_receptor: manualData.nombreCliente,
                            cuit_receptor: manualData.cuitCliente || '', 
                            banco_origen: 'Efectivo/Caja'
                        };
                    }

                    const modo = userData?.isAdmin ? 'estudio' : (userData.modoFacturacion || 'estudio');

                    await addDoc(collection(db, 'billing_requests'), {
                        userId: user.uid, userName: userData.nombre || user.email, userPhone: userData.telefono || "",
                        userModoFacturacion: modo, status: 'pending', requestImageUrl: url, aiData: finalAiData,
                        note: newRequestNote, timestamp: Timestamp.now(), invoiceUrl: null, isManualEntry: createMode === 'manual'
                    });

                    setShowModal(false); setNewRequestFile(null); setNewRequestNote('');
                    setManualData({ monto: '', fecha: new Date().toISOString().split('T')[0], concepto: 'Pago en Efectivo', nombreCliente: '', cuitCliente: '' });
                    setCreateMode('file');
                } catch (e) { alert("Error"); } finally { setUploading(false); }
            };

            // Helpers
            const handleCompleteRequest = async (id) => { 
    if (!invoiceFile || !id) return; 
    setUploading(true); 
    try { 
        const req = requests.find(r => r.id === id); 
        const fileRef = ref(storage, `billing_invoices/${req.userId}/${Date.now()}_${invoiceFile.name}`); 
        await uploadBytes(fileRef, invoiceFile); 
        const url = await getDownloadURL(fileRef); 
        await updateDoc(doc(db, 'billing_requests', id), { 
            status: 'completed', 
            invoiceUrl: url, 
            completedAt: Timestamp.now() 
        }); 
        setCompletingId(null); 
        setInvoiceFile(null); 
    } catch (e) {
        alert("Error al subir la factura");
    } finally { 
        setUploading(false); 
    } 
};
            
            // --- MODAL DE EDICIÓN ---
            const openEditModal = (req) => {
                if (req.status === 'pending' && !req.aiData && !req.isManualEntry) {
                    return alert("⏳ Por favor, espere a que la IA termine de analizar el comprobante.");
                }

                const rawCuit = req.aiData?.cuit_receptor || '';
                const cuit = rawCuit.replace(/\D/g, '');
                const phoneFromHistory = clientPhoneDictionary[cuit] || '';
                const phoneToShow = req.userPhone || phoneFromHistory || '';

                setEditFormData({
                    fecha_pago: req.aiData?.fecha_pago || '',
                    hora_pago: req.aiData?.hora_pago || '', 
                    monto_total: req.aiData?.monto_total || 0,
                    tipo_comprobante: req.aiData?.tipo_comprobante || '',
                    numero_operacion: req.aiData?.numero_operacion || '', 
                    
                    cuit_emisor: req.aiData?.cuit_emisor || '',
                    nombre_emisor: req.aiData?.nombre_emisor || '',
                    banco_origen: req.aiData?.banco_origen || '',
                    
                    cuit_receptor: req.aiData?.cuit_receptor || '',
                    nombre_receptor: req.aiData?.nombre_receptor || '',
                    banco_receptor: req.aiData?.banco_receptor || '',
                    
                    userPhone: phoneToShow, 

                    concepto_detectado: req.aiData?.concepto_detectado || ''
                });
                setEditingRequest(req);
            };

            const handleSaveEdits = async (e) => { 
                e.preventDefault(); 
                if (!editingRequest) return; 
                try { 
                    const { userPhone, ...aiDataFields } = editFormData;

                    await updateDoc(doc(db, 'billing_requests', editingRequest.id), { 
                        aiData: { ...aiDataFields, monto_total: parseFloat(editFormData.monto_total) },
                        userPhone: userPhone 
                    }); 
                    setEditingRequest(null); 
                } catch (e) { alert("Error al guardar"); } 
            };

            const handleDeleteRequest = async () => { if(requestToDelete) { await deleteDoc(doc(db, 'billing_requests', requestToDelete)); setRequestToDelete(null); } };
            const markAsDone = async (reqId) => { if(!confirm("¿Confirmar?")) return; try { await updateDoc(doc(db, 'billing_requests', reqId), { status: 'completed', completedAt: Timestamp.now() }); } catch(e) {} };
            const toggleDetails = (id) => setExpandedRowId(expandedRowId === id ? null : id);
            
            // --- WHATSAPP ---
            const sendWhatsAppNotification = (req) => {
                if (!req.invoiceUrl) return;
                
                let phone = req.userPhone;
                if (!phone) phone = prompt("Ingresa el número de celular del cliente (549...):");
                if (!phone) return;

                const nombreCliente = getUnifiedName(req);
                const monto = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(req.aiData?.monto_total || 0);
                const fecha = req.aiData?.fecha_pago || 'la fecha';
                
                const mensaje = `Hola *${nombreCliente}*! 👋\n\n` +
                                `Te envío la factura correspondiente al pago de *${monto}* realizado el día ${fecha}.\n\n` +
                                `📎 *Podés descargarla desde este link:*\n` +
                                `${req.invoiceUrl}`; 

                const urlWhatsApp = `https://wa.me/${phone}?text=${encodeURIComponent(mensaje)}`;
                window.open(urlWhatsApp, '_blank');
            };

            return (
                <div className="p-4">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 className="text-3xl font-bold text-gray-800">{userData?.isAdmin ? 'Centro de Facturación' : 'Mis Facturaciones'}</h2>
                        <div className="flex items-center gap-2">
                            <span className="text-sm font-bold text-gray-500 hidden md:inline">Cliente (Receptor):</span>
                            <select value={selectedClient} onChange={(e) => setSelectedClient(e.target.value)} className="border rounded p-2 text-sm bg-white min-w-[200px]">
                                <option value="todos">Mostrar Todos</option>
                                {uniqueClients.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <button onClick={() => setShowModal(true)} className="btn-primary ml-2"><Icon name="PlusCircle" className="w-5 h-5 mr-1"/> Nuevo</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div className="bg-white p-4 rounded shadow border-l-4 border-green-500">
                            <p className="text-gray-500 text-xs font-bold uppercase">Total Facturado</p>
                            <h3 className="text-2xl font-bold text-green-700">{new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(metrics.totalFacturado)}</h3>
                        </div>
                        <div className="bg-white p-4 rounded shadow border-l-4 border-yellow-500">
                            <p className="text-gray-500 text-xs font-bold uppercase">Pendiente</p>
                            <h3 className="text-2xl font-bold text-yellow-700">{new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(metrics.totalPendiente)}</h3>
                        </div>
                    </div>

                    <div className="bg-indigo-50 border border-indigo-100 rounded p-4 mb-6 flex justify-between items-center">
                        <div className="flex items-center gap-3"><div className="bg-indigo-100 p-2 rounded-full text-indigo-600"><Icon name="Archive" className="w-6 h-6"/></div><div><h4 className="font-bold text-indigo-900 text-sm">Respaldo Legal</h4><p className="text-xs text-indigo-700">Descarga ZIP anual.</p></div></div>
                        <div className="flex gap-2">
                            {/* SELECTOR AUTOMÁTICO DE AÑOS */}
                            <select id="y" className="border rounded p-1">
                                {availableYears.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                            <button onClick={() => downloadYearlyBackup(document.getElementById('y').value)} disabled={isZipping} className="bg-indigo-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-indigo-700">{isZipping ? '...' : 'Descargar'}</button>
                        </div>
                    </div>

                    <div className="flex border-b mb-6 bg-white rounded-t px-4 pt-2">
                        <button onClick={() => setFilterStatus('pending')} className={`py-3 px-6 border-b-2 font-medium text-sm ${filterStatus === 'pending' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'}`}>Pendientes ({visibleRequests.filter(r => r.status !== 'completed').length})</button>
                        <button onClick={() => setFilterStatus('completed')} className={`py-3 px-6 border-b-2 font-medium text-sm ${filterStatus === 'completed' ? 'border-green-600 text-green-600' : 'border-transparent text-gray-500'}`}>Historial</button>
                    </div>

                    <div className="bg-white rounded shadow overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fecha</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Cliente (Receptor)</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Resumen</th>
                                    <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Monto</th>
                                    <th className="px-6 py-3"></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {loading ? <tr><td colSpan="5" className="text-center py-10">Cargando...</td></tr> : 
                                filteredRequests.length === 0 ? <tr><td colSpan="5" className="text-center py-10 text-gray-500">Sin datos.</td></tr> :
                                filteredRequests.map(req => (
                                    <React.Fragment key={req.id}>
                                        <tr className={`hover:bg-blue-50 cursor-pointer ${expandedRowId === req.id ? 'bg-blue-50' : ''}`} onClick={() => toggleDetails(req.id)}>
                                            <td className="px-6 py-4 text-sm text-gray-500">
                                                {req.status === 'pending' && !req.aiData && !req.isManualEntry ? (
                                                    <div className="h-4 bg-gray-200 rounded w-24 animate-pulse"></div>
                                                ) : (
                                                    req.timestamp?.toDate().toLocaleDateString()
                                                )}
                                            </td>
                                            
                                            <td className="px-6 py-4">
                                                {req.status === 'pending' && !req.aiData && !req.isManualEntry ? (
                                                    <div className="space-y-2">
                                                        <div className="h-4 bg-blue-100 rounded w-32 animate-pulse"></div>
                                                        <div className="h-3 bg-gray-100 rounded w-20 animate-pulse"></div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="text-sm font-bold text-blue-900">{getUnifiedName(req)}</div>
                                                        <div className="text-xs text-gray-500 font-mono">{req.aiData?.cuit_receptor || ''}</div>
                                                    </>
                                                )}
                                            </td>

                                            <td className="px-6 py-4 text-sm text-gray-600">
                                                {req.status === 'pending' && !req.aiData && !req.isManualEntry ? (
                                                    <div className="flex items-center gap-2 text-indigo-600 animate-pulse">
                                                        <Icon name="Cpu" className="w-4 h-4 animate-spin-slow" />
                                                        <span className="text-xs font-bold uppercase tracking-wider">IA Analizando...</span>
                                                    </div>
                                                ) : (
                                                    req.isManualEntry ? 'Carga Manual' : (req.aiData?.banco_origen || 'Detectado')
                                                )}
                                            </td>

                                            <td className="px-6 py-4 text-right">
                                                {req.status === 'pending' && !req.aiData && !req.isManualEntry ? (
                                                    <div className="h-5 bg-green-100 rounded w-20 ml-auto animate-pulse"></div>
                                                ) : (
                                                    req.status === 'duplicate' ? (
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                                                            <Icon name="AlertTriangle" className="w-3 h-3 mr-1"/> DUPLICADO
                                                        </span>
                                                    ) : (
                                                        <span className="font-bold text-green-700">
                                                            {new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(req.aiData?.monto_total || 0)}
                                                        </span>
                                                    )
                                                )}
                                            </td>
                                            <td className="px-6 py-4 text-center"><Icon name="ChevronDown" className="w-5 h-5 text-gray-400"/></td>
                                        </tr>
                                        {expandedRowId === req.id && (
                                            <tr className="bg-gray-50"><td colSpan="5" className="px-6 py-4">
                                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                    <div className="bg-white p-4 rounded border border-blue-200">
                                                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                                                            <h4 className="font-bold text-blue-800 text-sm">Datos del Pago</h4>
                                                            <button 
                                                                onClick={() => openEditModal(req)} 
                                                                className={`text-xs font-bold border px-2 py-1 rounded ${req.status === 'pending' && !req.aiData && !req.isManualEntry ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-blue-600 border-blue-200'}`}
                                                            >
                                                                {req.status === 'pending' && !req.aiData && !req.isManualEntry ? 'Analizando...' : 'Editar'}
                                                            </button>
                                                        </div>
                                                        <div className="space-y-3 text-sm">
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div><span className="text-xs text-gray-500 block">Fecha</span><b>{req.aiData?.fecha_pago}</b></div>
                                                                <div><span className="text-xs text-gray-500 block">Tipo</span><b>{req.aiData?.tipo_comprobante}</b></div>
                                                            </div>
                                                            <div className="bg-gray-50 p-2 rounded border">
                                                                <span className="text-xs text-gray-400 uppercase">Emisor (Quién Pagó):</span>
                                                                <div className="font-bold">{req.aiData?.nombre_emisor}</div>
                                                                <div className="text-xs font-mono">{req.aiData?.cuit_emisor}</div>
                                                            </div>
                                                            <div className="bg-blue-50 p-2 rounded border border-blue-100">
                                                                <span className="text-xs text-blue-400 uppercase">Receptor (Cliente):</span>
                                                                <div className="font-bold text-blue-900">{req.aiData?.nombre_receptor}</div>
                                                                <div className="text-xs font-mono text-blue-700">{req.aiData?.cuit_receptor}</div>
                                                            </div>
                                                            <div><span className="text-xs text-gray-500">Concepto:</span> {req.aiData?.concepto_detectado}</div>
                                                            {req.requestImageUrl && <div className="mt-2 text-center"><a href={req.requestImageUrl} target="_blank" className="text-blue-600 underline text-xs">Ver Comprobante Original</a></div>}
                                                        </div>
                                                    </div>

                                                    <div className="bg-gray-100 p-4 rounded border flex flex-col justify-between">
                                                        <div>
                                                            <h4 className="font-bold text-gray-800 mb-3 text-sm">Gestión</h4>
                                                            {req.status !== 'completed' ? (
                                                                (req.userModoFacturacion === 'estudio' && !userData?.isAdmin) ? <p className="text-center text-gray-500 text-sm">En proceso...</p> :
                                                                <div>
                                                                    <label className="text-xs font-bold">Subir Factura Final:</label>
                                                                    <div className="flex gap-2 mb-2"><input type="file" onChange={(e) => setInvoiceFile(e.target.files[0])} className="text-xs w-full bg-white rounded border"/><button onClick={() => handleCompleteRequest(req.id)} className="btn-primary text-xs" disabled={uploading}>{uploading ? '...' : 'Subir'}</button></div>
                                                                    <button onClick={() => markAsDone(req.id)} className="w-full btn-secondary text-xs">Marcar lista (Sin PDF)</button>
                                                                </div>
                                                            ) : (
                                                                <div className="text-center">
                                                                    <p className="text-green-600 font-bold mb-2">✅ Facturado</p>
                                                                    {req.invoiceUrl && <a href={req.invoiceUrl} target="_blank" className="text-blue-600 underline text-sm font-bold block mb-2">Ver Factura PDF</a>}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div>
                                                            {req.invoiceUrl && <button onClick={() => sendWhatsAppNotification(req)} className="w-full mt-2 bg-green-500 text-white text-xs py-2 rounded font-bold">Enviar WhatsApp</button>}
                                                            <button onClick={() => setRequestToDelete(req.id)} className="w-full mt-4 text-red-500 text-xs hover:underline text-right">Eliminar Registro</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td></tr>
                                        )}
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {requestToDelete && <ConfirmModal message="¿Eliminar?" confirmText="Eliminar" isDestructive={true} onConfirm={handleDeleteRequest} onCancel={() => setRequestToDelete(null)} />}
                    
                    {/* MODAL CREAR */}
                    {showModal && (
                        <div className="modal-overlay">
                            <div className="modal-content sm:max-w-lg">
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">Nuevo</h3><button onClick={() => setShowModal(false)}><Icon name="X" className="w-5 h-5"/></button></div>
                                <div className="flex bg-gray-100 p-1 rounded mb-4"><button onClick={() => setCreateMode('file')} className={`flex-1 py-1 text-sm font-bold rounded ${createMode==='file'?'bg-white shadow':''}`}>Archivo</button><button onClick={() => setCreateMode('manual')} className={`flex-1 py-1 text-sm font-bold rounded ${createMode==='manual'?'bg-white shadow':''}`}>Manual</button></div>
                                <form onSubmit={handleCreateRequest}>
                                    {createMode === 'file' ? <div className="border-2 border-dashed p-6 text-center"><input type="file" onChange={(e)=>setNewRequestFile(e.target.files[0])}/></div> : 
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-gray-600">Cliente (Receptor)</label>
                                        <input type="text" placeholder="Nombre (Razón Social)" value={manualData.nombreCliente} onChange={e=>setManualData({...manualData,nombreCliente:e.target.value})} className="border p-2 w-full rounded"/>
                                        <input type="text" placeholder="CUIT (Opcional, para unificar)" value={manualData.cuitCliente} onChange={e=>setManualData({...manualData,cuitCliente:e.target.value})} className="border p-2 w-full rounded"/>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="date" value={manualData.fecha} onChange={e=>setManualData({...manualData,fecha:e.target.value})} className="border p-2 w-full rounded"/>
                                            <input type="number" placeholder="Monto" value={manualData.monto} onChange={e=>setManualData({...manualData,monto:e.target.value})} className="border p-2 w-full rounded"/>
                                        </div>
                                    </div>}
                                    <div className="flex justify-end gap-2 mt-4">
                                        <button type="button" onClick={() => setShowModal(false)} className="btn-secondary">Cancelar</button>
                                        <button className="btn-primary" disabled={uploading}>Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* MODAL EDITAR COMPLETO */}
                    {editingRequest && (
                        <div className="modal-overlay">
                            <div className="modal-content sm:max-w-2xl">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="text-xl font-bold text-gray-800">Editar Datos Detectados</h3>
                                    <button onClick={() => setEditingRequest(null)} className="text-gray-400 hover:text-gray-600">
                                        <Icon name="X" className="w-6 h-6"/>
                                    </button>
                                </div>
                                
                                <form onSubmit={handleSaveEdits} className="space-y-4">
                                    {/* 1. CABECERA */}
                                    <div className="bg-yellow-50 p-3 rounded border border-yellow-200">
                                        <p className="text-xs font-bold text-yellow-700 uppercase mb-2">Detalles de la Operación</p>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            <div><label className="text-xs font-bold text-gray-500">Fecha</label><input type="date" value={editFormData.fecha_pago} onChange={e => setEditFormData({...editFormData, fecha_pago: e.target.value})} className="w-full border p-1.5 rounded text-sm bg-white"/></div>
                                            <div><label className="text-xs font-bold text-gray-500">Hora</label><input type="time" value={editFormData.hora_pago} onChange={e => setEditFormData({...editFormData, hora_pago: e.target.value})} className="w-full border p-1.5 rounded text-sm bg-white"/></div>
                                            <div><label className="text-xs font-bold text-gray-500">Monto Total</label><input type="number" step="0.01" value={editFormData.monto_total} onChange={e => setEditFormData({...editFormData, monto_total: e.target.value})} className="w-full border p-1.5 rounded text-sm font-bold text-gray-800 bg-white"/></div>
                                            <div><label className="text-xs font-bold text-gray-500">Tipo Comp.</label><input type="text" value={editFormData.tipo_comprobante} onChange={e => setEditFormData({...editFormData, tipo_comprobante: e.target.value})} className="w-full border p-1.5 rounded text-sm bg-white"/></div>
                                            <div className="md:col-span-2"><label className="text-xs font-bold text-gray-500">N° Operación</label><input type="text" value={editFormData.numero_operacion} onChange={e => setEditFormData({...editFormData, numero_operacion: e.target.value})} className="w-full border p-1.5 rounded text-sm bg-white"/></div>
                                        </div>
                                    </div>

                                    {/* 2. COLUMNAS */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                            <p className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-1"><Icon name="ArrowUpRight" className="w-3 h-3"/> Emisor (Origen)</p>
                                            <div className="space-y-2">
                                                <input placeholder="Nombre Emisor" value={editFormData.nombre_emisor} onChange={e => setEditFormData({...editFormData, nombre_emisor: e.target.value})} className="w-full border p-2 rounded text-sm"/>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <input placeholder="CUIT" value={editFormData.cuit_emisor} onChange={e => setEditFormData({...editFormData, cuit_emisor: e.target.value})} className="w-full border p-2 rounded text-sm"/>
                                                    <input placeholder="Banco/Billetera" value={editFormData.banco_origen} onChange={e => setEditFormData({...editFormData, banco_origen: e.target.value})} className="w-full border p-2 rounded text-sm"/>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                            <p className="text-xs font-bold text-blue-600 uppercase mb-2 flex items-center gap-1"><Icon name="ArrowDownLeft" className="w-3 h-3"/> Receptor (Destino)</p>
                                            <div className="space-y-2">
                                                <input placeholder="Nombre Receptor" value={editFormData.nombre_receptor} onChange={e => setEditFormData({...editFormData, nombre_receptor: e.target.value})} className="w-full border p-2 rounded text-sm"/>
                                                
                                                <div className="flex items-center gap-1">
                                                    <span className="text-lg">📱</span>
                                                    <input type="tel" placeholder="WhatsApp (ej: 549381...)" value={editFormData.userPhone} onChange={e => setEditFormData({...editFormData, userPhone: e.target.value})} className="w-full border p-2 rounded text-sm font-bold text-blue-800 bg-white"/>
                                                </div>

                                                <div className="grid grid-cols-2 gap-2">
                                                    <input placeholder="CUIT" value={editFormData.cuit_receptor} onChange={e => setEditFormData({...editFormData, cuit_receptor: e.target.value})} className="w-full border p-2 rounded text-sm"/>
                                                    <input placeholder="Banco/Billetera" value={editFormData.banco_receptor} onChange={e => setEditFormData({...editFormData, banco_receptor: e.target.value})} className="w-full border p-2 rounded text-sm"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 3. PIE */}
                                    <div><label className="text-xs font-bold text-gray-500">Concepto / Referencia</label><textarea rows="2" value={editFormData.concepto_detectado} onChange={e => setEditFormData({...editFormData, concepto_detectado: e.target.value})} className="w-full border p-2 rounded text-sm bg-gray-50 focus:bg-white transition-colors"></textarea></div>

                                    <div className="flex justify-end gap-3 mt-4 pt-2 border-t">
                                        <button type="button" onClick={() => setEditingRequest(null)} className="px-4 py-2 rounded text-sm font-bold text-gray-600 hover:bg-gray-100">Cancelar</button>
                                        <button type="submit" className="px-6 py-2 rounded text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 shadow">Guardar Cambios</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
            // --- ROUTER Y APP PRINCIPAL (Actualizado para Proveedores) ---
      const AppContext = createContext();

      const App = () => {
          const { user, userData } = useAuth();
          const [route, setRoute] = useState('/');
          
          const navigate = useCallback((path) => {
              setRoute(path);
          }, []);

          useEffect(() => {
              if(user && route === '/') {
                  navigate('/dashboard');
              }
          }, [user, route, navigate]);

      const renderPage = () => {
          // --- NUEVAS RUTAS DE GESTIÓN ---

          // Detalle Cta. Cte. Cliente
          if (route.startsWith('/gestion/deudores/')) {
              const terceroId = route.split('/').pop();
              return <CuentaCorrienteClientePage terceroId={terceroId} />;
          }

          // Detalle Cta. Cte. Proveedor (NUEVO)
          if (route.startsWith('/gestion/proveedores/')) {
              const terceroId = route.split('/').pop();
              return <CuentaCorrienteProveedorPage terceroId={terceroId} />;
          }

          // Páginas principales de Gestión
          if (route.startsWith('/gestion')) {
              if (route === '/gestion') return <GestionPage/>;
              if (route === '/gestion/terceros') return <TercerosPage/>;
              if (route === '/gestion/deudores') return <DeudoresPage/>;
              if (route === '/gestion/proveedores') return <ProveedoresPage/>; // <-- AHORA FUNCIONAL
              if (route === '/gestion/cheques') return <ChequesPage/>; // Sigue siendo placeholder
          }
          
          // Rutas de Admin
          if (route.startsWith('/admin/manage/')) {
              const userId = route.split('/').pop();
              return userData?.isAdmin ? <AdminClientManagementPage userId={userId} /> : <div>Acceso denegado</div>;
          }

          // Rutas Principales
          switch (route) {
              case '/dashboard': return <DashboardPage />;
              case '/billing-requests': return <BillingRequestsPage />;  
              case '/operations': return <OperationsPage />;
              case '/finances': return <FinancesPage />;
              case '/reports': return <ReportsPage />;
              case '/client-center': return <ClientCenterPage />;
              case '/profile': return <ProfilePage />;
              case '/admin': return <AdminPage />;
              default: return user ? <DashboardPage /> : <LoginPage />;
          }
      };

          return (
              <AppContext.Provider value={{ navigate }}>
                  <div className="App">
                      {!user ? <LoginPage /> : <AppLayout>{renderPage()}</AppLayout>}
                  </div>
              </AppContext.Provider>
          );
      };

      // --- INICIALIZADOR (Sin cambios) ---
      const FirebaseErrorScreen = () => (<div className="min-h-screen flex items-center justify-center bg-red-50 p-4"><div className="max-w-2xl w-full bg-white p-8 rounded-lg shadow-lg border-2 border-red-500 text-center"><h1 className="text-2xl md:text-3xl font-bold text-red-700 mb-4">Error de Configuración</h1><p className="text-gray-700 mb-2">No se pudo inicializar la aplicación. La causa más probable es que la configuración de Firebase no se ha establecido correctamente o los servicios (Authentication, Firestore) no están habilitados.</p></div></div>);
      const AppInitializer = () => {
          const [isInitialized, setIsInitialized] = useState(false);
          const [initError, setInitError] = useState(null);
          useEffect(() => {
              try {
                  if (!window.firebaseConfig || !window.firebaseConfig.apiKey || window.firebaseConfig.apiKey.startsWith("AIzaSy")) {
                      console.warn("La configuración de Firebase parece ser de ejemplo. Asegúrate de usar tus propias credenciales.");
                  }
                  app = initializeApp(window.firebaseConfig);
                  auth = getAuth(app); 
                  db = getFirestore(app); 
                  storage = getStorage(app); 
                  googleProvider = new GoogleAuthProvider();
                  setIsInitialized(true);
              } catch (error) { setInitError(error); }
          }, []);
          if (initError) return <FirebaseErrorScreen />;
          if (!isInitialized) return <div className="min-h-screen flex items-center justify-center">Cargando...</div>;
          return (
              <AuthProvider>
                  <App />
              </AuthProvider>
          );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<AppInitializer />);
      
  </script>
</body>
</html>
