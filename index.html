<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G&R Consultores</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2936/2936733.png" type="image/png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAK3yU78pfmNFAVBojOC7takuDg2NS3i6M",
            authDomain: "gyrconsultores-82422.firebaseapp.com",
            projectId: "gyrconsultores-82422",
            storageBucket: "gyrconsultores-82422.firebasestorage.app",
            messagingSenderId: "963315189373",
            appId: "1:963315189373:web:b5f02184412b2e78275314"
        };
        window.firebaseConfig = firebaseConfig;
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Ocultar la barra de scroll en el carrusel */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none !important;
            }
            main {
                padding: 0;
                overflow: visible;
            }
            .print-container {
                box-shadow: none;
                border: 1px solid #e5e7eb;
                margin: 0;
            }
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            addDoc,
            query,
            getDocs,
            updateDoc,
            orderBy,
            limit,
            deleteDoc,
            where,
            Timestamp,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            listAll,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        const { useState, useEffect, createContext, useContext, useCallback, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // --- VARIABLES GLOBALES DE FIREBASE ---
        let app, auth, db, storage, googleProvider;
        // --- INICIALIZACIÓN DE FIREBASE ---
        const initFirebase = () => {
          try {
            app = initializeApp(window.firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app); // <-- Ver nota abajo
            googleProvider = new GoogleAuthProvider();
          } catch (error) {
            console.error("Error crítico al inicializar Firebase:", error);
            // Aquí podrías intentar mostrar un error en la UI si falla
          }
        };
        initFirebase();
        // --- CONTEXTOS ---
        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
                    if (firebaseUser) {
                        setUser(firebaseUser);
                        const userDocRef = doc(db, "users", firebaseUser.uid);
                        const unsubProfile = onSnapshot(userDocRef, (doc) => {
                            if (doc.exists()) {
                                setUserData(doc.data());
                            } else {
                                const newUserProfile = {
                                    email: firebaseUser.email,
                                    nombre: firebaseUser.displayName || '',
                                    cuit: '',
                                    actividad: '',
                                    categoriaTributaria: 'Monotributo',
                                    telefono: firebaseUser.phoneNumber || '',
                                    isAdmin: false,
                                    incomeGoal: 500000,
                                    expenseBudget: 200000
                                };
                                setDoc(userDocRef, newUserProfile);
                                setUserData(newUserProfile);
                            }
                            setLoading(false);
                        });
                        return () => unsubProfile();
                    } else {
                        setUser(null);
                        setUserData(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            const value = { user, userData, loading };
            return <AuthContext.Provider value={value}>{!loading && children}</AuthContext.Provider>;
        };
        
        const useAuth = () => useContext(AuthContext);
        
        // --- CUSTOM HOOK PARA COLECCIONES ---
        const useCollection = (collectionName, filters) => {
            const { user } = useAuth();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user || !filters?.year || !filters?.month) {
                    setData([]);
                    setLoading(false);
                    return;
                }
                setLoading(true);

                const constraints = [
                    where("year", "==", filters.year),
                    where("month", "==", filters.month),
                    orderBy("fechaEmision", "desc")
                ];
                
                const q = query(collection(db, 'users', user.uid, collectionName), ...constraints);
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, collectionName, filters?.year, filters?.month]);

            return { data, loading };
        };

        const useYearlyCollection = (collectionName, year) => {
            const { user } = useAuth();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user || !year) {
                    setData([]);
                    setLoading(false);
                    return;
                }
                setLoading(true);

                const q = query(collection(db, 'users', user.uid, collectionName), where("year", "==", year), orderBy("fechaEmision", "asc"));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching yearly ${collectionName}:`, error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, collectionName, year]);

            return { data, loading };
        };

        const useSimpleCollection = (collectionName) => {
            const { user } = useAuth();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) {
                    setData([]);
                    setLoading(false);
                    return;
                }
                setLoading(true);
                const q = query(collection(db, 'users', user.uid, collectionName), orderBy("fechaEmision", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching simple ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, collectionName]);
            return { data, loading };
        };


        // --- ÍCONOS INTEGRADOS ---
        const Icons = {
            ClipboardList: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>),
            Landmark: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="22" x2="21" y2="22"></line><line x1="6" y1="18" x2="6" y2="11"></line><line x1="10" y1="18" x2="10" y2="11"></line><line x1="14" y1="18" x2="14" y2="11"></line><line x1="18" y1="18" x2="18" y2="11"></line><polygon points="12 2 20 7 4 7"></polygon></svg>),
            CreditCard: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>),
            Wallet: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"></path></svg>),
            Sparkles: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L14.39 8.36L21 9.61L16.33 14.77L17.18 21.9L12 18.5L6.82 21.9L7.67 14.77L3 9.61L9.61 8.36L12 2z"/></svg>),
            BarChart3: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>),
            Chrome: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="21.17" y1="8" x2="12" y2="8"/><line x1="3.95" y1="6.06" x2="8.54" y2="14"/><line x1="10.88" y1="21.94" x2="15.46" y2="14"/></svg>),
            MessageCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>),
            LayoutDashboard: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="3" y="15" width="7" height="5"/><rect x="14" y="11" width="7" height="9"/></svg>),
            PlusCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>),
            TrendingUp: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>),
            FolderArchive: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>),
            Folder: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>),
            User: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>),
            Users: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>),
            Shield: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>),
            LogOut: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>),
            Menu: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>),
            TrendingDown: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>),
            DollarSign: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>),
            Calendar: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>),
            File: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>),
            Download: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>),
            AlertTriangle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>),
            CheckCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>),
            Edit: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>),
            Trash2: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>),
            ArrowLeft: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>),
            ArrowUpRight: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>),
            ArrowDownRight: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="7" y1="7" x2="17" y2="17"></line><polyline points="17 7 17 17 7 17"></polyline></svg>),
        };

        const Icon = ({ name, ...props }) => {
            const IconComponent = Icons[name];
            return IconComponent ? <IconComponent {...props} /> : <svg {...props} />;
        };
        
        // --- COMPONENTES REUTILIZABLES ---
        const ConfirmModal = ({ message, onConfirm, onCancel }) => {
            return (
                <div className="modal-overlay">
                    <div className="modal-content text-center">
                        <Icon name="AlertTriangle" className="mx-auto h-12 w-12 text-yellow-500 mb-4"/>
                        <h3 className="text-lg font-medium text-gray-900 mb-4">{message}</h3>
                        <div className="flex justify-center gap-4">
                            <button onClick={onCancel} className="py-2 px-4 bg-gray-200 rounded-md hover:bg-gray-300">
                                Cancelar
                            </button>
                            <button onClick={onConfirm} className="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700">
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const DateFilter = ({ date, setDate }) => {
            const years = Array.from({ length: 10 }, (_, i) => new Date().getFullYear() - i);
            const months = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];

            const handleYearChange = (e) => {
                const newYear = parseInt(e.target.value);
                const newDate = new Date(date);
                newDate.setFullYear(newYear);
                setDate(newDate);
            };

            const handleMonthChange = (e) => {
                const newMonth = parseInt(e.target.value);
                const newDate = new Date(date);
                newDate.setMonth(newMonth);
                setDate(newDate);
            };

            return (
                <div className="flex items-center gap-4 mb-6 bg-white p-4 rounded-lg shadow-sm">
                    <h3 className="text-lg font-semibold">Consultar Período:</h3>
                    <select value={date.getMonth()} onChange={handleMonthChange} className="p-2 border rounded-md">
                        {months.map((month, index) => (
                            <option key={index} value={index}>{month}</option>
                        ))}
                    </select>
                    <select value={date.getFullYear()} onChange={handleYearChange} className="p-2 border rounded-md">
                        {years.map(year => (
                            <option key={year} value={year}>{year}</option>
                        ))}
                    </select>
                </div>
            );
        };


        // --- PÁGINA DE LOGIN ---
        const LoginPage = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [view, setView] = useState('login'); // 'login', 'register', 'reset'
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');
            
            const handleEmailPassword = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                try {
                    if (view === 'register') {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let friendlyMessage = 'Error al autenticar.';
                    if (err.code === 'auth/email-already-in-use') friendlyMessage = 'Este email ya está registrado. Intenta iniciar sesión.';
                    else if (err.code === 'auth/weak-password') friendlyMessage = 'La contraseña debe tener al menos 6 caracteres.';
                    else if (err.code === 'auth/invalid-email') friendlyMessage = 'El formato del email no es válido.';
                    else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') friendlyMessage = 'Email o contraseña incorrectos.';
                    setError(friendlyMessage);
                }
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                try {
                    await sendPasswordResetEmail(auth, email);
                    setMessage('Correo de recuperación enviado. Revisa tu bandeja de entrada.');
                } catch (err) {
                    setError('No se pudo enviar el correo. Verifica que el email sea correcto.');
                }
            };
            
            const handleGoogleLogin = async () => {
                setError('');
                try {
                    await signInWithPopup(auth, googleProvider);
                } catch (err) {
                    setError('Error al iniciar sesión con Google.');
                }
            };

            const switchView = (newView) => {
                setView(newView);
                setError('');
                setMessage('');
            };

            return (
                 <div className="min-h-screen flex items-center justify-center bg-gray-100">
                     <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                         <div className="text-center mb-8">
                             <Icon name="BarChart3" className="mx-auto h-12 w-12 text-blue-600"/>
                             <h2 className="mt-4 text-3xl font-bold text-gray-900">
                                 {view === 'login' && 'Iniciar Sesión'}
                                 {view === 'register' && 'Crear una cuenta'}
                                 {view === 'reset' && 'Recuperar Contraseña'}
                             </h2>
                             <p className="mt-2 text-sm text-gray-600">
                                 {view === 'reset' ? 'Ingresa tu email para recibir un enlace de recuperación.' : 'Bienvenido a tu portal de gestión contable.'}
                             </p>
                         </div>

                         {view === 'reset' ? (
                             <form onSubmit={handlePasswordReset} className="space-y-6">
                                 <div><label className="text-sm font-medium text-gray-700">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/></div>
                                 {error && <p className="text-sm text-red-600">{error}</p>}
                                 {message && <p className="text-sm text-green-600">{message}</p>}
                                 <div><button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Enviar correo</button></div>
                             </form>
                         ) : (
                             <form onSubmit={handleEmailPassword} className="space-y-6">
                                 <div><label className="text-sm font-medium text-gray-700">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/></div>
                                 <div><label className="text-sm font-medium text-gray-700">Contraseña</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"/></div>
                                 {view === 'login' && <div className="text-right text-sm"><a href="#" onClick={(e) => { e.preventDefault(); switchView('reset'); }} className="font-medium text-blue-600 hover:text-blue-500">¿Olvidaste tu contraseña?</a></div>}
                                 {error && <p className="text-sm text-red-600">{error}</p>}
                                 <div><button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">{view === 'register' ? 'Registrarse' : 'Ingresar'}</button></div>
                             </form>
                         )}
                        
                         {view !== 'reset' && (
                             <div className="mt-6"><div className="relative"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">O continuar con</span></div></div>
                                 <div className="mt-6 grid grid-cols-1 gap-3">
                                     <button onClick={handleGoogleLogin} className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"><Icon name="Chrome" className="w-5 h-5 mr-2" />Google</button>
                                     <button disabled className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 opacity-50 cursor-not-allowed" title="Próximamente"><Icon name="MessageCircle" className="w-5 h-5 mr-2" />WhatsApp Business</button>
                                 </div>
                             </div>
                         )}
                         <div className="text-center mt-4 text-sm">
                             {view === 'login' && <a href="#" onClick={(e) => { e.preventDefault(); switchView('register'); }} className="font-medium text-blue-600 hover:text-blue-500">¿No tienes cuenta? Regístrate</a>}
                             {view === 'register' && <a href="#" onClick={(e) => { e.preventDefault(); switchView('login'); }} className="font-medium text-blue-600 hover:text-blue-500">¿Ya tienes cuenta? Inicia sesión</a>}
                             {view === 'reset' && <a href="#" onClick={(e) => { e.preventDefault(); switchView('login'); }} className="font-medium text-blue-600 hover:text-blue-500">Volver a Iniciar Sesión</a>}
                         </div>
                     </div>
                 </div>
            );
        };
        
        // --- LAYOUT PRINCIPAL ---
        const AppLayout = ({ children }) => {
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const { userData } = useAuth();
            const { navigate } = useContext(AppContext);
            const navLinks = [
                { name: 'Dashboard', icon: 'LayoutDashboard', path: '/dashboard' }, 
                { name: 'Operaciones', icon: 'PlusCircle', path: '/operations' },
                { name: 'Gestión', icon: 'ClipboardList', path: '/gestion'},
                { name: 'Finanzas', icon: 'TrendingUp', path: '/finances' }, 
                { name: 'Reportes', icon: 'BarChart3', path: '/reports' },
                { name: 'Cliente', icon: 'FolderArchive', path: '/client-center' },
                { name: 'Perfil', icon: 'User', path: '/profile' },
                ...(userData?.isAdmin ? [{ name: 'Admin', icon: 'Shield', path: '/admin' }] : [])
            ];
            
            const handleNavigate = (path) => {
                navigate(path);
                setSidebarOpen(false); // Cierra el menú al navegar
            };

            return (
                <div className="flex h-screen bg-gray-100">
                    {/* Overlay para cerrar el menú en móvil */}
                    {sidebarOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden" onClick={() => setSidebarOpen(false)}></div>}

                    <div className={`fixed inset-y-0 left-0 transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform duration-200 ease-in-out bg-gray-800 text-white w-64 space-y-6 py-7 px-2 z-30 no-print`}>
                        <a href="#" onClick={() => handleNavigate('/dashboard')} className="text-white flex items-center space-x-2 px-4"><Icon name="BarChart3" className="w-8 h-8"/><span className="text-2xl font-bold">G&R Consultores</span></a>
                        <nav>{navLinks.map(link => (<a key={link.name} href="#" onClick={() => handleNavigate(link.path)} className="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 flex items-center space-x-2"><Icon name={link.icon} className="w-5 h-5"/><span>{link.name}</span></a>))}</nav>
                        <div className="absolute bottom-5 w-full left-0 px-4"><button onClick={() => signOut(auth)} className="w-full text-left py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 flex items-center space-x-2"><Icon name="LogOut" className="w-5 h-5"/><span>Cerrar Sesión</span></button></div>
                    </div>
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="flex justify-between items-center p-4 bg-white border-b no-print"><button onClick={() => setSidebarOpen(!sidebarOpen)} className="text-gray-500 focus:outline-none md:hidden"><Icon name="Menu" className="h-6 w-6"/></button><h1 className="text-2xl font-semibold text-gray-800">Bienvenido, {userData?.nombre || 'Cliente'}!</h1><div></div></header>
                        <main className="flex-1 overflow-y-auto bg-gray-100 p-6"><div className="fade-in">{children}</div></main>
                    </div>
                </div>
            );
        };
        
        // --- COMPONENTE DE IA ---
        const AIAnalyzer = () => {
            const [operations, setOperations] = useState([]);
            const { user } = useAuth();
            
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'users', user.uid, 'operations'), orderBy("fechaEmision", "desc"), limit(50));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setOperations(snapshot.docs.map(doc => doc.data()));
                });
                return () => unsubscribe();
            }, [user]);

            const [prompt, setPrompt] = useState('');
            const [result, setResult] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAnalysis = async () => {
                if (!prompt.trim()) {
                    setError('Por favor, escribe una pregunta.');
                    return;
                }
                 if (operations.length === 0) {
                    setError('No tienes operaciones registradas para analizar.');
                    return;
                }

                setLoading(true);
                setResult('');
                setError('');

                const apiUrl = 'https://us-central1-gyrconsultores-82422.cloudfunctions.net/secureGeminiCall';

                const operationsContext = operations.map(op => 
                    `- ${op.fechaEmision.toDate().toLocaleDateString('es-AR')}: ${op.type} de ${op.amount.toFixed(2)} ARS (${op.description})`
                ).join('\n');

                const systemPrompt = "Actúa como un asistente financiero experto y conciso. Analiza los datos de operaciones proporcionados y responde la pregunta del usuario en español. Basa tu respuesta únicamente en los datos. Si la pregunta no se puede responder con los datos, indícalo. Formatea tu respuesta de forma clara y amigable.";
                const fullPrompt = `Basado en las siguientes operaciones financieras:\n\n${operationsContext}\n\nPor favor, responde a la siguiente pregunta: "${prompt}"`;

                const payload = {
                    contents: [{ parts: [{ text: fullPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         const errorBody = await response.json();
                         console.error("Error response from backend:", errorBody);
                         throw new Error(`Error del servidor: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    const text = data.text;

                    if (text) {
                        setResult(text);
                    } else {
                        throw new Error("No se recibió una respuesta válida de la IA.");
                    }
                } catch (err) {
                    console.error("Error calling the secure backend:", err);
                    setError("Hubo un error al contactar al asistente de IA. Por favor, intenta de nuevo más tarde.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-xl font-bold mb-4 flex items-center">
                        <Icon name="Sparkles" className="w-6 h-6 mr-2 text-yellow-500" />
                        Análisis con IA
                    </h3>
                    <div className="space-y-4">
                        <textarea
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="Ej: ¿Cuál fue mi mayor gasto este mes? o Dame consejos para reducir mis compras."
                            className="w-full p-2 border rounded-md"
                            rows="3"
                        />
                        <button
                            onClick={handleAnalysis}
                            disabled={loading}
                            className="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                        >
                            {loading ? 'Analizando...' : 'Analizar mis Finanzas'}
                        </button>
                        {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                        {loading && <div className="text-center text-gray-500"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto"></div><p>El asistente está pensando...</p></div>}
                        {result && (
                            <div className="mt-4 p-4 bg-gray-50 rounded-lg border">
                                <p className="text-gray-800 whitespace-pre-wrap">{result}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PÁGINAS ---
        const DashboardPage = () => {
            const [operations, setOperations] = useState([]);
            const { user } = useAuth();
            
            useEffect(() => {
                if (!user) return;
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;

                const q = query(
                    collection(db, 'users', user.uid, 'operations'),
                    where("year", "==", year),
                    where("month", "==", month)
                );
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setOperations(snapshot.docs.map(doc => doc.data()));
                });
                return () => unsubscribe();
            }, [user]);


            const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

            const metrics = useMemo(() => {
                let ventas = 0, compras = 0, ingresos = 0, gastos = 0;
                operations.forEach(op => {
                    switch (op.type) {
                        case 'venta': ventas += op.amount; break;
                        case 'compra': compras += op.amount; break;
                        case 'ingreso': ingresos += op.amount; break;
                        case 'gasto': gastos += op.amount; break;
                    }
                });

                const totalIncome = ventas + ingresos;
                const totalExpense = compras + gastos;
                const cashFlow = totalIncome - totalExpense;
                const profitability = totalIncome > 0 ? (cashFlow / totalIncome) * 100 : 0;
                const expenseRatio = totalIncome > 0 ? (totalExpense / totalIncome) * 100 : 0;
                const purchasesToSalesRatio = ventas > 0 ? (compras / ventas) * 100 : 0;

                return { ventas, compras, ingresos, gastos, totalIncome, totalExpense, cashFlow, profitability, expenseRatio, purchasesToSalesRatio };
            }, [operations]);

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Resumen del Mes</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
                       <div className="bg-white p-6 rounded-lg shadow-md"><h3 className="font-bold text-lg mb-2">Ventas</h3><p className="text-3xl font-bold text-green-600">{formatCurrency(metrics.ventas)}</p></div>
                       <div className="bg-white p-6 rounded-lg shadow-md"><h3 className="font-bold text-lg mb-2">Compras</h3><p className="text-3xl font-bold text-red-600">{formatCurrency(metrics.compras)}</p></div>
                       <div className="bg-white p-6 rounded-lg shadow-md"><h3 className="font-bold text-lg mb-2">Otros Ingresos</h3><p className="text-3xl font-bold text-green-500">{formatCurrency(metrics.ingresos)}</p></div>
                       <div className="bg-white p-6 rounded-lg shadow-md"><h3 className="font-bold text-lg mb-2">Otros Gastos</h3><p className="text-3xl font-bold text-red-500">{formatCurrency(metrics.gastos)}</p></div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between">
                            <div>
                                <h3 className="font-bold text-lg mb-2">Flujo de Caja (Mensual)</h3>
                                <p className={`text-4xl font-bold ${metrics.cashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(metrics.cashFlow)}</p>
                            </div>
                            <div className="flex items-center mt-4">
                                {metrics.cashFlow >= 0 ? <Icon name="ArrowUpRight" className="w-8 h-8 text-green-600"/> : <Icon name="ArrowDownRight" className="w-8 h-8 text-red-600"/>}
                                <span className="ml-2 text-gray-500">Resultado del mes</span>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h3 className="font-bold text-lg mb-2">Rentabilidad Neta</h3>
                            <p className={`text-4xl font-bold ${metrics.profitability >= 0 ? 'text-blue-600' : 'text-red-600'}`}>{metrics.profitability.toFixed(1)}%</p>
                            <p className="text-gray-500 mt-2">Del total de ingresos</p>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h3 className="font-bold text-lg mb-2">Gastos vs Ingresos</h3>
                            <p className="text-4xl font-bold text-purple-600">{metrics.expenseRatio.toFixed(0)}%</p>
                            <p className="text-gray-500 mt-2">Tus gastos representan este % de tus ingresos</p>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h3 className="font-bold text-lg mb-2">Compras vs Ventas</h3>
                            <p className="text-4xl font-bold text-orange-500">{metrics.purchasesToSalesRatio.toFixed(0)}%</p>
                            <p className="text-gray-500 mt-2">Porcentaje de ventas destinado a compras</p>
                        </div>
                    </div>

                    <AIAnalyzer />
                </div>
            );
        };
        
        const OperationsPage = () => {
            const { user } = useAuth();
            const [filterDate, setFilterDate] = useState(new Date());
            const { data: operations, loading } = useCollection('operations', {
                year: filterDate.getFullYear(),
                month: filterDate.getMonth() + 1
            });
            const [recentOperations, setRecentOperations] = useState([]);
            
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'users', user.uid, 'operations'), orderBy("fechaEmision", "desc"), limit(5));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setRecentOperations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [user]);

            const [showModal, setShowModal] = useState(false);
            const [editingOp, setEditingOp] = useState(null);
            const [showConfirmDelete, setShowConfirmDelete] = useState(false);
            const [operationToDelete, setOperationToDelete] = useState(null);
            
            const handleDelete = async () => {
                if (!operationToDelete) return;
                await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'operations', operationToDelete));
                setShowConfirmDelete(false);
                setOperationToDelete(null);
            };

            const promptDelete = (id) => {
                setOperationToDelete(id);
                setShowConfirmDelete(true);
            };
            
            const handleEdit = (op) => {
                setEditingOp(op);
                setShowModal(true);
            };
            
            const handleNewOperation = () => {
                setEditingOp(null);
                setShowModal(true);
            };

            const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">Operaciones</h2>
                        <button onClick={handleNewOperation} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><Icon name="PlusCircle" className="w-5 h-5 mr-2"/>Nueva Operación</button>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 className="text-xl font-bold mb-4">Últimas Operaciones Agregadas</h3>
                        {recentOperations.length > 0 ? (
                            <ul className="divide-y divide-gray-200">
                                {recentOperations.map(op => (
                                    <li key={op.id} className="py-3 flex justify-between items-center">
                                        <div>
                                            <p className="font-medium capitalize">{op.type}: {op.description}</p>
                                            <p className="text-sm text-gray-500">{op.fechaEmision.toDate().toLocaleDateString('es-AR')}</p>
                                        </div>
                                        <p className={`font-bold text-lg ${['venta','ingreso'].includes(op.type) ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(op.amount)}
                                        </p>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-gray-500 text-center">No hay operaciones recientes.</p>
                        )}
                    </div>

                    <DateFilter date={filterDate} setDate={setFilterDate} />

                    {showModal && <OperationModal op={editingOp} onClose={() => setShowModal(false)} />}
                    {showConfirmDelete && (
                        <ConfirmModal
                            message="¿Estás seguro de que quieres eliminar esta operación?"
                            onConfirm={handleDelete}
                            onCancel={() => setShowConfirmDelete(false)}
                        />
                    )}

                    <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                        <h3 className="text-xl font-bold mb-4">Operaciones del Período</h3>
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50"><tr>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Fecha</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Descripción</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Monto</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Acciones</th>
                            </tr></thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {loading ? (<tr><td colSpan="5" className="text-center py-10">Cargando...</td></tr>) : 
                                operations.length > 0 ? operations.map(op => (
                                    <tr key={op.id}>
                                        <td className="px-6 py-4 whitespace-nowrap">{op.fechaEmision.toDate().toLocaleDateString('es-AR')}</td>
                                        <td className="px-6 py-4 whitespace-nowrap capitalize">{op.type}</td>
                                        <td className="px-6 py-4">{op.description}</td>
                                        <td className={`px-6 py-4 whitespace-nowrap font-semibold ${['venta','ingreso'].includes(op.type) ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(op.amount)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onClick={() => handleEdit(op)} className="text-indigo-600 hover:text-indigo-900 mr-4"><Icon name="Edit" className="w-5 h-5"/></button>
                                            <button onClick={() => promptDelete(op.id)} className="text-red-600 hover:text-red-900"><Icon name="Trash2" className="w-5 h-5"/></button>
                                        </td>
                                    </tr>
                                )) : (<tr><td colSpan="5" className="text-center py-10 text-gray-500">No hay operaciones para el período seleccionado.</td></tr>)}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const OperationModal = ({ op, onClose }) => {
            const { user } = useAuth();
            const [formData, setFormData] = useState({
                type: op?.type || 'venta',
                amount: op?.amount || '',
                description: op?.description || '',
                fechaEmision: op?.fechaEmision ? op.fechaEmision.toDate().toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [message, setMessage] = useState('');
            
            const handleChange = e => setFormData({...formData, [e.target.name]: e.target.value});

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user || isSubmitting) return;

                setIsSubmitting(true);
                const localDate = new Date(formData.fechaEmision + 'T00:00:00');
                
                const dataToSave = {
                    type: formData.type,
                    amount: parseFloat(formData.amount),
                    description: formData.description,
                    fechaEmision: Timestamp.fromDate(localDate),
                    year: localDate.getFullYear(),
                    month: localDate.getMonth() + 1, // JS months are 0-indexed
                    day: localDate.getDate()
                };

                try {
                    if (op) { // Editing
                        await updateDoc(doc(db, 'users', user.uid, 'operations', op.id), dataToSave);
                    } else { // Creating
                        await addDoc(collection(db, 'users', user.uid, 'operations'), dataToSave);
                    }
                    onClose();
                } catch (error) {
                    setMessage('Error al guardar la operación.');
                    console.error(error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2 className="text-2xl font-bold mb-6">{op ? 'Editar' : 'Nueva'} Operación</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label>Fecha</label><input type="date" name="fechaEmision" value={formData.fechaEmision} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"/></div>
                            <div><label>Tipo</label><select name="type" value={formData.type} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"><option value="venta">Venta</option><option value="compra">Compra</option><option value="ingreso">Ingreso</option><option value="gasto">Gasto</option></select></div>
                            <div><label>Monto</label><input type="number" step="0.01" name="amount" value={formData.amount} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"/></div>
                            <div><label>Descripción</label><textarea name="description" value={formData.description} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"></textarea></div>
                            <div className="flex justify-end gap-4 pt-4">
                                <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-md">Cancelar</button>
                                <button type="submit" disabled={isSubmitting} className="py-2 px-4 bg-blue-600 text-white rounded-md disabled:bg-gray-400">{isSubmitting ? 'Guardando...' : 'Guardar'}</button>
                            </div>
                             {message && <p className="text-red-500 text-center">{message}</p>}
                        </form>
                    </div>
                </div>
            );
        };

        const FixedDepositCalculator = () => {
            const [capital, setCapital] = useState('');
            const [days, setDays] = useState(30);
            const [tna, setTna] = useState('');
            const [result, setResult] = useState({ interest: 0, total: 0 });

            const formatCurrency = (value) => {
                if (value === null || typeof value === 'undefined' || isNaN(value)) return '$0,00';
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
            };

            useEffect(() => {
                const numCapital = parseFloat(capital);
                const numDays = parseInt(days, 10);
                const numTna = parseFloat(tna);

                if (numCapital > 0 && numDays > 0 && numTna > 0) {
                    const calculatedInterest = (numCapital * numDays * numTna) / 36500;
                    setResult({
                        interest: calculatedInterest,
                        total: numCapital + calculatedInterest
                    });
                } else {
                    setResult({ interest: 0, total: numCapital > 0 ? numCapital : 0 });
                }
            }, [capital, days, tna]);

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-xl font-bold mb-4 text-center">Calculadora de Plazo Fijo</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Capital a Invertir ($)</label>
                            <input type="number" value={capital} onChange={e => setCapital(e.target.value)} placeholder="Ej: 100000" className="mt-1 w-full p-2 border rounded-md"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Cantidad de Días</label>
                            <input type="number" value={days} onChange={e => setDays(e.target.value)} placeholder="Ej: 30" className="mt-1 w-full p-2 border rounded-md"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">T.N.A. (%)</label>
                            <input type="number" step="0.01" value={tna} onChange={e => setTna(e.target.value)} placeholder="Ej: 75" className="mt-1 w-full p-2 border rounded-md"/>
                        </div>
                    </div>
                    <div className="bg-gray-50 p-6 rounded-lg text-center">
                        <h4 className="text-lg font-semibold text-gray-800">Resultado</h4>
                        <div className="mt-4 space-y-2">
                            <p className="text-gray-600">Intereses Ganados:</p>
                            <p className="text-3xl font-bold text-green-600">{formatCurrency(result.interest)}</p>
                            <p className="text-gray-600 mt-2">Monto Total al Finalizar:</p>
                            <p className="text-3xl font-bold text-blue-600">{formatCurrency(result.total)}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const FinancesPage = () => {
            const { user, userData } = useAuth();
            const [dollarRates, setDollarRates] = useState([]);
            const [loadingRates, setLoadingRates] = useState(true);
            const [isEditingBudget, setIsEditingBudget] = useState(false);
            const [budget, setBudget] = useState({ incomeGoal: 0, expenseBudget: 0 });
            
            const [operations, setOperations] = useState([]);
            useEffect(() => {
                if (!user) return;
                const now = new Date();
                const q = query(
                    collection(db, 'users', user.uid, 'operations'),
                    where("year", "==", now.getFullYear()),
                    where("month", "==", now.getMonth() + 1)
                );
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setOperations(snapshot.docs.map(doc => doc.data()));
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (userData) {
                    setBudget({
                        incomeGoal: userData.incomeGoal || 0,
                        expenseBudget: userData.expenseBudget || 0,
                    });
                }
            }, [userData]);
            
            const monthlyMetrics = useMemo(() => {
                let income = 0, expense = 0;
                operations.forEach(op => {
                    if (['venta', 'ingreso'].includes(op.type)) income += op.amount;
                    else expense += op.amount;
                });
                return { income, expense };
            }, [operations]);


            const handleSaveBudget = async () => {
                if (!user) return;
                const userDocRef = doc(db, 'users', user.uid);
                try {
                    await updateDoc(userDocRef, {
                        incomeGoal: parseFloat(budget.incomeGoal) || 0,
                        expenseBudget: parseFloat(budget.expenseBudget) || 0
                    });
                    setIsEditingBudget(false);
                } catch (error) {
                    console.error("Error updating budget:", error);
                }
            };
            
            const formatCurrency = (value) => {
                if (value === null || typeof value === 'undefined') return '$--';
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value)
            };

            useEffect(() => {
                const fetchFinancialData = async () => {
                    setLoadingRates(true);
                    try {
                        const response = await fetch('https://dolarapi.com/v1/dolares');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        setDollarRates(data);
                    } catch (error) { 
                        console.error("Failed to fetch dollar data:", error);
                        setDollarRates([]);
                    } finally {
                        setLoadingRates(false);
                    }
                };
                fetchFinancialData();
            }, []);
            
            return (
                 <div>
                     <h2 className="text-3xl font-bold mb-6">Finanzas</h2>
                     
                     <h3 className="text-2xl font-bold mb-4">Presupuesto Mensual</h3>
                     <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                         {isEditingBudget ? (
                             <div className="space-y-4">
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div><label className="block text-sm font-medium text-gray-700">Meta de Ingresos ($)</label><input type="number" value={budget.incomeGoal} onChange={e => setBudget({...budget, incomeGoal: e.target.value})} className="mt-1 w-full p-2 border rounded-md"/></div>
                                     <div><label className="block text-sm font-medium text-gray-700">Presupuesto de Gastos ($)</label><input type="number" value={budget.expenseBudget} onChange={e => setBudget({...budget, expenseBudget: e.target.value})} className="mt-1 w-full p-2 border rounded-md"/></div>
                                 </div>
                                 <div className="flex justify-end gap-2"><button onClick={() => setIsEditingBudget(false)} className="py-2 px-4 bg-gray-200 rounded-md">Cancelar</button><button onClick={handleSaveBudget} className="py-2 px-4 bg-blue-600 text-white rounded-md">Guardar</button></div>
                             </div>
                         ) : (
                             <div className="space-y-6">
                                 <div className="flex justify-between items-center"><h4 className="font-bold text-xl">Progreso del Mes</h4><button onClick={() => setIsEditingBudget(true)} className="text-sm text-blue-600 hover:underline">Editar Presupuesto</button></div>
                                 <div>
                                     <div className="flex justify-between mb-1 text-sm"><span className="font-medium">Ingresos</span><span>{formatCurrency(monthlyMetrics.income)} / <span className="text-gray-500">{formatCurrency(budget.incomeGoal)}</span></span></div>
                                     <div className="w-full bg-gray-200 rounded-full h-4"><div className="bg-green-500 h-4 rounded-full" style={{ width: `${Math.min((monthlyMetrics.income / (budget.incomeGoal || 1)) * 100, 100)}%` }}></div></div>
                                 </div>
                                  <div>
                                     <div className="flex justify-between mb-1 text-sm"><span className="font-medium">Gastos</span><span>{formatCurrency(monthlyMetrics.expense)} / <span className="text-gray-500">{formatCurrency(budget.expenseBudget)}</span></span></div>
                                     <div className="w-full bg-gray-200 rounded-full h-4"><div className={`h-4 rounded-full ${monthlyMetrics.expense > budget.expenseBudget ? 'bg-red-600' : 'bg-red-400'}`} style={{ width: `${Math.min((monthlyMetrics.expense / (budget.expenseBudget || 1)) * 100, 100)}%` }}></div></div>
                                 </div>
                             </div>
                         )}
                     </div>

                     <h3 className="text-2xl font-bold my-8">Indicadores en Tiempo Real</h3>
                     <div className="relative">
                         <div className="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide" style={{ scrollSnapType: 'x mandatory' }}>
                             {loadingRates ? <p>Cargando cotizaciones...</p> : 
                              dollarRates.length > 0 ? dollarRates.map(rate => (
                                 <div key={rate.casa} className="flex-shrink-0 w-11/12 sm:w-1/2 md:w-1/3 bg-white p-6 rounded-lg shadow-md" style={{ scrollSnapAlign: 'center' }}>
                                     <h4 className="font-bold text-xl mb-4 text-center capitalize">{rate.nombre}</h4>
                                     <div className="flex flex-col items-center space-y-4">
                                         <div className="text-center">
                                             <p className="text-sm text-gray-500">Compra</p>
                                             <p className="text-2xl font-bold text-gray-800">{formatCurrency(rate.compra)}</p>
                                         </div>
                                         <div className="text-center">
                                             <p className="text-sm text-gray-500">Venta</p>
                                             <p className="text-2xl font-bold text-gray-800">{formatCurrency(rate.venta)}</p>
                                         </div>
                                     </div>
                                 </div>
                             )) : <p>No se pudieron cargar las cotizaciones.</p>
                             }
                         </div>
                     </div>

                     <h3 className="text-2xl font-bold my-8">Herramientas de Simulación</h3>
                     <FixedDepositCalculator />
                 </div>
            );
        };
        
        const ClientCenterPage = ({ isManagedView = false, managedUserId = null, managedClientName = '' }) => {
            const { user, userData } = useAuth();
            const currentUserId = isManagedView ? managedUserId : user?.uid;
            
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [message, setMessage] = useState('');
            const [files, setFiles] = useState({});
            const [currentFolder, setCurrentFolder] = useState(null);
            const [loadingFiles, setLoadingFiles] = useState(true);
            const [storageError, setStorageError] = useState('');
            const [showConfirmDelete, setShowConfirmDelete] = useState(false);
            const [fileToDelete, setFileToDelete] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [loadingNotifications, setLoadingNotifications] = useState(true);
            
            const folders = [
                { id: 'comprobantes', name: 'Comprobantes', acl: 'client' },
                { id: 'contratos', name: 'Contratos', acl: 'client' },
                { id: 'balances', name: 'Balances', acl: 'client' },
                { id: 'documentos_del_contador', name: 'Documentos del Contador', acl: 'accountant' },
            ];

            // AI Logic for notifications
            useEffect(() => {
                if (isManagedView || !userData) return;

                const fetchVencimientos = async () => {
                    setLoadingNotifications(true);
                    const apiUrl = `https://us-central1-gyrconsultores-82422.cloudfunctions.net/secureGeminiCall`;
                    
                    let userQuery = "";
                    if (userData.categoriaTributaria === 'Monotributo') {
                        userQuery = "Vencimientos de Monotributo para el mes actual en Argentina según AFIP.";
                    } else if (userData.categoriaTributaria === 'Responsable Inscripto') {
                        userQuery = "Vencimientos de IVA y Ganancias para el mes actual en Argentina según AFIP.";
                    } else {
                        setLoadingNotifications(false);
                        return;
                    }
                    
                    const systemPrompt = "Actúa como un asistente contable. Busca los vencimientos impositivos de AFIP para el mes actual en Argentina para un contribuyente. Formatea la respuesta como una lista corta y clara. Si no encuentras información, indícalo. La fecha de hoy es Octubre 2025.";

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorBody = await response.json();
                            console.error("Error response from backend for notifications:", errorBody);
                            throw new Error('API response not OK');
                        }
                        const data = await response.json();
                        const text = data.text;

                        if (text) {
                            const lines = text.split('\n').filter(line => line.trim().startsWith('*') || line.trim().startsWith('-'));
                            const parsedNotifications = lines.map((line, index) => ({
                                id: `vencimiento-${index}`,
                                title: line.replace(/[\*\-]/g, '').split(':')[0].trim(),
                                body: line.replace(/[\*\-]/g, '').split(':')[1]?.trim() || 'Verificar fecha en AFIP.',
                                type: 'warning'
                            }));
                            setNotifications(parsedNotifications);
                        } else {
                            setNotifications([{ id: 'error', title: 'Vencimientos', body: 'No se pudo obtener la información de vencimientos.', type: 'error' }]);
                        }
                    } catch (error) {
                        console.error("Error fetching vencimientos:", error);
                        setNotifications([{ id: 'error', title: 'Vencimientos', body: 'Error al consultar vencimientos.', type: 'error' }]);
                    } finally {
                        setLoadingNotifications(false);
                    }
                };

                fetchVencimientos();
            }, [isManagedView, userData]);

            const handleFirebaseError = (error) => {
                console.error("Firebase Storage Error:", error);
                if (error.code === 'storage/unauthorized') {
                    setStorageError('Error de permisos. Verifica que las Reglas de Seguridad de Firebase Storage estén configuradas correctamente para permitir la lectura y escritura.');
                } else {
                    setStorageError('Ocurrió un error inesperado al operar con los archivos.');
                }
            };
            
            const fetchFiles = useCallback(async () => {
                if (!currentUserId) return;
                setLoadingFiles(true);
                setStorageError('');
                try {
                    const listRef = ref(storage, `user_documents/${currentUserId}`);
                    const res = await listAll(listRef);
                    
                    const filesByFolder = {};
                    folders.forEach(f => filesByFolder[f.id] = []);

                    for (const folderRef of res.prefixes) {
                        const folderName = folderRef.name;
                        if (filesByFolder.hasOwnProperty(folderName)) {
                            const folderFiles = await listAll(folderRef);
                            filesByFolder[folderName] = await Promise.all(
                                folderFiles.items.map(async (itemRef) => ({
                                    name: itemRef.name,
                                    url: await getDownloadURL(itemRef),
                                    fullPath: itemRef.fullPath
                                }))
                            );
                        }
                    }
                    setFiles(filesByFolder);
                } catch (error) {
                    handleFirebaseError(error);
                } finally {
                    setLoadingFiles(false);
                }
            }, [currentUserId]);

            useEffect(() => { fetchFiles(); }, [fetchFiles]);
            
            const [uploadFolder, setUploadFolder] = useState(isManagedView ? 'documentos_del_contador' : 'comprobantes');

            const handleUpload = async () => {
                if (!file || !currentUserId) return;
                setUploading(true);
                setStorageError('');
                setMessage('');
                const storageRef = ref(storage, `user_documents/${currentUserId}/${uploadFolder}/${file.name}`);
                try {
                    await uploadBytes(storageRef, file);
                    setMessage({ type: 'success', text: 'Archivo subido.' }); 
                    setFile(null); 
                    fetchFiles();
                } catch (error) { 
                    setMessage({ type: 'error', text: 'Error al subir.' }); 
                    handleFirebaseError(error);
                } finally { 
                    setUploading(false); 
                    setTimeout(() => setMessage(''), 3000); 
                }
            };
            
            const promptDelete = (filePath) => {
                setFileToDelete(filePath);
                setShowConfirmDelete(true);
            };

            const confirmDeleteFile = async () => {
                if (!fileToDelete) return;
                setStorageError('');
                const fileRef = ref(storage, fileToDelete);
                try {
                    await deleteObject(fileRef);
                    fetchFiles();
                } catch (error) {
                    handleFirebaseError(error);
                } finally {
                    setShowConfirmDelete(false);
                    setFileToDelete(null);
                }
            };
            
            const canDelete = (folderId) => {
                const folder = folders.find(f => f.id === folderId);
                if (userData?.isAdmin) return true; // Admin can delete from any folder.
                if (folder?.acl === 'client') return true; // Client can delete from their own folders.
                return false;
            };

            const FolderView = () => (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {folders.map(folder => (
                        <button key={folder.id} onClick={() => setCurrentFolder(folder.id)} className="p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow text-center">
                            <Icon name="Folder" className="mx-auto h-12 w-12 text-blue-500 mb-2"/>
                            <p className="font-semibold">{folder.name}</p>
                        </button>
                    ))}
                </div>
            );

            const FileView = () => (
                <div>
                    <button onClick={() => setCurrentFolder(null)} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                        <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver a Carpetas
                    </button>
                    <h3 className="text-2xl font-bold mb-4">Carpeta: {folders.find(f => f.id === currentFolder)?.name}</h3>
                    <ul className="bg-white p-4 rounded-lg shadow-md divide-y divide-gray-200">
                        {loadingFiles ? <p>Cargando...</p> : files[currentFolder]?.length > 0 ? (
                            files[currentFolder].map((f) => (
                                <li key={f.name} className="py-3 flex justify-between items-center">
                                    <a href={f.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline flex items-center">
                                        <Icon name="File" className="w-5 h-5 mr-3 text-gray-500"/> {f.name}
                                    </a>
                                     {canDelete(currentFolder) && (
                                        <button onClick={() => promptDelete(f.fullPath)} className="text-red-500 hover:text-red-700">
                                            <Icon name="Trash2" className="w-5 h-5" />
                                        </button>
                                    )}
                                </li>
                            ))
                        ) : <p className="text-gray-500 text-center py-4">Esta carpeta está vacía.</p>}
                    </ul>
                </div>
            );
            
            // He añadido más tipos de archivo aquí para asegurar que se puedan seleccionar.
            const fileInputAccept = "image/*,application/pdf,.doc,.docx,.xls,.xlsx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">{isManagedView ? `Gestionando Documentos de ${managedClientName || 'Cliente'}` : "Centro del Cliente"}</h2>
                    {showConfirmDelete && ( <ConfirmModal message="¿Estás seguro de que quieres eliminar este archivo? Esta acción no se puede deshacer." onConfirm={confirmDeleteFile} onCancel={() => setShowConfirmDelete(false)}/> )}
                    {storageError && (<div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert"><p className="font-bold">Error de Almacenamiento</p><p>{storageError}</p></div>)}
                    
                    <div className="bg-white p-8 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-4">Subir un Documento</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="file" accept={fileInputAccept} onChange={(e) => setFile(e.target.files[0])} className="md:col-span-1" />
                            <select value={uploadFolder} onChange={(e) => setUploadFolder(e.target.value)} className="p-2 border rounded-md md:col-span-1">
                                {(isManagedView ? folders.filter(f => f.acl === 'accountant') : folders.filter(f => f.acl === 'client')).map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                            </select>
                            <button onClick={handleUpload} disabled={!file || uploading} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 md:col-span-1">
                                {uploading ? 'Subiendo...' : 'Subir Archivo'}
                            </button>
                        </div>
                        {message && <p className={`mt-4 text-sm text-center ${message.type === 'success' ? 'text-green-600' : 'text-red-600'}`}>{message.text}</p>}
                    </div>

                    <div className="bg-white p-8 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-4">Mis Documentos</h3>
                        {currentFolder ? <FileView /> : <FolderView />}
                    </div>

                    {!isManagedView && <div className="bg-white p-8 rounded-lg shadow-md">
                        <h3 className="text-xl font-bold mb-4">Notificaciones</h3>
                         {loadingNotifications ? <p>Buscando vencimientos...</p> : 
                             <div className="space-y-4">
                                 {notifications.length > 0 ? notifications.map(notif => (
                                     <div key={notif.id} className={`flex items-start p-4 border-l-4 rounded-r-lg ${notif.type === 'warning' ? 'bg-yellow-50 border-yellow-400' : 'bg-green-50 border-green-400'}`}>
                                         <Icon name={notif.type === 'warning' ? 'AlertTriangle' : 'CheckCircle'} className={`h-6 w-6 mr-3 shrink-0 ${notif.type === 'warning' ? 'text-yellow-600' : 'text-green-600'}`}/>
                                         <div>
                                             <p className="font-bold">{notif.title}</p>
                                             <p className="text-sm">{notif.body}</p>
                                         </div>
                                     </div>
                                 )) : <p className="text-gray-500">No hay vencimientos para mostrar según tu categoría fiscal.</p>}
                                 <div className="flex items-start p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg"><Icon name="File" className="h-6 w-6 text-blue-600 mr-3 shrink-0"/><div><p className="font-bold">Nuevo Documento del Contador</p><p className="text-sm">Se ha subido "Balance Anual 2024.pdf" (Ejemplo).</p></div></div>
                             </div>
                         }
                    </div>}
                </div>
            );
        };
        const ProfilePage = () => {
            const { user, userData } = useAuth();
            const [profile, setProfile] = useState({ nombre: '', cuit: '', actividad: '', categoriaTributaria: '', telefono: '' });
            const [message, setMessage] = useState(null); // { type: 'success'|'error', text: '...' } o null
            const [saving, setSaving] = useState(false);

            useEffect(() => { if (userData) setProfile(prev => ({...prev, ...userData})); }, [userData]);
            
            const handleChange = (e) => setProfile(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                setSaving(true);
                setMessage(null);
                try {
                  await updateDoc(doc(db, 'users', user.uid), profile);
                  setMessage({ type: 'success', text: 'Perfil actualizado.'});
                } catch (error) {
                  console.error("Perfil update error:", error);
                  setMessage({ type: 'error', text: 'Error al actualizar. Revisa la consola.' });
                } finally {
                  setSaving(false);
                  setTimeout(() => setMessage(null), 3000);
                }
            };
            
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Mi Perfil</h2>
                    <div className="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="font-medium">Nombre Completo</label><input name="nombre" value={profile.nombre} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                            <div><label className="font-medium">CUIT/CUIL</label><input name="cuit" value={profile.cuit} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                            <div><label className="font-medium">Actividad Principal</label><input name="actividad" value={profile.actividad} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                             <div><label className="font-medium">Categoría Tributaria</label><select name="categoriaTributaria" value={profile.categoriaTributaria} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"><option>Monotributo</option><option>Responsable Inscripto</option></select></div>
                            <div><label className="font-medium">Teléfono de Contacto</label><input name="telefono" value={profile.telefono} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                            <button type="submit" disabled={saving} className={`w-full py-2 rounded-md ${saving ? 'bg-gray-400' : 'bg-blue-600 text-white'}`}>
                              {saving ? 'Guardando...' : 'Guardar Cambios'}
                            </button>
                            {message && <p className={`text-center mt-2 ${message.type === 'success' ? 'text-green-600' : 'text-red-600'}`}>{message.text}</p>}
                        </form>
                    </div>
                </div>
            );
        };
        const AdminPage = () => {
            const { userData } = useAuth();
            const [users, setUsers] = useState([]);
            const [error, setError] = useState('');
            const { navigate } = useContext(AppContext);
            
            useEffect(() => {
                const fetchUsers = async () => {
                    setError('');
                    try {
                        const q = query(collection(db, "users"));
                        const querySnapshot = await getDocs(q);
                        setUsers(querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
                    } catch (err) {
                        console.error("Error fetching users:", err);
                        setError("No se pudieron cargar los clientes. Es probable que las reglas de seguridad de Firestore no permitan listar usuarios. Asegúrate de que un administrador tenga permiso de 'list' sobre la colección 'users'.");
                    }
                };
                if(userData?.isAdmin) {
                    fetchUsers();
                }
            }, [userData]);

            if (!userData?.isAdmin) return <div><h2 className="text-3xl font-bold text-red-600">Acceso Denegado</h2><p>Esta sección es solo para administradores.</p></div>;

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Panel de Administración</h2>
                    
                    {error && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert">
                            <p className="font-bold">Error de Permisos</p>
                            <p>{error}</p>
                        </div>
                    )}

                    <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                        <h3 className="text-xl font-bold mb-4 flex items-center"><Icon name="Users" className="w-6 h-6 mr-2"/> Lista de Clientes</h3>
                        <table className="min-w-full divide-y">
                            <thead className="bg-gray-50"><tr>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Nombre</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Email</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">CUIT</th>
                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Acciones</th>
                            </tr></thead>
                            <tbody className="bg-white divide-y">{users.map(user => (<tr key={user.id}><td className="px-6 py-4 whitespace-nowrap">{user.nombre || '-'}</td><td className="px-6 py-4 whitespace-nowrap">{user.email}</td><td className="px-6 py-4 whitespace-nowrap">{user.cuit || '-'}</td><td className="px-6 py-4"><button onClick={() => navigate(`/admin/manage/${user.id}`)} className="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 text-sm">Gestionar</button></td></tr>))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminClientManagementPage = ({ userId }) => {
             const { navigate } = useContext(AppContext);
             const [clientData, setClientData] = useState(null);

             useEffect(() => {
                 const fetchClientData = async () => {
                     const clientDocRef = doc(db, "users", userId);
                     const clientDoc = await getDoc(clientDocRef);
                     if (clientDoc.exists()) {
                         setClientData(clientDoc.data());
                     }
                 };
                 fetchClientData();
             }, [userId]);

             return (
                 <div>
                     <button onClick={() => navigate('/admin')} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                         <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver al Panel de Admin
                     </button>
                     <ClientCenterPage 
                         isManagedView={true} 
                         managedUserId={userId} 
                         managedClientName={clientData?.nombre} 
                     />
                 </div>
             )
        };

        const GestionPage = () => {
          const { navigate } = useContext(AppContext);
          return (
              <div>
                  <h2 className="text-3xl font-bold mb-6">Panel de Gestión</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      
                      {/* Panel de Administración de Terceros (Nuevo) */}
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer lg:col-span-3" onClick={() => navigate('/gestion/terceros')}>
                          <h3 className="text-xl font-bold text-gray-700 mb-2 flex items-center"><Icon name="Users" className="w-5 h-5 mr-2"/> Gestión de Terceros</h3>
                          <p className="text-gray-600">Administra tu base de Clientes y Proveedores desde un solo lugar.</p>
                      </div>

                      {/* Paneles existentes */}
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate('/gestion/deudores')}>
                          <h3 className="text-xl font-bold text-blue-600 mb-2">Deudores por Venta</h3>
                          <p className="text-gray-600">Administra tus cuentas por cobrar, registra pagos y controla los saldos de tus clientes.</p>
                      </div>
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate('/gestion/proveedores')}>
                          <h3 className="text-xl font-bold text-purple-600 mb-2">Proveedores</h3>
                          <p className="text-gray-600">Lleva un registro de tus cuentas por pagar, gestiona vencimientos y organiza tus pagos.</p>
                      </div>
                      <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate('/gestion/cheques')}>
                          <h3 className="text-xl font-bold text-green-600 mb-2">Gestión de Cheques</h3>
                          <p className="text-gray-600">Controla los cheques emitidos y recibidos, sus fechas de vencimiento y estados.</p>
                      </div>
                  </div>
              </div>
          );
        };

        const DeudoresPage = () => {
          const { user } = useAuth();
          const { navigate } = useContext(AppContext);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState('');
          const [saldosData, setSaldosData] = useState({ deudores: [], totalCobrar: 0 });

          // 1. Hook para leer TODOS los datos y calcular saldos
          useEffect(() => {
              if (!user) return;

              const fetchSaldos = async () => {
                  setLoading(true);
                  setError('');
                  try {
                      // Definimos las 3 consultas que necesitamos
                      const qTerceros = query(
                          collection(db, 'users', user.uid, 'terceros'),
                          where("tipo", "in", ["Cliente", "Ambos", "cliente", "ambos"]),
                          orderBy("nombre", "asc")
                      );
                      const qFacturas = collection(db, 'users', user.uid, 'facturasVenta');
                      const qPagos = collection(db, 'users', user.uid, 'pagosRecibidos');

                      // Ejecutamos las 3 consultas en paralelo
                      const [tercerosSnap, facturasSnap, pagosSnap] = await Promise.all([
                          getDocs(qTerceros),
                          getDocs(qFacturas),
                          getDocs(qPagos)
                      ]);

                      // Procesamos los resultados
                      const terceros = tercerosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                      const facturas = facturasSnap.docs.map(d => d.data());
                      const pagos = pagosSnap.docs.map(d => d.data());

                      // --- INICIO DE DEPURACIÓN (NUEVO) ---
                      console.log('--- DEBUG DEUDORES ---');
                      console.log('Clientes leídos:', tercerosSnap.docs.length, terceros);
                      console.log('Facturas leídas:', facturasSnap.docs.length, facturas);
                      console.log('Pagos leídos:', pagosSnap.docs.length, pagos);
                      // --- FIN DE DEPURACIÓN ---

                      // 2. Calculamos los saldos por cliente
                      const saldosPorCliente = {};

                      // Sumamos todas las facturas
                      facturas.forEach(f => {
                          saldosPorCliente[f.terceroId] = (saldosPorCliente[f.terceroId] || 0) + f.montoTotal;
                      });

                      // Restamos todos los pagos
                      pagos.forEach(p => {
                          saldosPorCliente[p.terceroId] = (saldosPorCliente[p.terceroId] || 0) - p.montoPagado;
                      });
                      
                      console.log('Saldos calculados (antes de filtrar):', saldosPorCliente); // (NUEVO)

                      // 3. Unimos los saldos con la info de los clientes
                      // Filtramos solo los que tienen saldo > 0
                      const deudores = terceros
                          .map(t => ({
                              ...t,
                              saldo: saldosPorCliente[t.id] || 0
                          }))
                          .filter(t => t.saldo > 0)
                          .sort((a, b) => b.saldo - a.saldo);

                      // 4. Calculamos el total general
                      const totalCobrar = deudores.reduce((sum, d) => sum + d.saldo, 0);

                      console.log('Deudores (después de filtrar > 0):', deudores); // (NUEVO)
                      console.log('Total a Cobrar:', totalCobrar); // (NUEVO)

                      // 5. Guardamos todo en el estado
                      setSaldosData({ deudores, totalCobrar });

                  } catch (err) {
                      console.error("Error al calcular saldos:", err);
                      setError('Error al calcular los saldos. ' + (err.message.includes('index') ? 'Podría faltar un índice en Firestore.' : ''));
                  } finally {
                      setLoading(false);
                  }
              };

              fetchSaldos();
          }, [user]);

          const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

          // 3. Renderizar la página
          return (
              <div>
                  <h2 className="text-3xl font-bold mb-6">Deudores por Venta</h2>
                  {error && <p className="text-red-600 bg-red-100 p-3 rounded mb-4">{error}</p>}

                  {/* Tarjetas de Métricas */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                      <div className="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                          <h3 className="text-lg font-semibold text-gray-600 mb-2">Total a Cobrar</h3>
                          <p className="text-3xl font-bold text-blue-600">{formatCurrency(saldosData.totalCobrar)}</p>
                      </div>
                  </div>

                  {/* Tabla de Deudores */}
                  <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                      <h3 className="text-xl font-bold mb-4">Clientes con Saldo Pendiente</h3>
                      <table className="min-w-full divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                              <tr>
                                  <th className="px-6 py-3 text-left text-xs font-medium uppercase">Cliente</th>
                                  <th className="px-6 py-3 text-left text-xs font-medium uppercase">CUIT</th>
                                  <th className="px-6 py-3 text-right text-xs font-medium uppercase">Saldo Deudor</th>
                                  <th className="px-6 py-3 text-center text-xs font-medium uppercase">Acciones</th>
                              </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                              {loading ? (
                                  <tr><td colSpan="4" className="text-center py-10 text-gray-500">Calculando saldos...</td></tr>
                              ) : saldosData.deudores.length > 0 ? (
                                  saldosData.deudores.map(cliente => (
                                      <tr key={cliente.id}>
                                          <td className="px-6 py-4 whitespace-nowrap font-medium">{cliente.nombre}</td>
                                          <td className="px-6 py-4 whitespace-nowrap">{cliente.cuit || '-'}</td>
                                          <td className="px-6 py-4 whitespace-nowrap text-right font-semibold text-gray-800">{formatCurrency(cliente.saldo)}</td>
                                          <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                              <button
                                                  onClick={() => navigate(`/gestion/deudores/${cliente.id}`)}
                                                  className="text-indigo-600 hover:text-indigo-900"
                                              >
                                                  Ver Cta. Cte.
                                              </button>
                                          </td>
                                      </tr>
                                  ))
                              ) : (
                                  <tr><td colSpan="4" className="text-center py-10 text-gray-500">Ningún cliente presenta saldo deudor actualmente.</td></tr>
                              )}
                          </tbody>
                      </table>
                  </div>
              </div>
          );
      };
        
        const ProveedoresPage = () => {
            return <div className="text-center p-8 bg-white rounded-lg shadow-md">
                <h2 className="text-2xl font-bold mb-4">Módulo de Proveedores</h2>
                <p className="text-gray-600">Esta funcionalidad se encuentra en desarrollo y estará disponible próximamente.</p>
            </div>;
        };
        const ChequesPage = () => {
            return <div className="text-center p-8 bg-white rounded-lg shadow-md">
                <h2 className="text-2xl font-bold mb-4">Módulo de Gestión de Cheques</h2>
                <p className="text-gray-600">Esta funcionalidad se encuentra en desarrollo y estará disponible próximamente.</p>
            </div>;
        };
        
        const ReportsPage = () => {
            const { userData } = useAuth();
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const { data: operations, loading } = useYearlyCollection('operations', selectedYear);

            const years = Array.from({ length: 10 }, (_, i) => new Date().getFullYear() - i);
            const formatCurrency = (value) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);

            const annualMetrics = useMemo(() => {
                let totalIncome = 0;
                let totalExpense = 0;
                let totalVentas = 0;
                let totalCompras = 0;
                operations.forEach(op => {
                    if (['venta', 'ingreso'].includes(op.type)) {
                        totalIncome += op.amount;
                        if (op.type === 'venta') {
                            totalVentas += op.amount;
                        }
                    } else {
                        totalExpense += op.amount;
                        if (op.type === 'compra') {
                            totalCompras += op.amount;
                        }
                    }
                });
                const cashFlow = totalIncome - totalExpense;
                return { totalIncome, totalExpense, cashFlow, totalVentas, totalCompras };
            }, [operations]);

            const monthlyBreakdown = useMemo(() => {
                const months = Array.from({ length: 12 }, () => ({ income: 0, expense: 0, ventas: 0, compras: 0 }));
                operations.forEach(op => {
                    const monthIndex = op.month - 1;
                    if (['venta', 'ingreso'].includes(op.type)) {
                        months[monthIndex].income += op.amount;
                        if (op.type === 'venta') {
                            months[monthIndex].ventas += op.amount;
                        }
                    } else { // 'compra' or 'gasto'
                        months[monthIndex].expense += op.amount;
                        if (op.type === 'compra') {
                            months[monthIndex].compras += op.amount;
                        }
                    }
                });
                return months;
            }, [operations]);

            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                    const ctx = chartRef.current.getContext('2d');
                    chartInstanceRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                            datasets: [
                                {
                                    label: 'Ingresos',
                                    data: monthlyBreakdown.map(m => m.income),
                                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                    borderColor: 'rgba(34, 197, 94, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Gastos',
                                    data: monthlyBreakdown.map(m => m.expense),
                                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                    borderColor: 'rgba(239, 68, 68, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', notation: 'compact' }).format(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, [monthlyBreakdown]);

            const handlePrint = () => {
                window.print();
            };

            const handleDownloadCSV = () => {
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                // BOM for UTF-8 Excel compatibility
                let csvContent = "\uFEFF";

                // Header - Using semicolon as separator for regional compatibility
                const headers = ["Mes", "Ingresos Totales", "Ventas", "Gastos Totales", "Compras", "Resultado Mensual"];
                csvContent += headers.join(";") + "\n";

                // Rows
                monthlyBreakdown.forEach((monthData, index) => {
                    const result = monthData.income - monthData.expense;
                    const row = [
                        monthNames[index],
                        monthData.income,
                        monthData.ventas,
                        monthData.expense,
                        monthData.compras,
                        result
                    ].join(";");
                    csvContent += row + "\n";
                });
                
                // Totals Row
                const totalsRow = [
                    "TOTAL ANUAL",
                    annualMetrics.totalIncome,
                    annualMetrics.totalVentas,
                    annualMetrics.totalExpense,
                    annualMetrics.totalCompras,
                    annualMetrics.cashFlow
                ].join(";");
                csvContent += totalsRow + "\n";

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `reporte_anual_${selectedYear}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            return (
                <div>
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-6 no-print">
                        <h2 className="text-3xl font-bold">Reporte Anual</h2>
                        <div className="flex items-center gap-2 sm:gap-4">
                             <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="p-2 border rounded-md bg-white">
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                            <button onClick={handleDownloadCSV} className="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 flex items-center">
                                <Icon name="Download" className="w-5 h-5 mr-2"/> CSV
                            </button>
                            <button onClick={handlePrint} className="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                <Icon name="File" className="w-5 h-5 mr-2"/> Imprimir
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-white p-8 rounded-lg shadow-md print-container">
                        <div className="text-center mb-8">
                            <h3 className="text-2xl font-bold">Reporte Financiero Anual {selectedYear}</h3>
                            <p className="text-gray-600">Cliente: {userData?.nombre || 'N/A'}</p>
                        </div>

                        {loading ? (
                            <p className="text-center py-10">Cargando datos del reporte...</p>
                        ) : (
                            <>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8 text-center">
                                    <div className="bg-green-50 p-4 rounded-lg"><h4 className="font-bold">Ingresos Totales</h4><p className="text-2xl font-bold text-green-600">{formatCurrency(annualMetrics.totalIncome)}</p></div>
                                    <div className="bg-green-50 p-4 rounded-lg"><h4 className="font-bold">Ventas Totales</h4><p className="text-2xl font-bold text-green-700">{formatCurrency(annualMetrics.totalVentas)}</p></div>
                                    <div className="bg-red-50 p-4 rounded-lg"><h4 className="font-bold">Gastos Totales</h4><p className="text-2xl font-bold text-red-600">{formatCurrency(annualMetrics.totalExpense)}</p></div>
                                    <div className="bg-red-50 p-4 rounded-lg"><h4 className="font-bold">Compras Totales</h4><p className="text-2xl font-bold text-red-700">{formatCurrency(annualMetrics.totalCompras)}</p></div>
                                    <div className="bg-blue-50 p-4 rounded-lg sm:col-span-2 lg:col-span-1"><h4 className="font-bold">Flujo de Caja</h4><p className={`text-2xl font-bold ${annualMetrics.cashFlow >= 0 ? 'text-blue-600' : 'text-red-600'}`}>{formatCurrency(annualMetrics.cashFlow)}</p></div>
                                </div>


                                <div className="mb-8">
                                    <h4 className="text-xl font-bold text-center mb-4">Evolución Mensual</h4>
                                    <div style={{ position: 'relative', height: '400px' }}>
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                </div>
                                
                                <div className="overflow-x-auto">
                                    <h4 className="text-xl font-bold text-center mb-4">Datos Mensuales</h4>
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Mes</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Ingresos</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Ventas</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Gastos</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Compras</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium uppercase">Resultado</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {monthlyBreakdown.map((monthData, index) => (
                                                <tr key={index}>
                                                    <td className="px-6 py-4">{new Date(0, index).toLocaleString('es-AR', { month: 'long' }).replace(/^\w/, c => c.toUpperCase())}</td>
                                                    <td className="px-6 py-4 text-green-600">{formatCurrency(monthData.income)}</td>
                                                    <td className="px-6 py-4 text-green-700">{formatCurrency(monthData.ventas)}</td>
                                                    <td className="px-6 py-4 text-red-600">{formatCurrency(monthData.expense)}</td>
                                                    <td className="px-6 py-4 text-red-700">{formatCurrency(monthData.compras)}</td>
                                                    <td className={`px-6 py-4 font-semibold ${monthData.income - monthData.expense >= 0 ? 'text-gray-800' : 'text-red-600'}`}>{formatCurrency(monthData.income - monthData.expense)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };
        // --- GESTIÓN DE TERCEROS (CLIENTES/PROVEEDORES) ---

const TercerosPage = () => {
    const { user } = useAuth();
    const [terceros, setTerceros] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [editingTercero, setEditingTercero] = useState(null);
    const [showConfirmDelete, setShowConfirmDelete] = useState(false);
    const [terceroToDelete, setTerceroToDelete] = useState(null);

    // Hook para leer la colección de terceros en tiempo real
    useEffect(() => {
        if (!user) return;
        setLoading(true);
        const q = query(collection(db, 'users', user.uid, 'terceros'), orderBy("nombre", "asc"));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTerceros(items);
            setLoading(false);
        }, (error) => {
            console.error("Error al leer 'terceros':", error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user]);

    const handleNewTercero = () => {
        setEditingTercero(null);
        setShowModal(true);
    };

    const handleEdit = (tercero) => {
        setEditingTercero(tercero);
        setShowModal(true);
    };

    const promptDelete = (id) => {
        setTerceroToDelete(id);
        setShowConfirmDelete(true);
    };

    const handleDelete = async () => {
        if (!terceroToDelete) return;
        await deleteDoc(doc(db, 'users', user.uid, 'terceros', terceroToDelete));
        setShowConfirmDelete(false);
        setTerceroToDelete(null);
    };

    return (
        <div>
            {showModal && <TerceroModal tercero={editingTercero} onClose={() => setShowModal(false)} />}
            {showConfirmDelete && (
                <ConfirmModal
                    message="¿Estás seguro de que quieres eliminar este tercero? Esto no borrará sus facturas asociadas."
                    onConfirm={handleDelete}
                    onCancel={() => setShowConfirmDelete(false)}
                />
            )}
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold">Gestión de Terceros</h2>
                <button onClick={handleNewTercero} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><Icon name="PlusCircle" className="w-5 h-5 mr-2"/>Nuevo Tercero</button>
            </div>
            <div className="bg-white p-8 rounded-lg shadow-md overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Nombre / Razón Social</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">CUIT</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Email</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Teléfono</th>
                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {loading ? (<tr><td colSpan="6" className="text-center py-10">Cargando terceros...</td></tr>) : 
                        terceros.length > 0 ? terceros.map(t => (
                            <tr key={t.id}>
                                <td className="px-6 py-4 whitespace-nowrap font-medium">{t.nombre}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.cuit}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.tipo}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.email}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{t.telefono}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onClick={() => handleEdit(t)} className="text-indigo-600 hover:text-indigo-900 mr-4"><Icon name="Edit" className="w-5 h-5"/></button>
                                    <button onClick={() => promptDelete(t.id)} className="text-red-600 hover:text-red-900"><Icon name="Trash2" className="w-5 h-5"/></button>
                                </td>
                            </tr>
                        )) : (<tr><td colSpan="6" className="text-center py-10 text-gray-500">No hay terceros creados. Comienza agregando uno.</td></tr>)}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const TerceroModal = ({ tercero, onClose }) => {
    const { user } = useAuth();
    const [formData, setFormData] = useState({
        nombre: tercero?.nombre || '',
        cuit: tercero?.cuit || '',
        email: tercero?.email || '',
        telefono: tercero?.telefono || '',
        tipo: tercero?.tipo || 'Cliente'
    });
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [message, setMessage] = useState('');
    
    const handleChange = e => setFormData({...formData, [e.target.name]: e.target.value});

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!user || isSubmitting) return;

        setIsSubmitting(true);
        
        const dataToSave = {
            ...formData,
            nombre: formData.nombre.trim(),
            cuit: formData.cuit.trim(),
        };

        try {
            if (tercero) { // Editando
                await updateDoc(doc(db, 'users', user.uid, 'terceros', tercero.id), dataToSave);
            } else { // Creando
                await addDoc(collection(db, 'users', user.uid, 'terceros'), dataToSave);
            }
            onClose();
        } catch (error) {
            setMessage('Error al guardar el tercero.');
            console.error(error);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content">
                <h2 className="text-2xl font-bold mb-6">{tercero ? 'Editar' : 'Nuevo'} Tercero</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label>Nombre / Razón Social</label><input type="text" name="nombre" value={formData.nombre} onChange={handleChange} required className="mt-1 w-full p-2 border rounded-md"/></div>
                    <div><label>CUIT (sin guiones)</label><input type="text" name="cuit" value={formData.cuit} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                    <div><label>Tipo</label><select name="tipo" value={formData.tipo} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"><option value="Cliente">Cliente</option><option value="Proveedor">Proveedor</option><option value="Ambos">Ambos</option></select></div>
                    <div><label>Email</label><input type="email" name="email" value={formData.email} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                    <div><label>Teléfono</label><input type="tel" name="telefono" value={formData.telefono} onChange={handleChange} className="mt-1 w-full p-2 border rounded-md"/></div>
                    
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-md">Cancelar</button>
                        <button type="submit" disabled={isSubmitting} className="py-2 px-4 bg-blue-600 text-white rounded-md disabled:bg-gray-400">{isSubmitting ? 'Guardando...' : 'Guardar'}</button>
                    </div>
                    {message && <p className="text-red-500 text-center">{message}</p>}
                </form>
            </div>
        </div>
    );
};
        // --- PÁGINA DE DETALLE: CUENTA CORRIENTE CLIENTE ---
      const CuentaCorrienteClientePage = ({ terceroId }) => {
          const { user } = useAuth();
          const { navigate } = useContext(AppContext);
          const [terceroData, setTerceroData] = useState(null);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState('');

          // Cargar datos del tercero específico
          useEffect(() => {
              if (!user || !terceroId) return;
              setLoading(true);
              setError('');
              const docRef = doc(db, 'users', user.uid, 'terceros', terceroId);
              const unsubscribe = onSnapshot(docRef, (docSnap) => {
                  if (docSnap.exists()) {
                      setTerceroData({ id: docSnap.id, ...docSnap.data() });
                  } else {
                      setError(`No se encontró el tercero con ID: ${terceroId}`);
                      setTerceroData(null);
                  }
                  setLoading(false);
              }, (err) => {
                  console.error("Error al leer datos del tercero:", err);
                  setError('Error al cargar la información del cliente.');
                  setLoading(false);
              });
              return () => unsubscribe();
          }, [user, terceroId]);

          // Por ahora, solo muestra info básica y un mensaje
          return (
              <div>
                  <button onClick={() => navigate('/gestion/deudores')} className="mb-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 flex items-center">
                      <Icon name="ArrowLeft" className="w-5 h-5 mr-2"/> Volver a Deudores
                  </button>

                  {loading && <p className="text-center">Cargando datos del cliente...</p>}
                  {error && <p className="text-red-600 bg-red-100 p-3 rounded mb-4">{error}</p>}

                  {terceroData && (
                      <div className="bg-white p-8 rounded-lg shadow-md">
                          <h2 className="text-3xl font-bold mb-4">Cuenta Corriente de: {terceroData.nombre}</h2>
                          <p className="text-gray-600 mb-2">CUIT: {terceroData.cuit || 'N/A'}</p>
                          <p className="text-gray-600 mb-6">ID Interno: {terceroData.id}</p>

                          <hr className="my-6"/>

                          <h3 className="text-xl font-bold mb-4">Movimientos</h3>
                          <p className="text-gray-500 text-center py-6">(Aquí irán las facturas y pagos - Próximamente)</p>

                           {/* Botones de acción futuros */}
                           <div className="mt-6 flex gap-4">
                               <button className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>+ Registrar Pago</button>
                               <button className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400" disabled>+ Cargar Factura</button>
                           </div>
                      </div>
                  )}
              </div>
          );
      };
        // --- ROUTER Y APP PRINCIPAL ---
        const AppContext = createContext();

        const App = () => {
            const { user, userData } = useAuth();
            const [route, setRoute] = useState('/');
            
            const navigate = useCallback((path) => {
                setRoute(path);
            }, []);

            useEffect(() => {
                if(user && route === '/') {
                    navigate('/dashboard');
                }
            }, [user, route, navigate]);

        const renderPage = () => {
          // Nueva lógica para la ruta de cuenta corriente (ANTES de las otras)
          if (route.startsWith('/gestion/deudores/')) {
              const terceroId = route.split('/').pop(); // Extrae el ID del final de la URL
              return <CuentaCorrienteClientePage terceroId={terceroId} />;
          }

          if (route.startsWith('/admin/manage/')) {
              const userId = route.split('/').pop();
              return userData?.isAdmin ? <AdminClientManagementPage userId={userId} /> : <div>Acceso denegado</div>;
          }

          if (route.startsWith('/gestion')) {
              if (route === '/gestion') return <GestionPage/>;
              if (route === '/gestion/terceros') return <TercerosPage/>;
              // La ruta '/gestion/deudores' simple ahora la maneja el if de arriba
              if (route === '/gestion/deudores') return <DeudoresPage/>; // Mantenemos por si acaso, pero la de arriba tiene prioridad
              if (route === '/gestion/proveedores') return <ProveedoresPage/>;
              if (route === '/gestion/cheques') return <ChequesPage/>;
          }

          switch (route) {
              case '/dashboard': return <DashboardPage />;
              case '/operations': return <OperationsPage />;
              case '/finances': return <FinancesPage />;
              case '/reports': return <ReportsPage />;
              case '/client-center': return <ClientCenterPage />;
              case '/profile': return <ProfilePage />;
              case '/admin': return <AdminPage />;
              default: return user ? <DashboardPage /> : <LoginPage />;
          }
        };

            return (
                <AppContext.Provider value={{ navigate }}>
                    <div className="App">
                        {!user ? <LoginPage /> : <AppLayout>{renderPage()}</AppLayout>}
                    </div>
                </AppContext.Provider>
            );
        };
        
        // --- INICIALIZADOR ---
        const FirebaseErrorScreen = () => (<div className="min-h-screen flex items-center justify-center bg-red-50 p-4"><div className="max-w-2xl w-full bg-white p-8 rounded-lg shadow-lg border-2 border-red-500 text-center"><h1 className="text-2xl md:text-3xl font-bold text-red-700 mb-4">Error de Configuración</h1><p className="text-gray-700 mb-2">No se pudo inicializar la aplicación. La causa más probable es que la configuración de Firebase no se ha establecido correctamente o los servicios (Authentication, Firestore) no están habilitados.</p></div></div>);
        const AppInitializer = () => {
            const [isInitialized, setIsInitialized] = useState(false);
            const [initError, setInitError] = useState(null);
            useEffect(() => {
                try {
                    if (!window.firebaseConfig || !window.firebaseConfig.apiKey || window.firebaseConfig.apiKey.startsWith("AIzaSy")) {
                        console.warn("La configuración de Firebase parece ser de ejemplo. Asegúrate de usar tus propias credenciales.");
                    }
                    app = initializeApp(window.firebaseConfig);
                    auth = getAuth(app); 
                    db = getFirestore(app); 
                    storage = getStorage(app); 
                    googleProvider = new GoogleAuthProvider();
                    setIsInitialized(true);
                } catch (error) { setInitError(error); }
            }, []);
            if (initError) return <FirebaseErrorScreen />;
            if (!isInitialized) return <div className="min-h-screen flex items-center justify-center">Cargando...</div>;
            return (
                <AuthProvider>
                    <App />
                </AuthProvider>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AppInitializer />);
        
    </script>
</body>
</html>

